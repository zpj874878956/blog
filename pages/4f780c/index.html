<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>k8s安装篇二进制 | 章工运维</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <link rel="alternate" type="application/rss+xml" href="https://blog.zzppjj.top/rss.xml" title="章工运维 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.zzppjj.top/feed.atom" title="章工运维 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.zzppjj.top/feed.json" title="章工运维 JSON Feed">
    <meta name="description" content="业精于勤，荒于嬉">
    <meta name="image" content="https://blog.zzppjj.top/images/image-20210517202456220.png">
    <meta name="twitter:title" content="k8s安装篇二进制">
    <meta name="twitter:description" content="">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://blog.zzppjj.top/images/image-20210517202456220.png">
    <meta name="twitter:url" content="https://blog.zzppjj.top/01.%E4%B8%93%E9%A2%98/02.Kubernetes%E7%AC%94%E8%AE%B0/03.k8s-%E5%AE%89%E8%A3%85%E7%AF%87-%E4%BA%8C%E8%BF%9B%E5%88%B6.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="k8s安装篇二进制">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://blog.zzppjj.top/images/image-20210517202456220.png">
    <meta property="og:url" content="https://blog.zzppjj.top/01.%E4%B8%93%E9%A2%98/02.Kubernetes%E7%AC%94%E8%AE%B0/03.k8s-%E5%AE%89%E8%A3%85%E7%AF%87-%E4%BA%8C%E8%BF%9B%E5%88%B6.html">
    <meta property="og:site_name" content="zpj">
    <meta property="article:published_time" content="2023-04-24T16:16:01.000Z">
    <meta property="article:tag" content="null">
    <meta itemprop="name" content="k8s安装篇二进制">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://blog.zzppjj.top/images/image-20210517202456220.png">
    <meta name="keywords" content="分享生活,分享技术,zpj,jenkins,ansible,k8s,监控">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.2357ed77.css" as="style"><link rel="preload" href="/assets/js/app.73676f20.js" as="script"><link rel="preload" href="/assets/js/4.23144ec8.js" as="script"><link rel="preload" href="/assets/js/1.09d67b9a.js" as="script"><link rel="preload" href="/assets/js/3.fc5194e0.js" as="script"><link rel="preload" href="/assets/js/84.1c1a3c28.js" as="script"><link rel="preload" href="/assets/js/38.33c96ce4.js" as="script"><link rel="preload" href="/assets/js/21.2c073392.js" as="script"><link rel="prefetch" href="/assets/js/10.a3e162c2.js"><link rel="prefetch" href="/assets/js/100.75d0bcb8.js"><link rel="prefetch" href="/assets/js/101.ecd83997.js"><link rel="prefetch" href="/assets/js/102.ecfd6207.js"><link rel="prefetch" href="/assets/js/103.332844d2.js"><link rel="prefetch" href="/assets/js/104.db0bde22.js"><link rel="prefetch" href="/assets/js/105.cbd4753c.js"><link rel="prefetch" href="/assets/js/106.7a5d313e.js"><link rel="prefetch" href="/assets/js/107.f3dec78b.js"><link rel="prefetch" href="/assets/js/108.52a0f936.js"><link rel="prefetch" href="/assets/js/109.27477c80.js"><link rel="prefetch" href="/assets/js/11.1f9a8151.js"><link rel="prefetch" href="/assets/js/110.bebbe66e.js"><link rel="prefetch" href="/assets/js/111.42ef7c19.js"><link rel="prefetch" href="/assets/js/112.6fe9d090.js"><link rel="prefetch" href="/assets/js/113.c9a86711.js"><link rel="prefetch" href="/assets/js/114.3503a4c3.js"><link rel="prefetch" href="/assets/js/115.14ffeec7.js"><link rel="prefetch" href="/assets/js/116.e4425551.js"><link rel="prefetch" href="/assets/js/117.bc8fd7d3.js"><link rel="prefetch" href="/assets/js/118.ca53cac0.js"><link rel="prefetch" href="/assets/js/119.b7d83b66.js"><link rel="prefetch" href="/assets/js/12.ff601b7f.js"><link rel="prefetch" href="/assets/js/120.87624e26.js"><link rel="prefetch" href="/assets/js/121.1cbece42.js"><link rel="prefetch" href="/assets/js/122.fca02497.js"><link rel="prefetch" href="/assets/js/123.20f89d6e.js"><link rel="prefetch" href="/assets/js/124.5d36a6d6.js"><link rel="prefetch" href="/assets/js/125.011309fb.js"><link rel="prefetch" href="/assets/js/126.b4637b65.js"><link rel="prefetch" href="/assets/js/127.9042b697.js"><link rel="prefetch" href="/assets/js/128.472aa291.js"><link rel="prefetch" href="/assets/js/129.c208b435.js"><link rel="prefetch" href="/assets/js/13.e19f2a21.js"><link rel="prefetch" href="/assets/js/130.de5f9c8d.js"><link rel="prefetch" href="/assets/js/131.1da85aa7.js"><link rel="prefetch" href="/assets/js/132.542a0148.js"><link rel="prefetch" href="/assets/js/133.2a6f2a0a.js"><link rel="prefetch" href="/assets/js/134.d5fa07b6.js"><link rel="prefetch" href="/assets/js/135.75648017.js"><link rel="prefetch" href="/assets/js/136.a9384568.js"><link rel="prefetch" href="/assets/js/137.f5552d23.js"><link rel="prefetch" href="/assets/js/138.eda82db2.js"><link rel="prefetch" href="/assets/js/139.be711e4c.js"><link rel="prefetch" href="/assets/js/14.a223b1b9.js"><link rel="prefetch" href="/assets/js/140.708a3fbc.js"><link rel="prefetch" href="/assets/js/141.b0b86d18.js"><link rel="prefetch" href="/assets/js/142.55bb66aa.js"><link rel="prefetch" href="/assets/js/143.2b9a4434.js"><link rel="prefetch" href="/assets/js/144.b65e75b4.js"><link rel="prefetch" href="/assets/js/145.e1c6fca8.js"><link rel="prefetch" href="/assets/js/146.d7352f00.js"><link rel="prefetch" href="/assets/js/147.e73840d8.js"><link rel="prefetch" href="/assets/js/148.e4f50f91.js"><link rel="prefetch" href="/assets/js/149.3374e168.js"><link rel="prefetch" href="/assets/js/15.403e911f.js"><link rel="prefetch" href="/assets/js/150.1b638875.js"><link rel="prefetch" href="/assets/js/151.ab5d0425.js"><link rel="prefetch" href="/assets/js/152.23993ff3.js"><link rel="prefetch" href="/assets/js/153.d1668a0e.js"><link rel="prefetch" href="/assets/js/154.4b749d4b.js"><link rel="prefetch" href="/assets/js/155.26c4c260.js"><link rel="prefetch" href="/assets/js/156.c8e6b701.js"><link rel="prefetch" href="/assets/js/157.373856e9.js"><link rel="prefetch" href="/assets/js/158.66344055.js"><link rel="prefetch" href="/assets/js/159.a69fd44e.js"><link rel="prefetch" href="/assets/js/16.6eb3aab7.js"><link rel="prefetch" href="/assets/js/160.eb9992c2.js"><link rel="prefetch" href="/assets/js/161.c5b7c124.js"><link rel="prefetch" href="/assets/js/162.c03e3856.js"><link rel="prefetch" href="/assets/js/163.72619e7f.js"><link rel="prefetch" href="/assets/js/164.5e15702b.js"><link rel="prefetch" href="/assets/js/165.33c3df23.js"><link rel="prefetch" href="/assets/js/166.4a808932.js"><link rel="prefetch" href="/assets/js/167.1a771a9e.js"><link rel="prefetch" href="/assets/js/168.807fafc8.js"><link rel="prefetch" href="/assets/js/169.44315b3f.js"><link rel="prefetch" href="/assets/js/17.bbb7c9f2.js"><link rel="prefetch" href="/assets/js/170.5c0c8eb9.js"><link rel="prefetch" href="/assets/js/171.1cbb4415.js"><link rel="prefetch" href="/assets/js/172.735a4c1a.js"><link rel="prefetch" href="/assets/js/173.86f02e67.js"><link rel="prefetch" href="/assets/js/174.4993a291.js"><link rel="prefetch" href="/assets/js/175.195bd521.js"><link rel="prefetch" href="/assets/js/176.751bd9c0.js"><link rel="prefetch" href="/assets/js/177.d1974b60.js"><link rel="prefetch" href="/assets/js/178.fc5d303d.js"><link rel="prefetch" href="/assets/js/179.9975997c.js"><link rel="prefetch" href="/assets/js/18.fca5fd29.js"><link rel="prefetch" href="/assets/js/180.f94992e7.js"><link rel="prefetch" href="/assets/js/181.340cf666.js"><link rel="prefetch" href="/assets/js/182.417bc80c.js"><link rel="prefetch" href="/assets/js/183.632e104d.js"><link rel="prefetch" href="/assets/js/184.c8ef5d1a.js"><link rel="prefetch" href="/assets/js/185.296e5bbb.js"><link rel="prefetch" href="/assets/js/186.000557d1.js"><link rel="prefetch" href="/assets/js/187.197aff5f.js"><link rel="prefetch" href="/assets/js/188.ecae5f09.js"><link rel="prefetch" href="/assets/js/189.ebfded89.js"><link rel="prefetch" href="/assets/js/19.8792dbf3.js"><link rel="prefetch" href="/assets/js/190.a710d6b1.js"><link rel="prefetch" href="/assets/js/191.a84f2ed3.js"><link rel="prefetch" href="/assets/js/192.c203907e.js"><link rel="prefetch" href="/assets/js/193.852373e5.js"><link rel="prefetch" href="/assets/js/194.db2975db.js"><link rel="prefetch" href="/assets/js/195.6c7373e8.js"><link rel="prefetch" href="/assets/js/196.45d29e92.js"><link rel="prefetch" href="/assets/js/197.ee208995.js"><link rel="prefetch" href="/assets/js/198.76c918d3.js"><link rel="prefetch" href="/assets/js/199.f05f7bdc.js"><link rel="prefetch" href="/assets/js/2.3389b8bc.js"><link rel="prefetch" href="/assets/js/20.15ba8d27.js"><link rel="prefetch" href="/assets/js/200.bf07e380.js"><link rel="prefetch" href="/assets/js/201.35bb3033.js"><link rel="prefetch" href="/assets/js/202.e14ce853.js"><link rel="prefetch" href="/assets/js/203.7f07fe7f.js"><link rel="prefetch" href="/assets/js/204.95ffddd8.js"><link rel="prefetch" href="/assets/js/205.f487b7d0.js"><link rel="prefetch" href="/assets/js/206.2b3e5a91.js"><link rel="prefetch" href="/assets/js/207.7886e90d.js"><link rel="prefetch" href="/assets/js/208.98c314e0.js"><link rel="prefetch" href="/assets/js/209.9d37ba2d.js"><link rel="prefetch" href="/assets/js/210.6e7d41e6.js"><link rel="prefetch" href="/assets/js/211.0344832b.js"><link rel="prefetch" href="/assets/js/212.8e2c9c7f.js"><link rel="prefetch" href="/assets/js/213.84efa494.js"><link rel="prefetch" href="/assets/js/214.fdcd5348.js"><link rel="prefetch" href="/assets/js/215.190febcd.js"><link rel="prefetch" href="/assets/js/216.1b0ecbf6.js"><link rel="prefetch" href="/assets/js/217.94e4a648.js"><link rel="prefetch" href="/assets/js/218.15bb6f17.js"><link rel="prefetch" href="/assets/js/219.4d86a677.js"><link rel="prefetch" href="/assets/js/22.797a9a59.js"><link rel="prefetch" href="/assets/js/220.b30cd93b.js"><link rel="prefetch" href="/assets/js/221.dc967206.js"><link rel="prefetch" href="/assets/js/222.5424cc4c.js"><link rel="prefetch" href="/assets/js/223.d35ee4d9.js"><link rel="prefetch" href="/assets/js/224.97fc8dca.js"><link rel="prefetch" href="/assets/js/225.d1d60d3d.js"><link rel="prefetch" href="/assets/js/226.71cd887d.js"><link rel="prefetch" href="/assets/js/227.7cc9c57c.js"><link rel="prefetch" href="/assets/js/228.6381caa6.js"><link rel="prefetch" href="/assets/js/229.560474e6.js"><link rel="prefetch" href="/assets/js/23.30bb92f4.js"><link rel="prefetch" href="/assets/js/230.49126632.js"><link rel="prefetch" href="/assets/js/231.591150fc.js"><link rel="prefetch" href="/assets/js/232.60ba75d5.js"><link rel="prefetch" href="/assets/js/233.0ed6ef0d.js"><link rel="prefetch" href="/assets/js/234.7d2aa21f.js"><link rel="prefetch" href="/assets/js/235.0d13696d.js"><link rel="prefetch" href="/assets/js/236.3fef4d3c.js"><link rel="prefetch" href="/assets/js/237.95e3cf9c.js"><link rel="prefetch" href="/assets/js/238.0993135b.js"><link rel="prefetch" href="/assets/js/239.27177392.js"><link rel="prefetch" href="/assets/js/24.7240c649.js"><link rel="prefetch" href="/assets/js/240.23100c38.js"><link rel="prefetch" href="/assets/js/241.805a6f9f.js"><link rel="prefetch" href="/assets/js/242.8d15a365.js"><link rel="prefetch" href="/assets/js/243.e69346ee.js"><link rel="prefetch" href="/assets/js/244.8c1aa986.js"><link rel="prefetch" href="/assets/js/245.6f55369d.js"><link rel="prefetch" href="/assets/js/246.10a3da46.js"><link rel="prefetch" href="/assets/js/247.65f2f428.js"><link rel="prefetch" href="/assets/js/248.49375e99.js"><link rel="prefetch" href="/assets/js/249.1e9d53e7.js"><link rel="prefetch" href="/assets/js/25.9b40180a.js"><link rel="prefetch" href="/assets/js/250.01f8cd00.js"><link rel="prefetch" href="/assets/js/251.ff9464cb.js"><link rel="prefetch" href="/assets/js/252.f89f8487.js"><link rel="prefetch" href="/assets/js/253.e3891186.js"><link rel="prefetch" href="/assets/js/254.9012046f.js"><link rel="prefetch" href="/assets/js/255.fde63767.js"><link rel="prefetch" href="/assets/js/256.4888bec3.js"><link rel="prefetch" href="/assets/js/257.22289df7.js"><link rel="prefetch" href="/assets/js/258.f5e12a6c.js"><link rel="prefetch" href="/assets/js/259.f227bf91.js"><link rel="prefetch" href="/assets/js/26.5fef45bc.js"><link rel="prefetch" href="/assets/js/260.7c204404.js"><link rel="prefetch" href="/assets/js/261.29e85166.js"><link rel="prefetch" href="/assets/js/262.2c9def6c.js"><link rel="prefetch" href="/assets/js/263.98afd182.js"><link rel="prefetch" href="/assets/js/264.20a44127.js"><link rel="prefetch" href="/assets/js/265.deaca7c2.js"><link rel="prefetch" href="/assets/js/266.4d0f5c1e.js"><link rel="prefetch" href="/assets/js/267.30b05762.js"><link rel="prefetch" href="/assets/js/268.2238b76d.js"><link rel="prefetch" href="/assets/js/269.9bc35400.js"><link rel="prefetch" href="/assets/js/27.83995618.js"><link rel="prefetch" href="/assets/js/270.2cf931ea.js"><link rel="prefetch" href="/assets/js/271.33bb2a38.js"><link rel="prefetch" href="/assets/js/272.5ea99ff5.js"><link rel="prefetch" href="/assets/js/273.b6aeae60.js"><link rel="prefetch" href="/assets/js/274.02c41281.js"><link rel="prefetch" href="/assets/js/275.c03bf74d.js"><link rel="prefetch" href="/assets/js/276.8bb13531.js"><link rel="prefetch" href="/assets/js/277.e835c526.js"><link rel="prefetch" href="/assets/js/278.8db0ac89.js"><link rel="prefetch" href="/assets/js/279.b01f6f0b.js"><link rel="prefetch" href="/assets/js/28.5539ac79.js"><link rel="prefetch" href="/assets/js/280.58bf36ea.js"><link rel="prefetch" href="/assets/js/281.b093e33b.js"><link rel="prefetch" href="/assets/js/282.0afb811a.js"><link rel="prefetch" href="/assets/js/283.57d16abf.js"><link rel="prefetch" href="/assets/js/284.fed63bdb.js"><link rel="prefetch" href="/assets/js/285.3e281284.js"><link rel="prefetch" href="/assets/js/286.5fd82441.js"><link rel="prefetch" href="/assets/js/287.576684d7.js"><link rel="prefetch" href="/assets/js/288.5e1ddc82.js"><link rel="prefetch" href="/assets/js/289.c9665bb4.js"><link rel="prefetch" href="/assets/js/29.b7aeafd2.js"><link rel="prefetch" href="/assets/js/290.fea19ce6.js"><link rel="prefetch" href="/assets/js/291.7d306a45.js"><link rel="prefetch" href="/assets/js/292.d16a085d.js"><link rel="prefetch" href="/assets/js/293.a2ba2f0f.js"><link rel="prefetch" href="/assets/js/294.d855cbd9.js"><link rel="prefetch" href="/assets/js/295.0100374c.js"><link rel="prefetch" href="/assets/js/296.7be2d9ee.js"><link rel="prefetch" href="/assets/js/297.a4c0465d.js"><link rel="prefetch" href="/assets/js/298.1db5d5c2.js"><link rel="prefetch" href="/assets/js/299.38d8457c.js"><link rel="prefetch" href="/assets/js/30.fc6b86f2.js"><link rel="prefetch" href="/assets/js/300.1ba015d8.js"><link rel="prefetch" href="/assets/js/301.35b2e6ba.js"><link rel="prefetch" href="/assets/js/302.429cb0ec.js"><link rel="prefetch" href="/assets/js/303.8c006780.js"><link rel="prefetch" href="/assets/js/304.ca3d5644.js"><link rel="prefetch" href="/assets/js/305.84329278.js"><link rel="prefetch" href="/assets/js/306.45b281a2.js"><link rel="prefetch" href="/assets/js/307.be05fe98.js"><link rel="prefetch" href="/assets/js/308.80655fac.js"><link rel="prefetch" href="/assets/js/309.d0bca0f4.js"><link rel="prefetch" href="/assets/js/31.4b15d755.js"><link rel="prefetch" href="/assets/js/310.9674b6bd.js"><link rel="prefetch" href="/assets/js/311.6804abea.js"><link rel="prefetch" href="/assets/js/312.ab5a2f8b.js"><link rel="prefetch" href="/assets/js/313.b2fea146.js"><link rel="prefetch" href="/assets/js/314.a4369eb5.js"><link rel="prefetch" href="/assets/js/315.b3b11ac9.js"><link rel="prefetch" href="/assets/js/316.8785a926.js"><link rel="prefetch" href="/assets/js/317.a6abd001.js"><link rel="prefetch" href="/assets/js/318.5089ee03.js"><link rel="prefetch" href="/assets/js/319.fa74b2cc.js"><link rel="prefetch" href="/assets/js/32.d80ffae2.js"><link rel="prefetch" href="/assets/js/320.a5c03bfc.js"><link rel="prefetch" href="/assets/js/321.5e4dcfe8.js"><link rel="prefetch" href="/assets/js/322.23c23832.js"><link rel="prefetch" href="/assets/js/323.4ac1fe2e.js"><link rel="prefetch" href="/assets/js/324.301c9e00.js"><link rel="prefetch" href="/assets/js/325.82fff4a0.js"><link rel="prefetch" href="/assets/js/326.d653ce14.js"><link rel="prefetch" href="/assets/js/327.9d4e295a.js"><link rel="prefetch" href="/assets/js/328.aff8c1bd.js"><link rel="prefetch" href="/assets/js/329.dce67ef0.js"><link rel="prefetch" href="/assets/js/33.0a4b28c8.js"><link rel="prefetch" href="/assets/js/330.8ee58260.js"><link rel="prefetch" href="/assets/js/331.766ca988.js"><link rel="prefetch" href="/assets/js/332.2cef316c.js"><link rel="prefetch" href="/assets/js/333.5c1e99cd.js"><link rel="prefetch" href="/assets/js/334.8ef63e12.js"><link rel="prefetch" href="/assets/js/335.2a615cdf.js"><link rel="prefetch" href="/assets/js/336.b255636f.js"><link rel="prefetch" href="/assets/js/337.aeddf147.js"><link rel="prefetch" href="/assets/js/338.cf24395e.js"><link rel="prefetch" href="/assets/js/339.ae7ee883.js"><link rel="prefetch" href="/assets/js/34.bb8cbe99.js"><link rel="prefetch" href="/assets/js/340.f5e5e10b.js"><link rel="prefetch" href="/assets/js/341.60065767.js"><link rel="prefetch" href="/assets/js/342.880f2c51.js"><link rel="prefetch" href="/assets/js/343.47928836.js"><link rel="prefetch" href="/assets/js/344.317ead2b.js"><link rel="prefetch" href="/assets/js/345.a922de9a.js"><link rel="prefetch" href="/assets/js/346.b0e6bbb0.js"><link rel="prefetch" href="/assets/js/347.23210924.js"><link rel="prefetch" href="/assets/js/348.4cbe7dfd.js"><link rel="prefetch" href="/assets/js/349.bc36d23d.js"><link rel="prefetch" href="/assets/js/35.13e5c204.js"><link rel="prefetch" href="/assets/js/350.78ff49df.js"><link rel="prefetch" href="/assets/js/351.98baa8d7.js"><link rel="prefetch" href="/assets/js/352.dafe3072.js"><link rel="prefetch" href="/assets/js/353.3a6adbb4.js"><link rel="prefetch" href="/assets/js/354.00d0f928.js"><link rel="prefetch" href="/assets/js/355.934b4c3e.js"><link rel="prefetch" href="/assets/js/356.67857703.js"><link rel="prefetch" href="/assets/js/357.8ab62a9b.js"><link rel="prefetch" href="/assets/js/358.e06b5e02.js"><link rel="prefetch" href="/assets/js/359.5ca9d976.js"><link rel="prefetch" href="/assets/js/36.3ae18163.js"><link rel="prefetch" href="/assets/js/360.38cf065b.js"><link rel="prefetch" href="/assets/js/361.84c5e0ca.js"><link rel="prefetch" href="/assets/js/362.dbf28682.js"><link rel="prefetch" href="/assets/js/363.9d7bac1a.js"><link rel="prefetch" href="/assets/js/364.6f9aaa6c.js"><link rel="prefetch" href="/assets/js/365.76e0b937.js"><link rel="prefetch" href="/assets/js/366.958065e0.js"><link rel="prefetch" href="/assets/js/367.62fe05e9.js"><link rel="prefetch" href="/assets/js/368.52e42cf5.js"><link rel="prefetch" href="/assets/js/369.be5a8e9d.js"><link rel="prefetch" href="/assets/js/37.efb2744c.js"><link rel="prefetch" href="/assets/js/370.4926d8c5.js"><link rel="prefetch" href="/assets/js/371.2aadb305.js"><link rel="prefetch" href="/assets/js/372.dcb47317.js"><link rel="prefetch" href="/assets/js/373.99d87a09.js"><link rel="prefetch" href="/assets/js/374.1d37ebf9.js"><link rel="prefetch" href="/assets/js/375.040f7228.js"><link rel="prefetch" href="/assets/js/376.4e06867e.js"><link rel="prefetch" href="/assets/js/377.27d9e275.js"><link rel="prefetch" href="/assets/js/378.8d3c34d7.js"><link rel="prefetch" href="/assets/js/379.67dba2a0.js"><link rel="prefetch" href="/assets/js/380.c1836db3.js"><link rel="prefetch" href="/assets/js/381.3497ba24.js"><link rel="prefetch" href="/assets/js/382.d041ea4d.js"><link rel="prefetch" href="/assets/js/39.031f1004.js"><link rel="prefetch" href="/assets/js/40.7376f5a0.js"><link rel="prefetch" href="/assets/js/41.d0e792da.js"><link rel="prefetch" href="/assets/js/42.246f9e60.js"><link rel="prefetch" href="/assets/js/43.95799058.js"><link rel="prefetch" href="/assets/js/44.ad27a9ff.js"><link rel="prefetch" href="/assets/js/45.0b4092a6.js"><link rel="prefetch" href="/assets/js/46.0012a2ef.js"><link rel="prefetch" href="/assets/js/47.e4b364de.js"><link rel="prefetch" href="/assets/js/48.40886536.js"><link rel="prefetch" href="/assets/js/49.cb7bc92d.js"><link rel="prefetch" href="/assets/js/5.d7fd577a.js"><link rel="prefetch" href="/assets/js/50.6c993145.js"><link rel="prefetch" href="/assets/js/51.fd053414.js"><link rel="prefetch" href="/assets/js/52.3dd8f9c6.js"><link rel="prefetch" href="/assets/js/53.81b89f42.js"><link rel="prefetch" href="/assets/js/54.a7a1880d.js"><link rel="prefetch" href="/assets/js/55.4cf210c4.js"><link rel="prefetch" href="/assets/js/56.c0ed7408.js"><link rel="prefetch" href="/assets/js/57.2a7659d5.js"><link rel="prefetch" href="/assets/js/58.c322ef28.js"><link rel="prefetch" href="/assets/js/59.4544e7b8.js"><link rel="prefetch" href="/assets/js/6.45776bb3.js"><link rel="prefetch" href="/assets/js/60.919fca3f.js"><link rel="prefetch" href="/assets/js/61.faddc5df.js"><link rel="prefetch" href="/assets/js/62.29428be6.js"><link rel="prefetch" href="/assets/js/63.f496aeee.js"><link rel="prefetch" href="/assets/js/64.d6826e8b.js"><link rel="prefetch" href="/assets/js/65.b4163fb2.js"><link rel="prefetch" href="/assets/js/66.58d152d7.js"><link rel="prefetch" href="/assets/js/67.a6dac763.js"><link rel="prefetch" href="/assets/js/68.90c252f7.js"><link rel="prefetch" href="/assets/js/69.d041ba69.js"><link rel="prefetch" href="/assets/js/7.831c92c6.js"><link rel="prefetch" href="/assets/js/70.b1b69cc5.js"><link rel="prefetch" href="/assets/js/71.b99b548a.js"><link rel="prefetch" href="/assets/js/72.b6cd4d2e.js"><link rel="prefetch" href="/assets/js/73.615eba63.js"><link rel="prefetch" href="/assets/js/74.444d9de5.js"><link rel="prefetch" href="/assets/js/75.ffd9da23.js"><link rel="prefetch" href="/assets/js/76.84d4fa46.js"><link rel="prefetch" href="/assets/js/77.eedc1376.js"><link rel="prefetch" href="/assets/js/78.7095885b.js"><link rel="prefetch" href="/assets/js/79.48c95cb9.js"><link rel="prefetch" href="/assets/js/80.8f42ea9f.js"><link rel="prefetch" href="/assets/js/81.521ca7da.js"><link rel="prefetch" href="/assets/js/82.ecb175b7.js"><link rel="prefetch" href="/assets/js/83.e121013d.js"><link rel="prefetch" href="/assets/js/85.7e914dee.js"><link rel="prefetch" href="/assets/js/86.9585ccde.js"><link rel="prefetch" href="/assets/js/87.36363a25.js"><link rel="prefetch" href="/assets/js/88.db15b19f.js"><link rel="prefetch" href="/assets/js/89.20df314c.js"><link rel="prefetch" href="/assets/js/90.8df91573.js"><link rel="prefetch" href="/assets/js/91.5a7d83c5.js"><link rel="prefetch" href="/assets/js/92.9b428b1a.js"><link rel="prefetch" href="/assets/js/93.c50f82ea.js"><link rel="prefetch" href="/assets/js/94.6813fd20.js"><link rel="prefetch" href="/assets/js/95.942ec555.js"><link rel="prefetch" href="/assets/js/96.53a215ae.js"><link rel="prefetch" href="/assets/js/97.0c2c5e6a.js"><link rel="prefetch" href="/assets/js/98.88fccd9a.js"><link rel="prefetch" href="/assets/js/99.a61ea740.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.26b542fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2357ed77.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://pic.zzppjj.top/LightPicture/2023/03/c818c3c19bf7c336.png" alt="章工运维" class="logo"> <span class="site-name can-hide">章工运维</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/ops/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/windows/" class="nav-link">windows</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">中间件</a></li><li class="dropdown-item"><!----> <a href="/monitor/" class="nav-link">监控</a></li><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/storage/" class="nav-link">存储</a></li><li class="dropdown-item"><!----> <a href="/safety/" class="nav-link">安全</a></li><li class="dropdown-item"><!----> <a href="/firewalld/" class="nav-link">防火墙</a></li><li class="dropdown-item"><!----> <a href="/db/" class="nav-link">数据库</a></li><li class="dropdown-item"><!----> <a href="/sys/" class="nav-link">系统</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">docker</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">运维工具</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">other</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/elk/" class="nav-link">elk</a></li><li class="dropdown-item"><!----> <a href="/k8s/" class="nav-link">K8S</a></li><li class="dropdown-item"><!----> <a href="/ansible/" class="nav-link">ansible</a></li><li class="dropdown-item"><!----> <a href="/jenkins/" class="nav-link">Jenkins</a></li><li class="dropdown-item"><!----> <a href="/gitlabci/" class="nav-link">GitLabCI_CD</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活" class="dropdown-title"><a href="/life/" class="link-title">生活</a> <span class="title" style="display:none;">生活</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/suibi/" class="nav-link">随笔</a></li><li class="dropdown-item"><!----> <a href="/mianshi/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/gongju/" class="nav-link">工具</a></li><li class="dropdown-item"><!----> <a href="/favorites/" class="nav-link">收藏夹</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/code/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/shell/" class="nav-link">Shell</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">python</a></li><li class="dropdown-item"><!----> <a href="/go/" class="nav-link">golang</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/nav/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>索引</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.zzppjj.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://pic.zzppjj.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  图床
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://artalk.zzppjj.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  评论
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.zzppjj.top/download/light/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  下载站点
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  开往
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zpj874878956" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="http://pic.zzppjj.top/LightPicture/2023/02/c7ac9de8fb6cfb17.jpg"> <div class="blogger-info"><h3>章工运维</h3> <span>业精于勤，荒于嬉</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/ops/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/windows/" class="nav-link">windows</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">中间件</a></li><li class="dropdown-item"><!----> <a href="/monitor/" class="nav-link">监控</a></li><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/storage/" class="nav-link">存储</a></li><li class="dropdown-item"><!----> <a href="/safety/" class="nav-link">安全</a></li><li class="dropdown-item"><!----> <a href="/firewalld/" class="nav-link">防火墙</a></li><li class="dropdown-item"><!----> <a href="/db/" class="nav-link">数据库</a></li><li class="dropdown-item"><!----> <a href="/sys/" class="nav-link">系统</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">docker</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">运维工具</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">other</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/elk/" class="nav-link">elk</a></li><li class="dropdown-item"><!----> <a href="/k8s/" class="nav-link">K8S</a></li><li class="dropdown-item"><!----> <a href="/ansible/" class="nav-link">ansible</a></li><li class="dropdown-item"><!----> <a href="/jenkins/" class="nav-link">Jenkins</a></li><li class="dropdown-item"><!----> <a href="/gitlabci/" class="nav-link">GitLabCI_CD</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活" class="dropdown-title"><a href="/life/" class="link-title">生活</a> <span class="title" style="display:none;">生活</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/suibi/" class="nav-link">随笔</a></li><li class="dropdown-item"><!----> <a href="/mianshi/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/gongju/" class="nav-link">工具</a></li><li class="dropdown-item"><!----> <a href="/favorites/" class="nav-link">收藏夹</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/code/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/shell/" class="nav-link">Shell</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">python</a></li><li class="dropdown-item"><!----> <a href="/go/" class="nav-link">golang</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/nav/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>索引</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.zzppjj.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://pic.zzppjj.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  图床
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://artalk.zzppjj.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  评论
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.zzppjj.top/download/light/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  下载站点
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  开往
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zpj874878956" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ansible系列文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/268f25/" class="sidebar-link">安装篇-kubeadm</a></li><li><a href="/pages/82114b/" class="sidebar-link">k8s入门</a></li><li><a href="/pages/4f780c/" aria-current="page" class="active sidebar-link">k8s安装篇二进制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4f780c/#二进制安装k8s-1-20" class="sidebar-link">二进制安装k8s 1.20</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#一、集群环境说明" class="sidebar-link">一、集群环境说明</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#二、基础环境配置-以下操作所有节点都得执行" class="sidebar-link">二、基础环境配置（以下操作所有节点都得执行）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_2-1、配置hosts解析" class="sidebar-link">2.1、配置hosts解析</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_2-2、更换yum源码" class="sidebar-link">2.2、更换yum源码</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_2-3、安装常用工具" class="sidebar-link">2.3、安装常用工具</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_2-4、关闭防火墙、selinux、dnsmasq、swap" class="sidebar-link">2.4、关闭防火墙、selinux、dnsmasq、swap</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_2-5、时间同步配置" class="sidebar-link">2.5、时间同步配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_2-6、优化linux" class="sidebar-link">2.6、优化Linux</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#三、内核升级" class="sidebar-link">三、内核升级</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_3-1、配置免密登录-master01上" class="sidebar-link">3.1、配置免密登录（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_3-2、下载安装所有的源码文件-master01上" class="sidebar-link">3.2、下载安装所有的源码文件：（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_3-3、下载升级所需安装包-master01上" class="sidebar-link">3.3、下载升级所需安装包（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_3-4、内核升级-所有节点" class="sidebar-link">3.4、内核升级（所有节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_3-5、安装ipvsadm-所有节点" class="sidebar-link">3.5、安装ipvsadm（所有节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_3-6、开启一些k8s集群中必须的内核参数-配置k8s内核-所有节点" class="sidebar-link">3.6、开启一些k8s集群中必须的内核参数，配置k8s内核（所有节点）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#四、docker安装" class="sidebar-link">四、Docker安装</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_4-1、安装docker-ce-19-03-所有节点" class="sidebar-link">4.1、安装Docker-ce 19.03（所有节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_4-1-1温馨提示" class="sidebar-link">4.1.1温馨提示：</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_4-1-2、所有节点设置开机自启动docker" class="sidebar-link">4.1.2、所有节点设置开机自启动Docker</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#五、k8s及etcd安装" class="sidebar-link">五、K8s及etcd安装</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-1、下载kubernetes安装包-master01上" class="sidebar-link">5.1、下载kubernetes安装包（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-2、下载etcd安装包-master01上" class="sidebar-link">5.2、下载etcd安装包（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-3、解压kubernetes-master01上" class="sidebar-link">5.3、解压kubernetes（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-4、解压etcd-master01上" class="sidebar-link">5.4、解压etcd（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-5、版本查看-master01上" class="sidebar-link">5.5、版本查看（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-6、将组件发送到其他节点-master01上" class="sidebar-link">5.6、将组件发送到其他节点（Master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-7、创建-opt-cni-bin目录-所有节点" class="sidebar-link">5.7、创建/opt/cni/bin目录（所有节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_5-8、切换分支-master01上" class="sidebar-link">5.8、切换分支（Master01上）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#六、生成证书" class="sidebar-link">六、生成证书</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_6-1、下载生成证书工具-master01" class="sidebar-link">6.1、下载生成证书工具（Master01）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_6-2、生成etcd证书" class="sidebar-link">6.2、生成etcd证书</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-2-1、创建etcd证书目录-所有master节点" class="sidebar-link">6.2.1、创建etcd证书目录（所有Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-2-1、创建kubernetes证书目录-所有节点" class="sidebar-link">6.2.1、创建kubernetes证书目录（所有节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-2-3、生成etcd证书-master01节点-将证书复制到其他节点" class="sidebar-link">6.2.3、生成etcd证书（Master01节点）将证书复制到其他节点</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-2-3、将证书复制到其他节点-master01节点" class="sidebar-link">6.2.3、将证书复制到其他节点（Master01节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_6-3、k8s组件证书" class="sidebar-link">6.3、k8s组件证书</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-3-1、生成kubernetes证书-master-01节点" class="sidebar-link">6.3.1、生成kubernetes证书（Master 01节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-3-2、生成apiserver的聚合证书-master-01节点" class="sidebar-link">6.3.2、生成apiserver的聚合证书（Master 01节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-3-3、生成controller-manage的证书-master01节点" class="sidebar-link">6.3.3、生成controller-manage的证书（Master01节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-3-4、创建serviceaccount-key-asecret" class="sidebar-link">6.3.4、创建ServiceAccount Key asecret</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-3-5、发送证书至其他节点" class="sidebar-link">6.3.5、发送证书至其他节点</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_6-3-6、查看证书文件" class="sidebar-link">6.3.6、查看证书文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#七、kubernetes系统组件配置" class="sidebar-link">七、Kubernetes系统组件配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_7-1、etcd配置-所有master节点" class="sidebar-link">7.1、Etcd配置（所有Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_7-1-1、master-01上" class="sidebar-link">7.1.1、Master 01上</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_7-1-2、master-02上" class="sidebar-link">7.1.2、Master 02上</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_7-1-3、master-03上" class="sidebar-link">7.1.3、Master 03上</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_7-2、-创建service" class="sidebar-link">7.2、 创建Service</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_7-2-1、创建etcd-service并启动-所有master节点" class="sidebar-link">7.2.1、创建etcd service并启动（所有Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_7-2-2、创建etcd的证书目录-所有master节点" class="sidebar-link">7.2.2、创建etcd的证书目录（所有Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_7-2-3、查看集群状态-任意master" class="sidebar-link">7.2.3、查看集群状态（任意master）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#八、高可用配置" class="sidebar-link">八、高可用配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_8-1、安装keepalived和haproxy-所有master节点" class="sidebar-link">8.1、安装keepalived和haproxy（所有Master节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_8-2、master配置haproxy-master节点都配置一样" class="sidebar-link">8.2、Master配置HAProxy，Master节点都配置一样</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_8-3、配置keepalived-master节点" class="sidebar-link">8.3、配置KeepAlived（Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_8-3-1、master01" class="sidebar-link">8.3.1、Master01</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_8-3-2、master02" class="sidebar-link">8.3.2、Master02</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_8-3-3、master03" class="sidebar-link">8.3.3、Master03</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_8-3-4、健康检查脚本-所有master节点" class="sidebar-link">8.3.4、健康检查脚本（所有master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_8-3-5、节点启动haproxy和keepalived-所有master节点" class="sidebar-link">8.3.5、节点启动haproxy和keepalived（所有master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_8-3-6、vip测试-master01" class="sidebar-link">8.3.6、VIP测试 （master01）</a></li><li class="sidebar-sub-header level6"><a href="/pages/4f780c/#重要-如果安装了keepalived和haproxy-需要测试keepalived是否是正常的" class="sidebar-link">重要：如果安装了keepalived和haproxy，需要测试keepalived是否是正常的</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#九、kubernetes组件配置" class="sidebar-link">九、Kubernetes组件配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_9-1、apiserver" class="sidebar-link">9.1、Apiserver</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-1-1、master01配置" class="sidebar-link">9.1.1、Master01配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-1-2、master02配置" class="sidebar-link">9.1.2、Master02配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-1-3、master03配置" class="sidebar-link">9.1.3、Master03配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-1-4、启动apiserver-所有master节点" class="sidebar-link">9.1.4、启动apiserver（所有Master节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_9-2、配置kube-controller-manager-service-所有master节点" class="sidebar-link">9.2、配置kube-controller-manager service （所有Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-2-1、三master配置文件节点相同" class="sidebar-link">9.2.1、三Master配置文件节点相同</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-2-2、启动-所有matser节点" class="sidebar-link">9.2.2、启动（所有matser节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-2-3、查看状态-所有matser节点" class="sidebar-link">9.2.3、查看状态（所有matser节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_9-3、配置kube-scheduler-service-所有master节点" class="sidebar-link">9.3、配置kube-scheduler service（所有Master节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-3-1、所有master节点配置文件相同" class="sidebar-link">9.3.1、所有master节点配置文件相同</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-3-2、启动" class="sidebar-link">9.3.2、启动</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_9-3-3、查看状态" class="sidebar-link">9.3.3、查看状态</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十、tls-bootstrapping配置" class="sidebar-link">十、TLS Bootstrapping配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_10-1、创建bootstrap-master01节点" class="sidebar-link">10.1、创建bootstrap（Master01节点）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十一、node节点配置" class="sidebar-link">十一、Node节点配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_11-1、复制证书至node节点" class="sidebar-link">11.1、复制证书至Node节点</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_11-2、kubelet配置" class="sidebar-link">11.2、Kubelet配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-2-1、创建相关目录-所有节点" class="sidebar-link">11.2.1、创建相关目录（所有节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-2-2、配置kubelet-service-所有节点" class="sidebar-link">11.2.2、配置kubelet service（所有节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-2-3、配置kubelet-service的配置文件-所有节点" class="sidebar-link">11.2.3、配置kubelet service的配置文件（所有节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-2-4、kubelet的配置文件-所有节点-启动所有节点kubelet" class="sidebar-link">11.2.4、kubelet的配置文件（所有节点）启动所有节点kubelet</a></li><li class="sidebar-sub-header level6"><a href="/pages/4f780c/#注意-如果更改了k8s的service网段-需要更改kubelet-conf-yml-的clusterdns-配置-改成k8s-service网段的第十个地址-比如10-96-0-10-k8s的service网段开始设置的是10-96-0-0-12" class="sidebar-link">注意：如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10（k8s的service网段开始设置的是10.96.0.0/12）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-2-5、启动kubelet-所有节点" class="sidebar-link">11.2.5、启动kubelet（所有节点）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-2-6、查看集群状态-matser01上" class="sidebar-link">11.2.6、查看集群状态（matser01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_11-3、kube-proxy配置" class="sidebar-link">11.3、kube-proxy配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-3-1、master01执行" class="sidebar-link">11.3.1、Master01执行</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-3-2、发送kube-proxy的systemd-service文件发送到其他节点-master01上" class="sidebar-link">11.3.2、发送kube-proxy的systemd Service文件发送到其他节点（master01上）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#分发配置文件-master01上" class="sidebar-link">分发配置文件（master01上）</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#_11-3-3、启动kube-proxy-所有节点" class="sidebar-link">11..3.3、启动kube-proxy（所有节点）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十二、安装calico" class="sidebar-link">十二、安装Calico</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_12-1、安装calico-在master01上" class="sidebar-link">12.1、安装Calico（在master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_12-2、apply" class="sidebar-link">12.2、apply</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_12-3、查看容器状态" class="sidebar-link">12.3、查看容器状态</a></li><li class="sidebar-sub-header level5"><a href="/pages/4f780c/#如果容器状态异常可以使用kubectl-describe-或者logs查看容器的日志" class="sidebar-link">如果容器状态异常可以使用kubectl describe 或者logs查看容器的日志</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十三、安装coredns" class="sidebar-link">十三、安装CoreDNS</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_13-1、安装对应版本-推荐" class="sidebar-link">13.1、安装对应版本（推荐）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_13-2、安装coredns" class="sidebar-link">13.2、安装coredns</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_13-3、安装最新版coredns-不建议" class="sidebar-link">13.3、安装最新版CoreDNS（不建议）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十四、安装metrics-server" class="sidebar-link">十四、安装Metrics Server</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_14-1、安装metrics-server" class="sidebar-link">14.1、安装metrics server</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_14-2、等待metrics-server启动然后查看状态" class="sidebar-link">14.2、等待metrics server启动然后查看状态</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十五、安装dashboard" class="sidebar-link">十五、安装dashboard</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_15-1、安装指定版本dashboard" class="sidebar-link">15.1、安装指定版本dashboard</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_15-2、安装最新版" class="sidebar-link">15.2、安装最新版</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_15-3、登录dashboard" class="sidebar-link">15.3、登录dashboard</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_15-4、查看token值" class="sidebar-link">15.4、查看token值</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十六、集群验证" class="sidebar-link">十六、集群验证</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_16-1、安装busybox-master01上" class="sidebar-link">16.1、安装busybox（master01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_16-2、验证步骤-matser01上" class="sidebar-link">16.2、验证步骤（matser01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_16-3、步骤演示-matser01上" class="sidebar-link">16.3、步骤演示（matser01上）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_16-4、使用telnet命令验证" class="sidebar-link">16.4、使用telnet命令验证</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_16-5、使用curl命令验证-所有机器" class="sidebar-link">16.5、使用curl命令验证（所有机器）</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#_16-6、容器验证-master01上" class="sidebar-link">16.6、容器验证（master01上）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十七、生产环境关键性配置" class="sidebar-link">十七、生产环境关键性配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十八、安装总结" class="sidebar-link">十八、安装总结</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f780c/#十九、bootstrapping" class="sidebar-link">十九、Bootstrapping</a></li><li class="sidebar-sub-header level4"><a href="/pages/4f780c/#bootstrapping-csr申请和证书颁发原理" class="sidebar-link">Bootstrapping CSR申请和证书颁发原理</a></li></ul></li></ul></li><li><a href="/pages/88cfe8/" class="sidebar-link">k8s面试题</a></li><li><a href="/pages/daacce/" class="sidebar-link">kubernetes（k8s）yaml文件详解</a></li><li><a href="/pages/a08cbe/" class="sidebar-link">k8s报错小结</a></li><li><a href="/pages/2b16c0/" class="sidebar-link">Kubernetes 安装配置ingress controller</a></li><li><a href="/pages/87ecd7/" class="sidebar-link">cka考试真题</a></li><li><a href="/pages/73113a/" class="sidebar-link">ingress配置证书</a></li><li><a href="/pages/e1e25d/" class="sidebar-link">cka考试作业</a></li><li><a href="/pages/985608/" class="sidebar-link">k8s部署java项目</a></li><li><a href="/pages/475fe4/" class="sidebar-link">jenkins脚本式流水线部署k8s项目实例一</a></li><li><a href="/pages/ef95e4/" class="sidebar-link">helm v3安装并创建例子</a></li><li><a href="/pages/96b910/" class="sidebar-link">使用helm将本地部署文件上传到harbor chart上</a></li><li><a href="/pages/267478/" class="sidebar-link">helm公共仓库创建</a></li><li><a href="/pages/6c04db/" class="sidebar-link">helm适应minio作为私有仓库</a></li><li><a href="/pages/bd96fe/" class="sidebar-link">helm release使用说明</a></li><li><a href="/pages/0e7c79/" class="sidebar-link">kubernetes核心概念</a></li><li><a href="/pages/2b2af6/" class="sidebar-link">kubectl使用技巧</a></li><li><a href="/pages/b081b7/" class="sidebar-link">kubernetes卷的几种类型</a></li><li><a href="/pages/16e52e/" class="sidebar-link">kubernetes安全框架</a></li><li><a href="/pages/e67bee/" class="sidebar-link">云原生-什么是HPA和PDB、VPA</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>elk</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>jenkins</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>GitLabCI_CD</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/topic/#专题" data-v-06225672>专题</a></li><li data-v-06225672><a href="/topic/#Kubernetes笔记" data-v-06225672>Kubernetes笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/zpj874878956" target="_blank" title="作者" class="beLink" data-v-06225672>章工运维</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-04-24</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">k8s安装篇二进制<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="二进制安装k8s-1-20"><a href="#二进制安装k8s-1-20" class="header-anchor">#</a> 二进制安装k8s 1.20</h2> <h3 id="一、集群环境说明"><a href="#一、集群环境说明" class="header-anchor">#</a> 一、集群环境说明</h3> <table><thead><tr><th style="text-align:center;">主机名</th> <th style="text-align:center;">IP地址</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">k8s-master01</td> <td style="text-align:center;">10.4.7.107</td> <td style="text-align:center;">master节点</td></tr> <tr><td style="text-align:center;">k8s-master02</td> <td style="text-align:center;">10.4.7.108</td> <td style="text-align:center;">master节点</td></tr> <tr><td style="text-align:center;">k8s-master03</td> <td style="text-align:center;">10.4.7.109</td> <td style="text-align:center;">master节点</td></tr> <tr><td style="text-align:center;">k8s-master-lb（在master节点）</td> <td style="text-align:center;">10.4.7.236</td> <td style="text-align:center;">keepalived虚拟IP</td></tr> <tr><td style="text-align:center;">k8s-node01</td> <td style="text-align:center;">10.4.7.110</td> <td style="text-align:center;">worker节点</td></tr> <tr><td style="text-align:center;">k8s-node02</td> <td style="text-align:center;">10.4.7.111</td> <td style="text-align:center;">worker节点</td></tr></tbody></table> <table><thead><tr><th style="text-align:center;"><strong>配置信息</strong></th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">系统版本</td> <td style="text-align:center;">CentOS 7.9</td></tr> <tr><td style="text-align:center;">Docker版本</td> <td style="text-align:center;">19.03.x</td></tr> <tr><td style="text-align:center;">Pod网段</td> <td style="text-align:center;">172.168.0.0/12</td></tr> <tr><td style="text-align:center;">Service网段</td> <td style="text-align:center;">10.96.0.0/12</td></tr></tbody></table> <p>注意：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>VIP（虚拟IP）不要和公司内网IP重复，首先去ping一下，不通才可用。VIP需要和主机在同一个局域网内！
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="二、基础环境配置-以下操作所有节点都得执行"><a href="#二、基础环境配置-以下操作所有节点都得执行" class="header-anchor">#</a> 二、基础环境配置（以下操作所有节点都得执行）</h3> <h4 id="_2-1、配置hosts解析"><a href="#_2-1、配置hosts解析" class="header-anchor">#</a> 2.1、配置hosts解析</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>hostnamectl set-hostname k8s-master01

<span class="token comment"># 查看</span>
<span class="token function">hostname</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EFO 
10.4.7.107 k8s-master01
10.4.7.108 k8s-master02
10.4.7.109 k8s-master03
10.4.7.236 k8s-master-lb
10.4.7.110 k8s-node01
10.4.7.111 k8s-node02
EFO</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>说明：10.4.7.236 k8s-master-lb # 如果不是高可用集群，该IP为Master01的IP</p> <h4 id="_2-2、更换yum源码"><a href="#_2-2、更换yum源码" class="header-anchor">#</a> 2.2、更换yum源码</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo

yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2

yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>

<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'/mirrors.cloud.aliyuncs.com/d'</span> <span class="token parameter variable">-e</span> <span class="token string">'/mirrors.aliyuncs.com/d'</span> /etc/yum.repos.d/CentOS-Base.repo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_2-3、安装常用工具"><a href="#_2-3、安装常用工具" class="header-anchor">#</a> 2.3、安装常用工具</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> lrzsz <span class="token parameter variable">-y</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_2-4、关闭防火墙、selinux、dnsmasq、swap"><a href="#_2-4、关闭防火墙、selinux、dnsmasq、swap" class="header-anchor">#</a> 2.4、关闭防火墙、selinux、dnsmasq、swap</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl disable <span class="token parameter variable">--now</span> firewalld 
systemctl disable <span class="token parameter variable">--now</span> dnsmasq
systemctl disable <span class="token parameter variable">--now</span> NetworkManager

setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config

<span class="token comment"># 关闭swap分区</span>
swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.swappiness</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_2-5、时间同步配置"><a href="#_2-5、时间同步配置" class="header-anchor">#</a> 2.5、时间同步配置</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 安装ntpdate</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
yum <span class="token function">install</span> ntpdate <span class="token parameter variable">-y</span>

<span class="token comment"># 更改时区</span>
<span class="token function">ln</span> <span class="token parameter variable">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

<span class="token comment"># 设置定时任务同步时间</span>
<span class="token builtin class-name">echo</span> <span class="token string">'Asia/Shanghai'</span> <span class="token operator">&gt;</span>/etc/timezone
ntpdate time2.aliyun.com

<span class="token comment"># 加入到crontab</span>
<span class="token function">crontab</span> <span class="token parameter variable">-e</span>
*/5 * * * * ntpdate time2.aliyun.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_2-6、优化linux"><a href="#_2-6、优化linux" class="header-anchor">#</a> 2.6、优化Linux</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>

<span class="token function">vim</span> /etc/security/limits.conf
<span class="token comment"># 末尾添加如下内容</span>
* soft nofile <span class="token number">655360</span>
* hard nofile <span class="token number">131072</span>
* soft nproc <span class="token number">655350</span>
* hard nproc <span class="token number">655350</span>
* soft memlock unlimited
* hard memlock unlimited

<span class="token comment"># 然后重启Linux</span>
<span class="token function">reboot</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>不做，2.7、所有节点升级系统并重启，此处升级没有升级内核，下节会单独升级内核：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># CentOS7需要升级，CentOS8可以按需升级系统</span>
yum update <span class="token parameter variable">-y</span> <span class="token parameter variable">--exclude</span><span class="token operator">=</span>kernel* <span class="token operator">&amp;&amp;</span> <span class="token function">reboot</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="三、内核升级"><a href="#三、内核升级" class="header-anchor">#</a> 三、内核升级</h3> <h4 id="_3-1、配置免密登录-master01上"><a href="#_3-1、配置免密登录-master01上" class="header-anchor">#</a> 3.1、配置免密登录（Master01上）</h4> <p>Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 一直回车就行</span>
ssh-keygen <span class="token parameter variable">-t</span> rsa 

<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span><span class="token keyword">do</span> ssh-copy-id <span class="token parameter variable">-i</span> .ssh/id_rsa.pub <span class="token variable">$i</span><span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_3-2、下载安装所有的源码文件-master01上"><a href="#_3-2、下载安装所有的源码文件-master01上" class="header-anchor">#</a> 3.2、下载安装所有的源码文件：（Master01上）</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /root/ <span class="token punctuation">;</span> <span class="token function">git</span> clone https://github.com/dotbalo/k8s-ha-install.git

<span class="token builtin class-name">cd</span> /root/<span class="token punctuation">;</span> <span class="token function">git</span> clone git@git.zhlh6.cn:dotbalo/k8s-ha-install.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_3-3、下载升级所需安装包-master01上"><a href="#_3-3、下载升级所需安装包-master01上" class="header-anchor">#</a> 3.3、下载升级所需安装包（Master01上）</h4> <p>CentOS7 需要升级内核至4.18+，本地升级的版本为4.19</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 在master01节点下载内核</span>
<span class="token builtin class-name">cd</span> /root
<span class="token function">wget</span> http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm
<span class="token function">wget</span> http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm
<span class="token comment"># 从master01节点传到其他节点：</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm <span class="token variable">$i</span>:/root/ <span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_3-4、内核升级-所有节点"><a href="#_3-4、内核升级-所有节点" class="header-anchor">#</a> 3.4、内核升级（所有节点）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 安装内核</span>
<span class="token builtin class-name">cd</span> /root <span class="token operator">&amp;&amp;</span> yum localinstall <span class="token parameter variable">-y</span> kernel-ml*
grub2-set-default  <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> grub2-mkconfig <span class="token parameter variable">-o</span> /etc/grub2.cfg
grubby <span class="token parameter variable">--args</span><span class="token operator">=</span><span class="token string">&quot;user_namespace.enable=1&quot;</span> --update-kernel<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>grubby --default-kernel<span class="token variable">)</span></span>&quot;</span>

<span class="token comment"># 检查默认内核是不是4.19</span>
grubby --default-kernel /boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64

<span class="token comment"># 所有节点重启，然后检查内核是不是4.19</span>
<span class="token function">reboot</span>
<span class="token punctuation">[</span>root@k8s-node02 ~<span class="token punctuation">]</span><span class="token comment"># uname -a</span>
Linux k8s-node02 <span class="token number">4.19</span>.12-1.el7.elrepo.x86_64 <span class="token comment">#1 SMP Fri Dec 21 11:06:36 EST 2018 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_3-5、安装ipvsadm-所有节点"><a href="#_3-5、安装ipvsadm-所有节点" class="header-anchor">#</a> 3.5、安装ipvsadm（所有节点）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class="token parameter variable">-y</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 加入以下内容</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/modules-load.d/ipvs.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EFO
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EFO</span>

<span class="token comment"># 然后执行</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> systemd-modules-load.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="_3-6、开启一些k8s集群中必须的内核参数-配置k8s内核-所有节点"><a href="#_3-6、开启一些k8s集群中必须的内核参数-配置k8s内核-所有节点" class="header-anchor">#</a> 3.6、开启一些k8s集群中必须的内核参数，配置k8s内核（所有节点）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF</span>

<span class="token comment"># 所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</span>
<span class="token function">reboot</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span>
ip_vs_ftp              <span class="token number">16384</span>  <span class="token number">0</span> 
nf_nat                 <span class="token number">32768</span>  <span class="token number">1</span> ip_vs_ftp
ip_vs_sed              <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_nq               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_fo               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_sh               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_dh               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_lblcr            <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_lblc             <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_wrr              <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_rr               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_wlc              <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_lc               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs                 <span class="token number">151552</span>  <span class="token number">24</span> ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp
nf_conntrack          <span class="token number">143360</span>  <span class="token number">2</span> nf_nat,ip_vs
nf_defrag_ipv6         <span class="token number">20480</span>  <span class="token number">1</span> nf_conntrack
nf_defrag_ipv4         <span class="token number">16384</span>  <span class="token number">1</span> nf_conntrack
libcrc32c              <span class="token number">16384</span>  <span class="token number">4</span> nf_conntrack,nf_nat,xfs,ip_vs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="四、docker安装"><a href="#四、docker安装" class="header-anchor">#</a> 四、Docker安装</h3> <h4 id="_4-1、安装docker-ce-19-03-所有节点"><a href="#_4-1、安装docker-ce-19-03-所有节点" class="header-anchor">#</a> 4.1、安装Docker-ce 19.03（所有节点）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> docker-ce-19.03.* <span class="token parameter variable">-y</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_4-1-1温馨提示"><a href="#_4-1-1温馨提示" class="header-anchor">#</a> 4.1.1温馨提示：</h5> <p>由于新版kubelet建议使用systemd，所以可以把docker的CgroupDriver改成systemd</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> /etc/docker

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
}
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="_4-1-2、所有节点设置开机自启动docker"><a href="#_4-1-2、所有节点设置开机自启动docker" class="header-anchor">#</a> 4.1.2、所有节点设置开机自启动Docker</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> <span class="token function">docker</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="五、k8s及etcd安装"><a href="#五、k8s及etcd安装" class="header-anchor">#</a> 五、K8s及etcd安装</h3> <h4 id="_5-1、下载kubernetes安装包-master01上"><a href="#_5-1、下载kubernetes安装包-master01上" class="header-anchor">#</a> 5.1、下载kubernetes安装包（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 注意目前版本是1.20.0，你们安装时需要下载最新的1.20.x版本：</span>
<span class="token comment"># https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://dl.k8s.io/v1.20.0/kubernetes-server-linux-amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_5-2、下载etcd安装包-master01上"><a href="#_5-2、下载etcd安装包-master01上" class="header-anchor">#</a> 5.2、下载etcd安装包（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_5-3、解压kubernetes-master01上"><a href="#_5-3、解压kubernetes-master01上" class="header-anchor">#</a> 5.3、解压kubernetes（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> <span class="token parameter variable">-xf</span> kubernetes-server-linux-amd64.tar.gz  --strip-components<span class="token operator">=</span><span class="token number">3</span> <span class="token parameter variable">-C</span> /usr/local/bin kubernetes/server/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_5-4、解压etcd-master01上"><a href="#_5-4、解压etcd-master01上" class="header-anchor">#</a> 5.4、解压etcd（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> etcd-v3.4.13-linux-amd64.tar.gz --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-C</span> /usr/local/bin etcd-v3.4.13-linux-amd64/etcd<span class="token punctuation">{</span>,ctl<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_5-5、版本查看-master01上"><a href="#_5-5、版本查看-master01上" class="header-anchor">#</a> 5.5、版本查看（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubelet --version</span>
Kubernetes v1.20.0
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># etcdctl version</span>
etcdctl version: <span class="token number">3.4</span>.13
API version: <span class="token number">3.4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_5-6、将组件发送到其他节点-master01上"><a href="#_5-6、将组件发送到其他节点-master01上" class="header-anchor">#</a> 5.6、将组件发送到其他节点（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># MasterNodes='k8s-master02 k8s-master03'</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># WorkNodes='k8s-node01 k8s-node02'</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># for NODE in $MasterNodes; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># for NODE in $WorkNodes; do     scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_5-7、创建-opt-cni-bin目录-所有节点"><a href="#_5-7、创建-opt-cni-bin目录-所有节点" class="header-anchor">#</a> 5.7、创建/opt/cni/bin目录（所有节点）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/cni/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_5-8、切换分支-master01上"><a href="#_5-8、切换分支-master01上" class="header-anchor">#</a> 5.8、切换分支（Master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 切换到1.20.x分支（其他版本可以切换到其他分支）</span>
<span class="token comment"># 查看所有分支</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd k8s-ha-install/</span>
<span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># git branch -a</span>
* master
  remotes/origin/HEAD -<span class="token operator">&gt;</span> origin/master
  remotes/origin/manual-installation
  remotes/origin/manual-installation-v1.16.x
  remotes/origin/manual-installation-v1.17.x
  remotes/origin/manual-installation-v1.18.x
  remotes/origin/manual-installation-v1.19.x
  remotes/origin/manual-installation-v1.20.x
  remotes/origin/master

<span class="token comment"># 切换分之</span>
<span class="token function">git</span> checkout manual-installation-v1.20.x

<span class="token comment"># 生成证书所需文件，如下所示</span>
<span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># ls</span>
bootstrap  calico  CoreDNS  dashboard  kube-proxy  metrics-server-0.4.x  metrics-server-0.4.x-kubeadm  pki  snapshotter
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="六、生成证书"><a href="#六、生成证书" class="header-anchor">#</a> 六、生成证书</h3> <p>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</p> <h4 id="_6-1、下载生成证书工具-master01"><a href="#_6-1、下载生成证书工具-master01" class="header-anchor">#</a> 6.1、下载生成证书工具（Master01）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> <span class="token string">&quot;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&quot;</span> <span class="token parameter variable">-O</span> /usr/local/bin/cfssl
<span class="token function">wget</span> <span class="token string">&quot;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&quot;</span> <span class="token parameter variable">-O</span> /usr/local/bin/cfssljson

<span class="token builtin class-name">cd</span> /root
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># mv cfssl_linux-amd64 /usr/local/bin/cfssl</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># mv cfssljson_linux-amd64  /usr/local/bin/cfssljson</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_6-2、生成etcd证书"><a href="#_6-2、生成etcd证书" class="header-anchor">#</a> 6.2、生成etcd证书</h4> <h5 id="_6-2-1、创建etcd证书目录-所有master节点"><a href="#_6-2-1、创建etcd证书目录-所有master节点" class="header-anchor">#</a> 6.2.1、创建etcd证书目录（所有Master节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> /etc/etcd/ssl <span class="token parameter variable">-p</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_6-2-1、创建kubernetes证书目录-所有节点"><a href="#_6-2-1、创建kubernetes证书目录-所有节点" class="header-anchor">#</a> 6.2.1、创建kubernetes证书目录（所有节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_6-2-3、生成etcd证书-master01节点-将证书复制到其他节点"><a href="#_6-2-3、生成etcd证书-master01节点-将证书复制到其他节点" class="header-anchor">#</a> 6.2.3、生成etcd证书（Master01节点）将证书复制到其他节点</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/pki</span>

<span class="token comment"># 生成etcd CA证书和CA证书的key</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span>
<span class="token number">2020</span>/12/21 01:58:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2020</span>/12/21 01:58:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 01:58:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 01:58:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 01:58:03 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 01:58:03 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">140198241947074029848239512164671290627608591138</span>

<span class="token comment"># 可以在-hostname 参数后面预留几个ip，方便日后扩容</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert \</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,10.4.7.107,10.4.7.108,10.4.7.109 <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   etcd-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd

<span class="token comment"># 执行结果</span>
<span class="token number">2020</span>/12/21 02:00:04 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:00:04 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:00:04 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:00:05 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:00:05 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">470467884878418179395781489624244078991295464856</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h5 id="_6-2-3、将证书复制到其他节点-master01节点"><a href="#_6-2-3、将证书复制到其他节点-master01节点" class="header-anchor">#</a> 6.2.3、将证书复制到其他节点（Master01节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">'k8s-node01 k8s-node02'</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token string">&quot;mkdir -p /etc/etcd/ssl&quot;</span>
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/<span class="token variable">${FILE}</span>
     <span class="token keyword">done</span>
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_6-3、k8s组件证书"><a href="#_6-3、k8s组件证书" class="header-anchor">#</a> 6.3、k8s组件证书</h4> <h5 id="_6-3-1、生成kubernetes证书-master-01节点"><a href="#_6-3-1、生成kubernetes证书-master-01节点" class="header-anchor">#</a> 6.3.1、生成kubernetes证书（Master 01节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/pki</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span>
<span class="token comment"># 执行结果</span>
<span class="token number">2020</span>/12/21 02:05:33 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2020</span>/12/21 02:05:33 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:05:33 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:05:33 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:05:34 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:05:34 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">41601140313910114593243737048758611445671732018</span>

<span class="token comment"># 10.96.0.1是k8s service的网段，如果说需要更改k8s service网段，那就需要更改10.96.0.1，</span>
<span class="token comment"># 如果不是高可用集群，10.4.7.236为Master01的IP</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert   -ca=/etc/kubernetes/pki/ca.pem   -ca-key=/etc/kubernetes/pki/ca-key.pem   -config=ca-config.json -hostname=10.96.0.1,10.4.7.236,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,10.4.7.107,10.4.7.108,10.4.7.109   -profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span>

<span class="token comment"># 执行结果</span>
<span class="token number">2020</span>/12/21 02:07:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:07:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:07:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:07:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:07:26 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">538625498609814572541825087295197801303230523180</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="_6-3-2、生成apiserver的聚合证书-master-01节点"><a href="#_6-3-2、生成apiserver的聚合证书-master-01节点" class="header-anchor">#</a> 6.3.2、生成apiserver的聚合证书（Master 01节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca</span>
<span class="token comment"># 执行结果</span>
<span class="token number">2020</span>/12/21 02:08:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2020</span>/12/21 02:08:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:08:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:08:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:08:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:08:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">614553480240998616305316696839282255811191572397</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span>

<span class="token comment"># 返回结果（忽略警告）</span>
<span class="token number">2020</span>/12/21 02:09:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:09:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:09:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:09:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:09:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">525521597243375822253206665544676632452020336672</span>
<span class="token number">2020</span>/12/21 02:09:23 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="_6-3-3、生成controller-manage的证书-master01节点"><a href="#_6-3-3、生成controller-manage的证书-master01节点" class="header-anchor">#</a> 6.3.3、生成controller-manage的证书（Master01节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cfssl gencert \</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   manager-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/controller-manager
<span class="token comment"># 执行结果</span>
<span class="token number">2020</span>/12/21 02:10:59 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:10:59 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:10:59 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:10:59 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:10:59 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">90004917734039884153079426464391358123145661914</span>
<span class="token number">2020</span>/12/21 02:10:59 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.


<span class="token comment"># 注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
<span class="token comment"># set-cluster：设置一个集群项,10.4.7.236是VIP</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://10.4.7.236:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 执行结果</span>
Cluster <span class="token string">&quot;kubernetes&quot;</span> set.


<span class="token comment"># 设置一个环境项，一个上下文</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context system:kube-controller-manager@kubernetes \</span>
    <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-controller-manager <span class="token punctuation">\</span>
    <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig 
<span class="token comment"># 执行结果</span>
Context <span class="token string">&quot;system:kube-controller-manager@kubernetes&quot;</span> created.


<span class="token comment"># set-credentials 设置一个用户项</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials system:kube-controller-manager \</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 执行结果</span>
User <span class="token string">&quot;system:kube-controller-manager&quot;</span> set.


<span class="token comment"># 使用某个环境当做默认环境</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context system:kube-controller-manager@kubernetes \</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 执行结果</span>
Switched to context <span class="token string">&quot;system:kube-controller-manager@kubernetes&quot;</span><span class="token builtin class-name">.</span>

<span class="token comment"># 生成scheduler证书</span>
cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   scheduler-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/scheduler
<span class="token comment"># 执行结果</span>
<span class="token number">2020</span>/12/21 02:16:12 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/12/21 02:16:12 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/12/21 02:16:12 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/12/21 02:16:12 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/12/21 02:16:12 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">74188665800103042050582037108256409976332653077</span>
<span class="token number">2020</span>/12/21 02:16:12 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.


<span class="token comment"># 注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://10.4.7.236:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/scheduler.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/admin

<span class="token comment"># 注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://10.4.7.236:8443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config set-credentials kubernetes-admin     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config set-context kubernetes-admin@kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes-admin     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config use-context kubernetes-admin@kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><h5 id="_6-3-4、创建serviceaccount-key-asecret"><a href="#_6-3-4、创建serviceaccount-key-asecret" class="header-anchor">#</a> 6.3.4、创建ServiceAccount Key asecret</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span>
<span class="token comment"># 执行结果</span>
Generating RSA private key, <span class="token number">2048</span> bit long modulus
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span>
<span class="token comment"># 执行结果</span>
writing RSA key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="_6-3-5、发送证书至其他节点"><a href="#_6-3-5、发送证书至其他节点" class="header-anchor">#</a> 6.3.5、发送证书至其他节点</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /etc/kubernetes/pki <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> etcd<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token function">scp</span> /etc/kubernetes/pki/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/pki/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>
<span class="token keyword">done</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token function">scp</span> /etc/kubernetes/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>
<span class="token keyword">done</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="_6-3-6、查看证书文件"><a href="#_6-3-6、查看证书文件" class="header-anchor">#</a> 6.3.6、查看证书文件</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># ls /etc/kubernetes/pki/</span>
admin.csr      apiserver.csr      ca.csr      controller-manager.csr      front-proxy-ca.csr      front-proxy-client.csr      sa.key         scheduler-key.pem
admin-key.pem  apiserver-key.pem  ca-key.pem  controller-manager-key.pem  front-proxy-ca-key.pem  front-proxy-client-key.pem  sa.pub         scheduler.pem
admin.pem      apiserver.pem      ca.pem      controller-manager.pem      front-proxy-ca.pem      front-proxy-client.pem      scheduler.csr

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># ls /etc/kubernetes/pki/ |wc -l</span>
<span class="token number">23</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="七、kubernetes系统组件配置"><a href="#七、kubernetes系统组件配置" class="header-anchor">#</a> 七、Kubernetes系统组件配置</h3> <h4 id="_7-1、etcd配置-所有master节点"><a href="#_7-1、etcd配置-所有master节点" class="header-anchor">#</a> 7.1、Etcd配置（所有Master节点）</h4> <p>etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</p> <h5 id="_7-1-1、master-01上"><a href="#_7-1-1、master-01上" class="header-anchor">#</a> 7.1.1、Master 01上</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/etcd/etcd.config.yml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>name: <span class="token string">'k8s-master01'</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: <span class="token number">5000</span>
heartbeat-interval: <span class="token number">100</span>
election-timeout: <span class="token number">1000</span>
quota-backend-bytes: <span class="token number">0</span>
listen-peer-urls: <span class="token string">'https://10.4.7.107:2380'</span>
listen-client-urls: <span class="token string">'https://10.4.7.107:2379,http://127.0.0.1:2379'</span>
max-snapshots: <span class="token number">3</span>
max-wals: <span class="token number">5</span>
cors:
initial-advertise-peer-urls: <span class="token string">'https://10.4.7.107:2380'</span>
advertise-client-urls: <span class="token string">'https://10.4.7.107:2379'</span>
discovery:
discovery-fallback: <span class="token string">'proxy'</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="token string">'k8s-master01=https://10.4.7.107:2380,k8s-master02=https://10.4.7.108:2380,k8s-master03=https://10.4.7.109:2380'</span>
initial-cluster-token: <span class="token string">'etcd-k8s-cluster'</span>
initial-cluster-state: <span class="token string">'new'</span>
strict-reconfig-check: <span class="token boolean">false</span>
enable-v2: <span class="token boolean">true</span>
enable-pprof: <span class="token boolean">true</span>
proxy: <span class="token string">'off'</span>
proxy-failure-wait: <span class="token number">5000</span>
proxy-refresh-interval: <span class="token number">30000</span>
proxy-dial-timeout: <span class="token number">1000</span>
proxy-write-timeout: <span class="token number">5000</span>
proxy-read-timeout: <span class="token number">0</span>
client-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
peer-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  peer-client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
debug: <span class="token boolean">false</span>
log-package-levels:
log-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
force-new-cluster: <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h5 id="_7-1-2、master-02上"><a href="#_7-1-2、master-02上" class="header-anchor">#</a> 7.1.2、Master 02上</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master02 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/etcd/etcd.config.yml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>name: <span class="token string">'k8s-master02'</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: <span class="token number">5000</span>
heartbeat-interval: <span class="token number">100</span>
election-timeout: <span class="token number">1000</span>
quota-backend-bytes: <span class="token number">0</span>
listen-peer-urls: <span class="token string">'https://10.4.7.108:2380'</span>
listen-client-urls: <span class="token string">'https://10.4.7.108:2379,http://127.0.0.1:2379'</span>
max-snapshots: <span class="token number">3</span>
max-wals: <span class="token number">5</span>
cors:
initial-advertise-peer-urls: <span class="token string">'https://10.4.7.108:2380'</span>
advertise-client-urls: <span class="token string">'https://10.4.7.108:2379'</span>
discovery:
discovery-fallback: <span class="token string">'proxy'</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="token string">'k8s-master01=https://10.4.7.107:2380,k8s-master02=https://10.4.7.108:2380,k8s-master03=https://10.4.7.109:2380'</span>
initial-cluster-token: <span class="token string">'etcd-k8s-cluster'</span>
initial-cluster-state: <span class="token string">'new'</span>
strict-reconfig-check: <span class="token boolean">false</span>
enable-v2: <span class="token boolean">true</span>
enable-pprof: <span class="token boolean">true</span>
proxy: <span class="token string">'off'</span>
proxy-failure-wait: <span class="token number">5000</span>
proxy-refresh-interval: <span class="token number">30000</span>
proxy-dial-timeout: <span class="token number">1000</span>
proxy-write-timeout: <span class="token number">5000</span>
proxy-read-timeout: <span class="token number">0</span>
client-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
peer-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  peer-client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
debug: <span class="token boolean">false</span>
log-package-levels:
log-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
force-new-cluster: <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h5 id="_7-1-3、master-03上"><a href="#_7-1-3、master-03上" class="header-anchor">#</a> 7.1.3、Master 03上</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master03 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/etcd/etcd.config.yml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>name: <span class="token string">'k8s-master03'</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: <span class="token number">5000</span>
heartbeat-interval: <span class="token number">100</span>
election-timeout: <span class="token number">1000</span>
quota-backend-bytes: <span class="token number">0</span>
listen-peer-urls: <span class="token string">'https://10.4.7.109:2380'</span>
listen-client-urls: <span class="token string">'https://10.4.7.109:2379,http://127.0.0.1:2379'</span>
max-snapshots: <span class="token number">3</span>
max-wals: <span class="token number">5</span>
cors:
initial-advertise-peer-urls: <span class="token string">'https://10.4.7.109:2380'</span>
advertise-client-urls: <span class="token string">'https://10.4.7.109:2379'</span>
discovery:
discovery-fallback: <span class="token string">'proxy'</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="token string">'k8s-master01=https://10.4.7.107:2380,k8s-master02=https://10.4.7.108:2380,k8s-master03=https://10.4.7.109:2380'</span>
initial-cluster-token: <span class="token string">'etcd-k8s-cluster'</span>
initial-cluster-state: <span class="token string">'new'</span>
strict-reconfig-check: <span class="token boolean">false</span>
enable-v2: <span class="token boolean">true</span>
enable-pprof: <span class="token boolean">true</span>
proxy: <span class="token string">'off'</span>
proxy-failure-wait: <span class="token number">5000</span>
proxy-refresh-interval: <span class="token number">30000</span>
proxy-dial-timeout: <span class="token number">1000</span>
proxy-write-timeout: <span class="token number">5000</span>
proxy-read-timeout: <span class="token number">0</span>
client-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
peer-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  peer-client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
debug: <span class="token boolean">false</span>
log-package-levels:
log-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
force-new-cluster: <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h4 id="_7-2、-创建service"><a href="#_7-2、-创建service" class="header-anchor">#</a> 7.2、 创建Service</h4> <h5 id="_7-2-1、创建etcd-service并启动-所有master节点"><a href="#_7-2-1、创建etcd-service并启动-所有master节点" class="header-anchor">#</a> 7.2.1、创建etcd service并启动（所有Master节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/etcd.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd Service
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://coreos.com/etcd/docs/latest/
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/etcd --config-file<span class="token operator">=</span>/etc/etcd/etcd.config.yml
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
<span class="token assign-left variable">Alias</span><span class="token operator">=</span>etcd3.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="_7-2-2、创建etcd的证书目录-所有master节点"><a href="#_7-2-2、创建etcd的证书目录-所有master节点" class="header-anchor">#</a> 7.2.2、创建etcd的证书目录（所有Master节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#所有</span>
<span class="token function">mkdir</span> /etc/kubernetes/pki/etcd
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_7-2-3、查看集群状态-任意master"><a href="#_7-2-3、查看集群状态-任意master" class="header-anchor">#</a> 7.2.3、查看集群状态（任意master）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master03 ~<span class="token punctuation">]</span><span class="token comment"># export ETCDCTL_API=3</span>
<span class="token punctuation">[</span>root@k8s-master03 ~<span class="token punctuation">]</span><span class="token comment"># etcdctl --endpoints=&quot;10.4.7.109:2379,10.4.7.108:2379,10.4.7.107:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span>
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<span class="token operator">|</span>      ENDPOINT      <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span> RAFT APPLIED INDEX <span class="token operator">|</span> ERRORS <span class="token operator">|</span>
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<span class="token operator">|</span> <span class="token number">10.4</span>.7.109:2379 <span class="token operator">|</span> a77e5ca7bd4dc035 <span class="token operator">|</span>  <span class="token number">3.4</span>.13 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>       <span class="token number">465</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10.4</span>.7.108:2379 <span class="token operator">|</span> e3adc675ac3b3dbd <span class="token operator">|</span>  <span class="token number">3.4</span>.13 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>       <span class="token number">465</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10.4</span>.7.107:2379 <span class="token operator">|</span> 47a087175e3f17b3 <span class="token operator">|</span>  <span class="token number">3.4</span>.13 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>       <span class="token number">465</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="八、高可用配置"><a href="#八、高可用配置" class="header-anchor">#</a> 八、高可用配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>高可用配置（注意：如果不是高可用集群，haproxy和keepalived无需安装）
如果在云上安装也无需执行此章节的步骤，可以直接使用云上的lb，比如阿里云slb，腾讯云elb等
Slb -<span class="token operator">&gt;</span> haproxy -<span class="token operator">&gt;</span> apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_8-1、安装keepalived和haproxy-所有master节点"><a href="#_8-1、安装keepalived和haproxy-所有master节点" class="header-anchor">#</a> 8.1、安装keepalived和haproxy（所有Master节点）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> keepalived haproxy <span class="token parameter variable">-y</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_8-2、master配置haproxy-master节点都配置一样"><a href="#_8-2、master配置haproxy-master节点都配置一样" class="header-anchor">#</a> 8.2、Master配置HAProxy，Master节点都配置一样</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/haproxy/haproxy.cfg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code> global
  maxconn  <span class="token number">2000</span>
  ulimit-n  <span class="token number">16384</span>
  log  <span class="token number">127.0</span>.0.1 local0 err
  stats <span class="token function">timeout</span> 30s

defaults
  log global
  mode  http
  option  httplog
  <span class="token function">timeout</span> connect <span class="token number">5000</span>
  <span class="token function">timeout</span> client  <span class="token number">50000</span>
  <span class="token function">timeout</span> server  <span class="token number">50000</span>
  <span class="token function">timeout</span> http-request 15s
  <span class="token function">timeout</span> http-keep-alive 15s

frontend k8s-master
  <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:8443
  <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1:8443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise <span class="token number">2</span> fall <span class="token number">2</span> slowstart 60s maxconn <span class="token number">250</span> maxqueue <span class="token number">256</span> weight <span class="token number">100</span>
  server k8s-master01    <span class="token number">10.4</span>.7.107:6443  check
  server k8s-master02    <span class="token number">10.4</span>.7.108:6443  check
  server k8s-master03    <span class="token number">10.4</span>.7.109:6443  check
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="_8-3、配置keepalived-master节点"><a href="#_8-3、配置keepalived-master节点" class="header-anchor">#</a> 8.3、配置KeepAlived（Master节点）</h4> <p><strong>注意每个节点的IP和网卡（interface参数）</strong></p> <h5 id="_8-3-1、master01"><a href="#_8-3-1、master01" class="header-anchor">#</a> 8.3.1、Master01</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
global_defs <span class="token punctuation">{</span>
    router_id LVS_DEVEL
<span class="token punctuation">}</span>
vrrp_script chk_apiserver <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
    interval <span class="token number">5</span> 
    weight <span class="token parameter variable">-5</span>
    fall <span class="token number">2</span>
    rise <span class="token number">1</span>
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
    state MASTER
    interface ens33
    mcast_src_ip <span class="token number">10.4</span>.7.107
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">101</span>
    nopreempt
    advert_int <span class="token number">2</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">10.4</span>.7.236
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
      chk_apiserver 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h5 id="_8-3-2、master02"><a href="#_8-3-2、master02" class="header-anchor">#</a> 8.3.2、Master02</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
global_defs <span class="token punctuation">{</span>
    router_id LVS_DEVEL
<span class="token punctuation">}</span>
vrrp_script chk_apiserver <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
    interval <span class="token number">5</span> 
    weight <span class="token parameter variable">-5</span>
    fall <span class="token number">2</span>
    rise <span class="token number">1</span>

<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP
    interface ens33
    mcast_src_ip <span class="token number">10.4</span>.7.108
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">100</span>
    nopreempt
    advert_int <span class="token number">2</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">10.4</span>.7.236
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
      chk_apiserver 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h5 id="_8-3-3、master03"><a href="#_8-3-3、master03" class="header-anchor">#</a> 8.3.3、Master03</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
global_defs <span class="token punctuation">{</span>
    router_id LVS_DEVEL
<span class="token punctuation">}</span>
vrrp_script chk_apiserver <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
    interval <span class="token number">5</span>
    weight <span class="token parameter variable">-5</span>
    fall <span class="token number">2</span>  
    rise <span class="token number">1</span>
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP
    interface ens33
    mcast_src_ip <span class="token number">10.4</span>.7.109
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">100</span>
    nopreempt
    advert_int <span class="token number">2</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">10.4</span>.7.236
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
      chk_apiserver 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h5 id="_8-3-4、健康检查脚本-所有master节点"><a href="#_8-3-4、健康检查脚本-所有master节点" class="header-anchor">#</a> 8.3.4、健康检查脚本（所有master节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/check_apiserver.sh  <span class="token operator">&lt;&lt;</span> <span class="token string">EFO
#!/bin/bash

err=0
for k in <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">3</span><span class="token variable">)</span></span>
do
    check_code=<span class="token variable"><span class="token variable">$(</span>pgrep haproxy<span class="token variable">)</span></span>
    if [[ <span class="token variable">$check_code</span> == &quot;&quot; ]]; then
        err=<span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> $err + <span class="token number">1</span><span class="token variable">)</span></span>
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ <span class="token variable">$err</span> != &quot;0&quot; ]]; then
    echo &quot;systemctl stop keepalived&quot;
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EFO</span>

<span class="token comment"># 授权</span>
<span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h5 id="_8-3-5、节点启动haproxy和keepalived-所有master节点"><a href="#_8-3-5、节点启动haproxy和keepalived-所有master节点" class="header-anchor">#</a> 8.3.5、节点启动haproxy和keepalived（所有master节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="_8-3-6、vip测试-master01"><a href="#_8-3-6、vip测试-master01" class="header-anchor">#</a> 8.3.6、VIP测试 （master01）</h5> <h6 id="重要-如果安装了keepalived和haproxy-需要测试keepalived是否是正常的"><a href="#重要-如果安装了keepalived和haproxy-需要测试keepalived是否是正常的" class="header-anchor">#</a> 重要：如果安装了keepalived和haproxy，需要测试keepalived是否是正常的</h6> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 看到有VIP绑定到ens33网卡上了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ip a | grep ens33</span>
<span class="token number">2</span>: ens33: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    inet <span class="token number">10.4</span>.7.107/24 brd <span class="token number">192.168</span>.1.255 scope global ens33
    inet <span class="token number">10.4</span>.7.236/32 scope global ens33

<span class="token comment"># 任意节点，检查haproxy</span>
telnet <span class="token number">10.4</span>.7.236 <span class="token number">8443</span>

如果ping不通且telnet没有出现 <span class="token string">&quot;]&quot;</span>，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等
所有节点查看防火墙状态必须为disable和inactive：systemctl status firewalld
所有节点查看selinux状态，必须为disable：getenforce
master节点查看haproxy和keepalived状态：systemctl status keepalived haproxy
master节点查看监听端口：netstat <span class="token parameter variable">-lntp</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="九、kubernetes组件配置"><a href="#九、kubernetes组件配置" class="header-anchor">#</a> 九、Kubernetes组件配置</h3> <h4 id="_9-1、apiserver"><a href="#_9-1、apiserver" class="header-anchor">#</a> 9.1、Apiserver</h4> <p>所有Master节点创建kube-apiserver service，# 注意，如果不是高可用集群，10.4.7.236改为master01的地址</p> <p>注意本文档使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改</p> <h5 id="_9-1-1、master01配置"><a href="#_9-1-1、master01配置" class="header-anchor">#</a> 9.1.1、Master01配置</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-apiserver.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\</span>
      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\</span>
      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\</span>
      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\</span>
      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\</span>
      --advertise-address<span class="token operator">=</span><span class="token number">10.4</span>.7.107 <span class="token punctuation">\</span>
      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\</span>
      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\</span>
      --etcd-servers<span class="token operator">=</span>https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379 <span class="token punctuation">\</span>
      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\</span>
      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\</span>
      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\</span>
      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\</span>
      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\</span>
      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\</span>
      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\</span>
      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\</span>
      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\</span>
      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\</span>
      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\</span>
      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\</span>
      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\</span>
      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\</span>
      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\</span>
      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\</span>
      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h5 id="_9-1-2、master02配置"><a href="#_9-1-2、master02配置" class="header-anchor">#</a> 9.1.2、Master02配置</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-apiserver.service 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\</span>
      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\</span>
      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\</span>
      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\</span>
      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\</span>
      --advertise-address<span class="token operator">=</span><span class="token number">10.4</span>.7.108 <span class="token punctuation">\</span>
      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\</span>
      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\</span>
      --etcd-servers<span class="token operator">=</span>https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379 <span class="token punctuation">\</span>
      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\</span>
      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\</span>
      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\</span>
      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\</span>
      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\</span>
      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\</span>
      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\</span>
      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\</span>
      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\</span>
      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\</span>
      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\</span>
      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\</span>
      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\</span>
      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\</span>
      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\</span>
      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\</span>
      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h5 id="_9-1-3、master03配置"><a href="#_9-1-3、master03配置" class="header-anchor">#</a> 9.1.3、Master03配置</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-apiserver.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\</span>
      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\</span>
      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\</span>
      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\</span>
      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\</span>
      --advertise-address<span class="token operator">=</span><span class="token number">10.4</span>.7.109 <span class="token punctuation">\</span>
      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\</span>
      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\</span>
      --etcd-servers<span class="token operator">=</span>https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379 <span class="token punctuation">\</span>
      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\</span>
      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\</span>
      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\</span>
      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\</span>
      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\</span>
      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\</span>
      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\</span>
      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\</span>
      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\</span>
      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\</span>
      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\</span>
      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\</span>
      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\</span>
      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\</span>
      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\</span>
      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\</span>
      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h5 id="_9-1-4、启动apiserver-所有master节点"><a href="#_9-1-4、启动apiserver-所有master节点" class="header-anchor">#</a> 9.1.4、启动apiserver（所有Master节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-apiserver


<span class="token comment"># 查看日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/messages

<span class="token comment"># 检测kube-server状态</span>
systemctl status kube-apiserver

<span class="token comment"># 执行结果</span>
● kube-apiserver.service - Kubernetes API Server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-apiserver.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon <span class="token number">2020</span>-12-21 03:50:34 CST<span class="token punctuation">;</span> 56s ago
     Docs: https://github.com/kubernetes/kubernetes

<span class="token comment"># 以下日志不需要理会，是正常的日志 </span>
balancer_conn_wrappers.go:78<span class="token punctuation">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc01124e0e0, <span class="token punctuation">{</span>READY <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span><span class="token punctuation">}</span>
Dec <span class="token number">21</span> 03:51:19 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">10428</span><span class="token punctuation">]</span>: I1221 03:51:19.699478   <span class="token number">10428</span> controlbuf.go:508<span class="token punctuation">]</span> transport: loopyWriter.run returning. connection error: desc <span class="token operator">=</span> <span class="token string">&quot;transport is closing&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_9-2、配置kube-controller-manager-service-所有master节点"><a href="#_9-2、配置kube-controller-manager-service-所有master节点" class="header-anchor">#</a> 9.2、配置kube-controller-manager service （所有Master节点）</h4> <p>注意本文档使用的k8s Pod网段为172.16.0.0/12，该网段不能和宿主机的网段、k8s Service网段的重复，请按需修改</p> <h5 id="_9-2-1、三master配置文件节点相同"><a href="#_9-2-1、三master配置文件节点相同" class="header-anchor">#</a> 9.2.1、三Master配置文件节点相同</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /usr/lib/systemd/system/kube-controller-manager.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Controller Manager
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-controller-manager <span class="token punctuation">\</span>
      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span>
      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
      <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token punctuation">\</span>
      --root-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
      --cluster-signing-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
      --cluster-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
      --service-account-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key <span class="token punctuation">\</span>
      <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class="token punctuation">\</span>
      --leader-elect<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --use-service-account-credentials<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --node-monitor-grace-period<span class="token operator">=</span>40s <span class="token punctuation">\</span>
      --node-monitor-period<span class="token operator">=</span>5s <span class="token punctuation">\</span>
      --pod-eviction-timeout<span class="token operator">=</span>2m0s <span class="token punctuation">\</span>
      <span class="token parameter variable">--controllers</span><span class="token operator">=</span>*,bootstrapsigner,tokencleaner <span class="token punctuation">\</span>
      --allocate-node-cidrs<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --cluster-cidr<span class="token operator">=</span><span class="token number">172.16</span>.0.0/12 <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span class="token punctuation">\</span>
      --node-cidr-mask-size<span class="token operator">=</span><span class="token number">24</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h5 id="_9-2-2、启动-所有matser节点"><a href="#_9-2-2、启动-所有matser节点" class="header-anchor">#</a> 9.2.2、启动（所有matser节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_9-2-3、查看状态-所有matser节点"><a href="#_9-2-3、查看状态-所有matser节点" class="header-anchor">#</a> 9.2.3、查看状态（所有matser节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl  status kube-controller-manager

● kube-controller-manager.service - Kubernetes Controller Manager
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-controller-manager.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon <span class="token number">2020</span>-12-21 03:59:21 CST<span class="token punctuation">;</span> 28s ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: <span class="token number">13594</span> <span class="token punctuation">(</span>kube-controller<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_9-3、配置kube-scheduler-service-所有master节点"><a href="#_9-3、配置kube-scheduler-service-所有master节点" class="header-anchor">#</a> 9.3、配置kube-scheduler service（所有Master节点）</h4> <h5 id="_9-3-1、所有master节点配置文件相同"><a href="#_9-3-1、所有master节点配置文件相同" class="header-anchor">#</a> 9.3.1、所有master节点配置文件相同</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /usr/lib/systemd/system/kube-scheduler.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Scheduler
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-scheduler <span class="token punctuation">\</span>
      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span>
      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
      <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token punctuation">\</span>
      --leader-elect<span class="token operator">=</span>true <span class="token punctuation">\</span>
      <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h5 id="_9-3-2、启动"><a href="#_9-3-2、启动" class="header-anchor">#</a> 9.3.2、启动</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-scheduler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_9-3-3、查看状态"><a href="#_9-3-3、查看状态" class="header-anchor">#</a> 9.3.3、查看状态</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl status kube-scheduler

● kube-scheduler.service - Kubernetes Scheduler
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-scheduler.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon <span class="token number">2020</span>-12-21 04:03:50 CST<span class="token punctuation">;</span> 17s ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: <span class="token number">10915</span> <span class="token punctuation">(</span>kube-scheduler<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="十、tls-bootstrapping配置"><a href="#十、tls-bootstrapping配置" class="header-anchor">#</a> 十、TLS Bootstrapping配置</h3> <h4 id="_10-1、创建bootstrap-master01节点"><a href="#_10-1、创建bootstrap-master01节点" class="header-anchor">#</a> 10.1、创建bootstrap（Master01节点）</h4> <p>注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/bootstrap</span>

kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://10.4.7.236:8443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-credentials tls-bootstrap-token-user     <span class="token parameter variable">--token</span><span class="token operator">=</span>c8ad9c.2e4d610cf3e7426e <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>tls-bootstrap-token-user     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>注意：如果要修改bootstrap.secret.yaml的token-id和token-secret，需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致<img src="images/image-20210517202456220.png" alt="image-20210517202456220"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-c8ad9c
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: &quot;The default bootstrap token generated by 'kubelet '.&quot;
  token-id: c8ad9c   #这个跟metadata.name 后面那个一样
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/bootstrap</span>
<span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span>

<span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># kubectl create -f bootstrap.secret.yaml </span>
secret/bootstrap-token-c8ad9c created
clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="十一、node节点配置"><a href="#十一、node节点配置" class="header-anchor">#</a> 十一、Node节点配置</h3> <h4 id="_11-1、复制证书至node节点"><a href="#_11-1、复制证书至node节点" class="header-anchor">#</a> 11.1、复制证书至Node节点</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/kubernetes/</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca.pem etcd.pem etcd-key.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/
     <span class="token keyword">done</span>
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span>
     <span class="token keyword">done</span>
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_11-2、kubelet配置"><a href="#_11-2、kubelet配置" class="header-anchor">#</a> 11.2、Kubelet配置</h4> <h5 id="_11-2-1、创建相关目录-所有节点"><a href="#_11-2-1、创建相关目录-所有节点" class="header-anchor">#</a> 11.2.1、创建相关目录（所有节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_11-2-2、配置kubelet-service-所有节点"><a href="#_11-2-2、配置kubelet-service-所有节点" class="header-anchor">#</a> 11.2.2、配置kubelet service（所有节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span>  /usr/lib/systemd/system/kubelet.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">StartLimitInterval</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="_11-2-3、配置kubelet-service的配置文件-所有节点"><a href="#_11-2-3、配置kubelet-service的配置文件-所有节点" class="header-anchor">#</a> 11.2.3、配置kubelet service的配置文件（所有节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/systemd/system/kubelet.service.d/10-kubelet.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' &quot;</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_SYSTEM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="_11-2-4、kubelet的配置文件-所有节点-启动所有节点kubelet"><a href="#_11-2-4、kubelet的配置文件-所有节点-启动所有节点kubelet" class="header-anchor">#</a> 11.2.4、kubelet的配置文件（所有节点）启动所有节点kubelet</h5> <h6 id="注意-如果更改了k8s的service网段-需要更改kubelet-conf-yml-的clusterdns-配置-改成k8s-service网段的第十个地址-比如10-96-0-10-k8s的service网段开始设置的是10-96-0-0-12"><a href="#注意-如果更改了k8s的service网段-需要更改kubelet-conf-yml-的clusterdns-配置-改成k8s-service网段的第十个地址-比如10-96-0-10-k8s的service网段开始设置的是10-96-0-0-12" class="header-anchor">#</a> 注意：如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10（k8s的service网段开始设置的是10.96.0.0/12）</h6> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /etc/kubernetes/kubelet-conf.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: <span class="token number">0.0</span>.0.0
port: <span class="token number">10250</span>
readOnlyPort: <span class="token number">10255</span>
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: <span class="token boolean">true</span>
clusterDNS:
- <span class="token number">10.96</span>.0.10
clusterDomain: cluster.local
containerLogMaxFiles: <span class="token number">5</span>
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: <span class="token boolean">true</span>
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: <span class="token boolean">true</span>
enableDebuggingHandlers: <span class="token boolean">true</span>
enforceNodeAllocatable:
- pods
eventBurst: <span class="token number">10</span>
eventRecordQPS: <span class="token number">5</span>
evictionHard:
  imagefs.available: <span class="token number">15</span>%
  memory.available: 100Mi
  nodefs.available: <span class="token number">10</span>%
  nodefs.inodesFree: <span class="token number">5</span>%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: <span class="token boolean">true</span>
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: <span class="token number">127.0</span>.0.1
healthzPort: <span class="token number">10248</span>
httpCheckFrequency: 20s
imageGCHighThresholdPercent: <span class="token number">85</span>
imageGCLowThresholdPercent: <span class="token number">80</span>
imageMinimumGCAge: 2m0s
iptablesDropBit: <span class="token number">15</span>
iptablesMasqueradeBit: <span class="token number">14</span>
kubeAPIBurst: <span class="token number">10</span>
kubeAPIQPS: <span class="token number">5</span>
makeIPTablesUtilChains: <span class="token boolean">true</span>
maxOpenFiles: <span class="token number">1000000</span>
maxPods: <span class="token number">110</span>
nodeStatusUpdateFrequency: 10s
oomScoreAdj: <span class="token parameter variable">-999</span>
podPidsLimit: <span class="token parameter variable">-1</span>
registryBurst: <span class="token number">10</span>
registryPullQPS: <span class="token number">5</span>
resolvConf: /etc/resolv.conf
rotateCertificates: <span class="token boolean">true</span>
runtimeRequestTimeout: 2m0s
serializeImagePulls: <span class="token boolean">true</span>
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h5 id="_11-2-5、启动kubelet-所有节点"><a href="#_11-2-5、启动kubelet-所有节点" class="header-anchor">#</a> 11.2.5、启动kubelet（所有节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet
<span class="token comment"># 查看此时系统日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/messages
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="_11-2-6、查看集群状态-matser01上"><a href="#_11-2-6、查看集群状态-matser01上" class="header-anchor">#</a> 11.2.6、查看集群状态（matser01上）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME           STATUS     ROLES    AGE     VERSION
k8s-master01   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m48s   v1.20.0
k8s-master02   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m48s   v1.20.0
k8s-master03   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m48s   v1.20.0
k8s-node01     NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m47s   v1.20.0
k8s-node02     NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m48s   v1.20.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_11-3、kube-proxy配置"><a href="#_11-3、kube-proxy配置" class="header-anchor">#</a> 11.3、kube-proxy配置</h4> <p>注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</p> <h5 id="_11-3-1、master01执行"><a href="#_11-3-1、master01执行" class="header-anchor">#</a> 11.3.1、Master01执行</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install</span>

kubectl <span class="token parameter variable">-n</span> kube-system create serviceaccount kube-proxy

kubectl create clusterrolebinding system:kube-proxy         <span class="token parameter variable">--clusterrole</span> system:node-proxier         <span class="token parameter variable">--serviceaccount</span> kube-system:kube-proxy

<span class="token assign-left variable">SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get sa/kube-proxy <span class="token punctuation">\</span>
    <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.secrets[0].name}'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">JWT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret/$SECRET <span class="token punctuation">\</span>
<span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.data.token}'</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span><span class="token variable">)</span></span>
<span class="token assign-left variable">PKI_DIR</span><span class="token operator">=</span>/etc/kubernetes/pki
<span class="token assign-left variable">K8S_DIR</span><span class="token operator">=</span>/etc/kubernetes

kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://10.4.7.236:8443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span><span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig

kubectl config set-credentials kubernetes     <span class="token parameter variable">--token</span><span class="token operator">=</span><span class="token variable">${JWT_TOKEN}</span>     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-context kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config use-context kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h5 id="_11-3-2、发送kube-proxy的systemd-service文件发送到其他节点-master01上"><a href="#_11-3-2、发送kube-proxy的systemd-service文件发送到其他节点-master01上" class="header-anchor">#</a> 11.3.2、发送kube-proxy的systemd Service文件发送到其他节点（master01上）</h5> <p>如果更改了集群Pod的网段，需要更改kube-proxy/kube-proxy.conf的clusterCIDR: 172.16.0.0/12参数为pod的网段。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim /root/k8s-ha-install/kube-proxy/kube-proxy.conf</span>
clusterCIDR: <span class="token number">172.16</span>.0.0/12
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="分发配置文件-master01上"><a href="#分发配置文件-master01上" class="header-anchor">#</a> 分发配置文件（master01上）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master01 k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">scp</span> <span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
     <span class="token function">scp</span> kube-proxy/kube-proxy.conf <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf
     <span class="token function">scp</span> kube-proxy/kube-proxy.service <span class="token variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service
 <span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
     <span class="token function">scp</span> kube-proxy/kube-proxy.conf <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf
     <span class="token function">scp</span> kube-proxy/kube-proxy.service <span class="token variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h5 id="_11-3-3、启动kube-proxy-所有节点"><a href="#_11-3-3、启动kube-proxy-所有节点" class="header-anchor">#</a> 11..3.3、启动kube-proxy（所有节点）</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="十二、安装calico"><a href="#十二、安装calico" class="header-anchor">#</a> 十二、安装Calico</h3> <p>Calico的安装请必须听视频课程和最后一章升级Calico的视频</p> <h4 id="_12-1、安装calico-在master01上"><a href="#_12-1、安装calico-在master01上" class="header-anchor">#</a> 12.1、安装Calico（在master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/calico/</span>

<span class="token comment"># 修改calico-etcd.yaml的以下位置</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#etcd_endpoints: &quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;#etcd_endpoints: &quot;https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379&quot;#g'</span> calico-etcd.yaml



<span class="token assign-left variable">ETCD_CA</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'\n'</span><span class="token variable">`</span></span>
<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'\n'</span><span class="token variable">`</span></span>
<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd-key.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'\n'</span><span class="token variable">`</span></span>

<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s@# etcd-key: null@etcd-key: <span class="token variable">${ETCD_KEY}</span>@g; s@# etcd-cert: null@etcd-cert: <span class="token variable">${ETCD_CERT}</span>@g; s@# etcd-ca: null@etcd-ca: <span class="token variable">${ETCD_CA}</span>@g&quot;</span> calico-etcd.yaml


<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#etcd_ca: &quot;&quot;#etcd_ca: &quot;/calico-secrets/etcd-ca&quot;#g; s#etcd_cert: &quot;&quot;#etcd_cert: &quot;/calico-secrets/etcd-cert&quot;#g; s#etcd_key: &quot;&quot; #etcd_key: &quot;/calico-secrets/etcd-key&quot; #g'</span> calico-etcd.yaml

<span class="token comment"># 更改此处为自己的pod网段</span>
<span class="token assign-left variable">POD_SUBNET</span><span class="token operator">=</span><span class="token string">&quot;172.168.0.0/12&quot;</span>

<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: &quot;192.168.0.0/16&quot;@  value: '</span>&quot;<span class="token variable">${POD_SUBNET}</span>&quot;<span class="token string">'@g'</span> calico-etcd.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_12-2、apply"><a href="#_12-2、apply" class="header-anchor">#</a> 12.2、apply</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 calico<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f calico-etcd.yaml</span>
<span class="token comment"># 执行结果</span>
secret/calico-etcd-secrets created
configmap/calico-config created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_12-3、查看容器状态"><a href="#_12-3、查看容器状态" class="header-anchor">#</a> 12.3、查看容器状态</h4> <h5 id="如果容器状态异常可以使用kubectl-describe-或者logs查看容器的日志"><a href="#如果容器状态异常可以使用kubectl-describe-或者logs查看容器的日志" class="header-anchor">#</a> 如果容器状态异常可以使用kubectl describe 或者logs查看容器的日志</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 calico<span class="token punctuation">]</span><span class="token comment"># kubectl  get po -n kube-system</span>
NAME                                       READY   STATUS     RESTARTS   AGE
calico-kube-controllers-5f6d4b864b-pq2qw   <span class="token number">0</span>/1     Pending    <span class="token number">0</span>          45s
calico-node-75blv                          <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          46s
calico-node-hw27b                          <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          46s
calico-node-k2wdf                          <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          46s
calico-node-l58lz                          <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          46s
calico-node-v2qlq                          <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          46s
coredns-867d46bfc6-8vzrk                   <span class="token number">0</span>/1     Pending    <span class="token number">0</span>          10m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="十三、安装coredns"><a href="#十三、安装coredns" class="header-anchor">#</a> 十三、安装CoreDNS</h3> <h4 id="_13-1、安装对应版本-推荐"><a href="#_13-1、安装对应版本-推荐" class="header-anchor">#</a> 13.1、安装对应版本（推荐）</h4> <p>master01操作</p> <p>如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/

<span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># sed -i &quot;s#10.96.0.10#10.96.0.10#g&quot; CoreDNS/coredns.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_13-2、安装coredns"><a href="#_13-2、安装coredns" class="header-anchor">#</a> 13.2、安装coredns</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># kubectl  create -f CoreDNS/coredns.yaml</span>
<span class="token comment"># 执行结果</span>
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_13-3、安装最新版coredns-不建议"><a href="#_13-3、安装最新版coredns-不建议" class="header-anchor">#</a> 13.3、安装最新版CoreDNS（不建议）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/coredns/deployment.git
<span class="token builtin class-name">cd</span> deployment/kubernetes
<span class="token comment"># ./deploy.sh -s -i 10.96.0.10 | kubectl apply -f -</span>
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created

<span class="token comment"># 查看状态</span>
<span class="token comment"># kubectl get po -n kube-system -l k8s-app=kube-dns</span>
NAME                       READY   STATUS    RESTARTS   AGE
coredns-85b4878f78-h29kh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="十四、安装metrics-server"><a href="#十四、安装metrics-server" class="header-anchor">#</a> 十四、安装Metrics Server</h3> <p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p> <h4 id="_14-1、安装metrics-server"><a href="#_14-1、安装metrics-server" class="header-anchor">#</a> 14.1、安装metrics server</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/metrics-server-0.4.x/</span>

<span class="token punctuation">[</span>root@k8s-master01 metrics-server-0.4.x<span class="token punctuation">]</span><span class="token comment"># kubectl  create -f . </span>

<span class="token comment"># 执行结果</span>
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_14-2、等待metrics-server启动然后查看状态"><a href="#_14-2、等待metrics-server启动然后查看状态" class="header-anchor">#</a> 14.2、等待metrics server启动然后查看状态</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  top node             </span>
NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%   
k8s-master01   384m         <span class="token number">19</span>%    1110Mi          <span class="token number">59</span>%       
k8s-master02   334m         <span class="token number">16</span>%    1086Mi          <span class="token number">58</span>%       
k8s-master03   324m         <span class="token number">16</span>%    1043Mi          <span class="token number">55</span>%       
k8s-node01     208m         <span class="token number">10</span>%    573Mi           <span class="token number">30</span>%       
k8s-node02     180m         <span class="token number">9</span>%     534Mi           <span class="token number">28</span>%
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="十五、安装dashboard"><a href="#十五、安装dashboard" class="header-anchor">#</a> 十五、安装dashboard</h3> <p>Dashboard用于展示集群中的各类资源，同时也可以通过Dashboard实时查看Pod的日志和在容器中执行一些命令等。</p> <h4 id="_15-1、安装指定版本dashboard"><a href="#_15-1、安装指定版本dashboard" class="header-anchor">#</a> 15.1、安装指定版本dashboard</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/dashboard/</span>

<span class="token punctuation">[</span>root@k8s-master01 dashboard<span class="token punctuation">]</span><span class="token comment"># kubectl  create -f .</span>
serviceaccount/admin-user created
clusterrolebinding.rbac.authorization.k8s.io/admin-user created
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_15-2、安装最新版"><a href="#_15-2、安装最新版" class="header-anchor">#</a> 15.2、安装最新版</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 官方GitHub地址：https://github.com/kubernetes/dashboard</span>
<span class="token comment"># 可以在官方dashboard查看到最新版dashboard</span>

kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml

<span class="token comment"># 创建管理员用户vim admin.yaml</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding 
metadata: 
  name: admin-user
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">&quot;true&quot;</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system

<span class="token comment"># 安装</span>
kubectl apply <span class="token parameter variable">-f</span> admin.yaml <span class="token parameter variable">-n</span> kube-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_15-3、登录dashboard"><a href="#_15-3、登录dashboard" class="header-anchor">#</a> 15.3、登录dashboard</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 更改dashboard的svc为NodePort</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span>
将ClusterIP更改为NodePort

<span class="token comment"># 查看端口号</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span>
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
kubernetes-dashboard   NodePort   <span class="token number">10.96</span>.77.112   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>:30902/TCP   4m10s

<span class="token comment"># 根据自己的实例端口号，通过任意安装了kube-proxy的宿主机或者VIP的IP+端口即可访问到dashboard</span>
页面访问：https://10.4.7.236:30902/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_15-4、查看token值"><a href="#_15-4、查看token值" class="header-anchor">#</a> 15.4、查看token值</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="十六、集群验证"><a href="#十六、集群验证" class="header-anchor">#</a> 十六、集群验证</h3> <h4 id="_16-1、安装busybox-master01上"><a href="#_16-1、安装busybox-master01上" class="header-anchor">#</a> 16.1、安装busybox（master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: busybox:1.28
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_16-2、验证步骤-matser01上"><a href="#_16-2、验证步骤-matser01上" class="header-anchor">#</a> 16.2、验证步骤（matser01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">1</span>.    Pod必须能解析Service
<span class="token number">2</span>.    Pod必须能解析跨namespace的Service
<span class="token number">3</span>.    每个节点都必须要能访问Kubernetes的kubernetes svc <span class="token number">443</span>和kube-dns的service <span class="token number">53</span>
<span class="token number">4</span>.    Pod和Pod之间要能通
    a<span class="token punctuation">)</span>    同namespace能通信
    b<span class="token punctuation">)</span>    跨namespace能通信
    c<span class="token punctuation">)</span>    跨机器能通信
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_16-3、步骤演示-matser01上"><a href="#_16-3、步骤演示-matser01上" class="header-anchor">#</a> 16.3、步骤演示（matser01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 首先查看po是否安装成功</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get po</span>
NAME      READY   STATUS    RESTARTS   AGE
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m11s

<span class="token comment"># 查看svc是否正常</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   163m

<span class="token comment"># 查看Pod是否能能解析Service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec  busybox -n default -- nslookup kubernetes </span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.1 kubernetes.default.svc.cluster.local

<span class="token comment"># 查看Pod是否能解析跨namespace的Service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec  busybox -n default -- nslookup kube-dns.kube-system</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kube-dns.kube-system
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

<span class="token comment"># 跟我以上结果一致就成功了</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="_16-4、使用telnet命令验证"><a href="#_16-4、使用telnet命令验证" class="header-anchor">#</a> 16.4、使用telnet命令验证</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 所有节点安装telnet命令,有的话忽略</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> telnet

<span class="token comment"># 所有机器 10.96.0.1  443  kubernetes svc 443</span>
<span class="token comment"># 所有机器 10.96.0.10 53   kube-dns的service 53</span>
<span class="token comment"># 不会自动断开就是成功了</span>
telnet <span class="token number">10.96</span>.0.1 <span class="token number">443</span>
telnet <span class="token number">10.96</span>.0.10 <span class="token number">53</span>

Trying <span class="token number">10.96</span>.0.1<span class="token punctuation">..</span>.
Connected to <span class="token number">10.96</span>.0.1.
Escape character is <span class="token string">'^]'</span><span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_16-5、使用curl命令验证-所有机器"><a href="#_16-5、使用curl命令验证-所有机器" class="header-anchor">#</a> 16.5、使用curl命令验证（所有机器）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.96.0.10:53</span>
curl: <span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">)</span> Empty reply from server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_16-6、容器验证-master01上"><a href="#_16-6、容器验证-master01上" class="header-anchor">#</a> 16.6、容器验证（master01上）</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get po -n kube-system</span>
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-5f6d4b864b-pq2qw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m
calico-node-75blv                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m
calico-node-hw27b                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m
calico-node-k2wdf                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m
calico-node-l58lz                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m
calico-node-v2qlq                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m
coredns-867d46bfc6-8vzrk                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          72m
metrics-server-595f65d8d5-kgn8c            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          60m

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get po -n kube-system -owide</span>
NAME                                       READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-5f6d4b864b-pq2qw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63m   <span class="token number">10.4</span>.7.107   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-75blv                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63m   <span class="token number">10.4</span>.7.110   k8s-node01     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-hw27b                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63m   <span class="token number">10.4</span>.7.108   k8s-master02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-k2wdf                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63m   <span class="token number">10.4</span>.7.107   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-l58lz                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63m   <span class="token number">10.4</span>.7.109   k8s-master03   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-v2qlq                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63m   <span class="token number">10.4</span>.7.111   k8s-node02     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
coredns-867d46bfc6-8vzrk                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          73m   <span class="token number">172.161</span>.125.2   k8s-node01     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
metrics-server-595f65d8d5-kgn8c            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          62m   <span class="token number">172.161</span>.125.1   k8s-node01     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment"># 能进去就ok</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it calico-node-v2qlq -n  kube-system  -- sh</span>
sh-4.4<span class="token comment">#</span>

<span class="token comment"># 进入node01，然后能ping通node02就行</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it calico-node-v2qlq -n  kube-system  -- bash</span>
<span class="token punctuation">[</span>root@k8s-node02 /<span class="token punctuation">]</span><span class="token comment"># ping 10.4.7.111</span>
PING <span class="token number">10.4</span>.7.111 <span class="token punctuation">(</span><span class="token number">10.4</span>.7.111<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">10.4</span>.7.111: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.123</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.4</span>.7.111: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.090</span> ms
^C
--- <span class="token number">10.4</span>.7.111 <span class="token function">ping</span> statistics ---
<span class="token number">2</span> packets transmitted, <span class="token number">2</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 46ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.090</span>/0.106/0.123/0.019 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="十七、生产环境关键性配置"><a href="#十七、生产环境关键性配置" class="header-anchor">#</a> 十七、生产环境关键性配置</h3> <p>17.1、关键性配置请参考视频，<strong>不要直接配置！</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 所有节点都改</span>
<span class="token function">vim</span> /etc/docker/daemon.json
<span class="token punctuation">{</span>  <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;https://registry.docker-cn.com&quot;</span>,
    <span class="token string">&quot;http://hub-mirror.c.163.com&quot;</span>,
    <span class="token string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
  <span class="token punctuation">]</span>,
 <span class="token string">&quot;exec-opts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;native.cgroupdriver=systemd&quot;</span><span class="token punctuation">]</span>,
 <span class="token string">&quot;max-concurrent-downloads&quot;</span><span class="token builtin class-name">:</span> <span class="token number">10</span>,  
 <span class="token string">&quot;max-concurrent-uploads&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,  
 <span class="token string">&quot;log-opts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">&quot;max-size&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;300m&quot;</span>,    <span class="token string">&quot;max-file&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2&quot;</span>  <span class="token punctuation">}</span>,  
 <span class="token string">&quot;live-restore&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span> 
 <span class="token punctuation">}</span> 

max-concurrent-downloads <span class="token comment"># 下载并发数</span>
max-concurrent-uploads   <span class="token comment"># 上传并发数</span>
max-size                 <span class="token comment"># 日志文件最大到多少切割 （此处是300m）</span>
max-file                 <span class="token comment"># 日志文件保留个数    （此处是2个）</span>
live-restore             <span class="token comment"># 开启这个参数，重启docker不会影响上面的参数</span>

<span class="token comment"># 所有节点改完重启docker</span>
systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart <span class="token function">docker</span>


<span class="token function">vim</span> /usr/lib/systemd/system/kube-controller-manager.service
 <span class="token comment"># 找个位置加上,在三个master节点</span>
 --experimental-cluster-signing-duration<span class="token operator">=</span>876000h0m0s <span class="token punctuation">\</span>

 <span class="token comment"># 改完重启</span>
systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart kube-controller-manager


<span class="token comment"># 所有节点，更换成以下的配置文件</span>
<span class="token punctuation">[</span>root@k8s-node02 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/systemd/system/kubelet.service.d/10-kubelet.conf </span>

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384    --image-pull-progress-deadline=30m &quot;</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_SYSTEM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span>
<span class="token comment"># 所有节点、添加如下配置-----  注意请更具生成环境配置</span>
<span class="token function">vim</span> /etc/kubernetes/kubelet-conf.yml

rotateServerCertificates: <span class="token boolean">true</span>
allowedUnsafeSysctls:
 - <span class="token string">&quot;net.core*&quot;</span>
 - <span class="token string">&quot;net.ipv4.*&quot;</span>
kubeReserved:
  cpu: <span class="token string">&quot;10m&quot;</span>
  memory: 10Mi
  ephemeral-storage: 10Mi
systemReserved:
  cpu: <span class="token string">&quot;1&quot;</span>
  memory: 20Mi
  ephemeral-storage: 1Gi


<span class="token comment"># 改完重启</span>
systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart kubelet

<span class="token comment"># 查看日志没报错就行</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/messages                            </span>
<span class="token comment"># 角色名字更改</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-master01 node-role.kubernetes.io/matser=''</span>
node/k8s-master01 labeled
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME           STATUS   ROLES    AGE    VERSION
k8s-master01   Ready    matser   129m   v1.20.0   <span class="token comment"># 成功更改</span>
k8s-master02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   129m   v1.20.0
k8s-master03   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   129m   v1.20.0
k8s-node01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   129m   v1.20.0
k8s-node02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   129m   v1.20.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h3 id="十八、安装总结"><a href="#十八、安装总结" class="header-anchor">#</a> 十八、安装总结</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">1</span>、    kubeadm
<span class="token number">2</span>、    二进制
<span class="token number">3</span>、    自动化安装
    a<span class="token punctuation">)</span>    Ansible
        i.    Master节点安装不需要写自动化。
        ii.    添加Node节点，playbook。
<span class="token number">4</span>、    安装需要注意的细节
    a<span class="token punctuation">)</span>    上面的细节配置
    b<span class="token punctuation">)</span>    生产环境中etcd一定要和系统盘分开，一定要用ssd硬盘。
    c<span class="token punctuation">)</span>    Docker数据盘也要和系统盘分开，有条件的话可以使用ssd硬盘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="十九、bootstrapping"><a href="#十九、bootstrapping" class="header-anchor">#</a> 十九、Bootstrapping</h3> <p>这里是补充扩展的知识</p> <h4 id="bootstrapping-csr申请和证书颁发原理"><a href="#bootstrapping-csr申请和证书颁发原理" class="header-anchor">#</a> Bootstrapping CSR申请和证书颁发原理</h4> <p>1.kubelet启动</p> <p>2.kubele t查找 kubelet.kubeconfig 文件，假设没有这个文件</p> <p>3.kubelet 会查找本地 bootstrap-kubelet.kubeconfig</p> <p>4.kubelet 读取 bootstrap.kubeconfig 文件，检索apiserver 的 url 和一个token</p> <p>5.kubelet 链接 apiserver, 使用这个token 进行认证</p> <p>​    a) apiserver 会识别tokenid，  apiserver 会查找该 tokenid 对应的 bootstrap 的要给 secret</p> <p>​    b) 找这个 secret 中的一个字段， apiserver 把这个 token 识别成一个 username，名称是 system:bootstrap:<token-id>，属于system:bootstrappers这个组，这个组具有申请csr的权限, 该组的权限绑定在一个叫 system:node-bootstrapper的 clusterrole； clusterrole k8s 集群级别的权限控制，它作用整个k8s集群。</token-id></p> <p>​    c) CSR： 相当于申请表，可以拿着这个申请表去申请我们的证书。</p> <p>6.经过上面的认证，kubelet 就有了一个创建和检索 CSR的权限。</p> <p>7.kubelet 为自己创建一个CSR，名称为 kubernetes.io/kube-apiserver-clinet-kubelet</p> <p>8.CSR 被允许有两种方式：</p> <p>​    a) k8s 管理员使用 kubectl 手动的颁发证书</p> <p>​    b) 如果配置了相关权限，kube-controller-manager 会自动同意。</p> <ol start="9"><li><p>CSR 被同意后， controller-manager 创建 kubelet的证书文件</p></li> <li><p>controller-manager 将证书更新至 csr的 status字段</p></li> <li><p>kubelet 从 apiserver 获取证书</p></li> <li><p>kubelet 从获取到的 ey 和证书文件 创建 kubelet.kubeconfig</p></li> <li><p>kubelet 启动完成并正常工作</p></li> <li><p>可选：如果配置了自动续期，kubelet 会在证书文件过期的时候利用之前的 kubeconfig 文件去申请一个新的证书，相当于续约。</p></li> <li><p>新的证书被同意或签发，取决于我们的配置。</p></li></ol></div></div> <div class="page-slot page-slot-bottom"><div class="donation">
  <button>打赏</button>
  <div class="main">
      <div class="pic">
          <img src="http://pic.zzppjj.top/LightPicture/2023/02/cebf13bbcea9264d.jpg" alt="微信">
          <img src="http://pic.zzppjj.top/LightPicture/2023/02/d98d15501306c7c4.jpg" alt="支付宝">
      </div>
  </div>
</div></div> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/04/24, 17:05:25</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/82114b/" class="prev">k8s入门</a></span> <span class="next"><a href="/pages/88cfe8/">k8s面试题</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/a3cd2b/"><div>
            pip更换国内源
            <!----></div></a> <span class="date">07-31</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/df6e29/"><div>
            conda安装和镜像源配置
            <!----></div></a> <span class="date">07-31</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/6cb488/"><div>
            awk常用参数和使用示例
            <!----></div></a> <span class="date">07-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/zpj874878956" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="mailto:874878956@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://blog.zzppjj.top/rss.xml" title="订阅" target="_blank" class="iconfont icon-rss"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2024
    <span>| <a href="https://www.foreverblog.cn/" class="d-inline-block text-muted" target="_blank" rel="external nofollow"><img src="/img/964560013b68c2e4.png" alt="点击查看十年之约" style="width:auto;height:11px;"></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><canvas id="vuepress-canvas-cursor"></canvas><!----><div></div><div></div><div></div></div></div>
    <script src="/assets/js/app.73676f20.js" defer></script><script src="/assets/js/4.23144ec8.js" defer></script><script src="/assets/js/1.09d67b9a.js" defer></script><script src="/assets/js/3.fc5194e0.js" defer></script><script src="/assets/js/84.1c1a3c28.js" defer></script><script src="/assets/js/38.33c96ce4.js" defer></script><script src="/assets/js/21.2c073392.js" defer></script>
  </body>
</html>
