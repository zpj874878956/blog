---
title: jenkins使用流水线部署go程序
date: 2023-07-03 16:02:35
permalink: /pages/ad193b/
categories:
  - 专题
  - jenkins
tags:
  - 
---

### jenkins界面新建项目

![b711dbb9c60fa891.jpg](http://pic.zzppjj.top/LightPicture/2023/07/b711dbb9c60fa891.jpg)

### 编写脚本式流水线脚本

```groovy
node("jenkins-slave4") {
    properties([
        parameters([
            choice(name: 'serviceName', choices: ['goland-demo'], description: ''),
            choice(name: 'targetHosts', choices: ['test001'], description: ''),
            choice(name: 'targetDir', choices: ['/data/application'], description: ''),
            gitParameter(branch:'', branchFilter: 'origin/(.*)', defaultValue: 'main', description: '选择将要构建的分支', name: 'TAG', quickFilterEnabled: true, selectedValue: 'TOP', sortMode: 'DESCENDING_SMART', tagFilter: '*', type: 'PT_BRANCH_TAG', useRepository: 'ssh://git@xxxxxx/goland-demo.git')
        ])
    ])

    stage('Checkout') {
            checkout(
                [$class: 'GitSCM', doGenerateSubmoduleConfigurations: false, submoduleCfg: [], extensions: [[$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]],
                branches: [[name: "main"]],userRemoteConfigs: [[url: "ssh://git@xxxxxx/goland-demo.git"]]]
            )
    }
    stage('ansible') {
        dir("/var/jenkins_home/ansible"){
            checkout(
                [$class: 'GitSCM', doGenerateSubmoduleConfigurations: false, submoduleCfg: [], extensions: [[$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]],
                branches: [[name: "master"]],userRemoteConfigs: [[url: "ssh://git@xxxxxx/ansible.git"]]]
            )
        }
    }
    stage('编译') {
            sh """ 
               export GOPATH=/usr/local/go
               export PATH=$PATH:\$GOPATH/bin
               go build -o ${serviceName}/main ./main.go
               cp -rf static service.sh ${serviceName}/
               tar -zcf ${serviceName}.tar.gz ${serviceName}
           """
    }  
    stage('部署') {
            ansiblePlaybook become: true, becomeUser: null, credentialsId: 'deploy_local', extras: '--extra-vars "WORKSPACE=${WORKSPACE} serviceName=${serviceName} targetHosts=${targetHosts} targetDir=${targetDir}"', inventory: '/var/jenkins_home/ansible/local_hosts', playbook: '/var/jenkins_home/ansible/xxx/test.yml', sudoUser: null, disableHostKeyChecking: true
    }

}
```

**test.yml剧本文件如下**

```yaml
---
- hosts: "{{ targetHosts }}"
  remote_user: admin
  gather_facts: false
  become: yes
  tasks:    
    - name: "拷贝部署文件"
      copy:
        src: "{{item.src}}"
        dest: "{{item.dest}}"
        owner: admin
        group: admin
        mode: 0755
      with_items:
        - {src: "{{ WORKSPACE }}/{{ serviceName }}.tar.gz",dest: "/tmp/application/"}
    - name: "Execute the script"
      shell: |
        rm -rf {{ targetDir }}/*
        cd {{ targetDir }}
        cp -rf /tmp/application/{{ serviceName }}.tar.gz {{ targetDir }}/ && tar -xf {{ serviceName }}.tar.gz
        cd {{ serviceName }} && chmod +x service.sh && ./service.sh stop && ./service.sh start {{ targetDir }}/{{ serviceName }}
```

**go服务启动停止service.sh脚本**

```bash
#!/bin/bash

targetDir=$2

start(){
    cd ${targetDir}
    nohup ./main >>/dev/null 2>&1& echo $! > service.pid
    cd -
    
}


stop(){
    pid=`cat service.pid`
    if [ -z $pid ]
    then 
        echo "pid"
    else
        kill -9 ${pid}
        kill -9 ${pid}
        kill -9 ${pid}
    fi
}


case $1 in
start)
    start
    ;;
stop)
    stop
    ;;
    
restart)
    stop
    sleep 5
    start
    ;;
*)
    echo "[start|stop|restart]"
    ;;
    
esac
```

将以上脚本文件push到运维git仓库管理

### 发布

![5a42bb4e4b807012.jpg](http://pic.zzppjj.top/LightPicture/2023/07/5a42bb4e4b807012.jpg)

![586f99b0a024a383.jpg](http://pic.zzppjj.top/LightPicture/2023/07/586f99b0a024a383.jpg)
