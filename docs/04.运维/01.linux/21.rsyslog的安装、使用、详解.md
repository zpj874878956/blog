---
title: rsyslog的安装、使用、详解
date: 2024-05-29 22:23:42
permalink: /pages/fe7ca7/
categories:
  - 运维
  - linux
tags:
  - 
---

# 关于rsyslog

> rsyslog是比syslog功能更强大的日志记录系统，可以将日志输出到文件，数据库和其它程序。Centos 7.x默认的rsyslog版本是8.x。
>     **rsyslog** 是一个快速处理收集系统日志的程序，提供了高性能、安全功能和模块化设计。rsyslog 是syslog 的升级版，它将多种来源输入输出转换结果到目的地，并可定制和过滤、筛选。据官网介绍，现在可以处理100万条信息。  
> 特性：  
>        1、可以直接将日志写入到数据库。  
>        2、日志队列（内存队列和磁盘队列）。  
>        3、灵活的模板机制，可以得到多种输出格式。  
>        4、插件式结构，多种多样的输入、输出模块。  
>        5、可以把日志存放在Mysql ，PostgreSQL，Oracle等数据库中

# 系统环境

**server端**

```bash
[root@iZbp13gj9fz5t0mxux5nfyZ ~]# cat /etc/redhat-release 
Alibaba Cloud Linux release 3 (Soaring Falcon) 
[root@iZbp13gj9fz5t0mxux5nfyZ 2024-05-29]# rsyslogd -v
rsyslogd  8.2102.0-15.1.al8 (aka 2021.02) compiled with:
        PLATFORM:                               x86_64-koji-linux-gnu
        PLATFORM (lsb_release -d):
        FEATURE_REGEXP:                         Yes
        GSSAPI Kerberos 5 support:              Yes
        FEATURE_DEBUG (debug build, slow code): No
        32bit Atomic operations supported:      Yes
        64bit Atomic operations supported:      Yes
        memory allocator:                       system default
        Runtime Instrumentation (slow code):    No
        uuid support:                           Yes
        systemd support:                        Yes
        Config file:                            /etc/rsyslog.conf
        PID file:                               /var/run/rsyslogd.pid
        Number of Bits in RainerScript integers: 64
```

**client端**

```bash
[root@cvm-3jvysn225i225 ~]# cat /etc/redhat-release 
CentOS Linux release 7.8.2003 (Core)
[root@cvm-3jvysn225i225 ~]# rsyslogd -v
rsyslogd 8.24.0-57.el7_9.3, compiled with:
        PLATFORM:                               x86_64-redhat-linux-gnu
        PLATFORM (lsb_release -d):
        FEATURE_REGEXP:                         Yes
        GSSAPI Kerberos 5 support:              Yes
        FEATURE_DEBUG (debug build, slow code): No
        32bit Atomic operations supported:      Yes
        64bit Atomic operations supported:      Yes
        memory allocator:                       system default
        Runtime Instrumentation (slow code):    No
        uuid support:                           Yes
        Number of Bits in RainerScript integers: 64

See http://www.rsyslog.com for more information.
```

# 客户端的配置

rsyslog.conf

```bash
$ModLoad imuxsock # provides support for local system logging (e.g. via logger command)
$ModLoad imjournal # provides access to the systemd journal
$ModLoad imklog # reads kernel messages (the same are read from journald)
module(load="imfile" PollingInterval="5")
WorkDirectory /var/lib/rsyslog
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
$IncludeConfig /etc/rsyslog.d/*.conf
$OmitLocalLogging on
$IMJournalStateFile imjournal.state
*.info;mail.none;authpriv.none;cron.none;local7.none;local1.none                /var/log/messages
authpriv.*                                              /var/log/secure
mail.*                                                  -/var/log/maillog
cron.*                                                  /var/log/cron
*.emerg                                                 :omusrmsg:*
uucp,news.crit                                          /var/log/spooler
local0.*                                                /var/log/boot.log
ruleset(name="remote"){
action(type="omfwd"
target="114.55.113.57"   #远程rsyslog server ip 生产环境需要做端口映射202.106.149.226:514----10.10.16.253:514
port="514" #端口：
protocol="tcp" #使用协议
queue.type="linkedList" #使用异步处理 
queue.spoolDirectory="/var/spool/rsyslog" #队列目录,需在客户端创建
queue.fileName="remoteQueue_114.55.113.57" #队列名称
queue.maxDiskSpace="5g" #队列占最大磁盘空间
queue.saveOnShutdown="on" #保存内存数据如果rsyslog关闭
action.resumeRetryCount="-1" #无限重试插入失败
    )
stop
}
```

app.conf

```bash
input(type="imfile"
      File="/data/nginx/logs/*.log"
      Tag="app1"
      #定义持久化监控,这个版本弃用
      #stateFile="/data/rsyslog/state/app1-log.state"
      Ruleset="remote"
      #回写偏移量数据到文件间隔时间(秒)，根据实际情况而定
      PersistStateInterval="5"
      #如果 rsyslog 检测到文件被截断，它将重新打开该文件
      #reopenOnTruncate="on"
      Facility="local7"
      )
input(type="imfile"
      File="/opt/apps/artalk/data/*.log"
      Tag="app2"
      #定义持久化监控,这个版本弃用
      #stateFile="/data/rsyslog/state/app2-log.state"
      Ruleset="remote"
      PersistStateInterval="5"
      #reopenOnTruncate="on"
      Facility="local1"
      )
local7.* @@114.55.113.57:514
local1.* @@114.55.113.57:514
```

# 服务端配置

rsyslog.conf

```bash
module(load="imuxsock"    # provides support for local system logging (e.g. via logger command)
       SysSock.Use="off") # Turn off message reception via local log socket; 
                          # local messages are retrieved through imjournal now.
module(load="imjournal"             # provides access to the systemd journal
       StateFile="imjournal.state") # File to store the position in the journal
module(load="imtcp") # needs to be done just once
input(type="imtcp" port="514")
global(workDirectory="/var/lib/rsyslog")
module(load="builtin:omfile" Template="RSYSLOG_TraditionalFileFormat")
include(file="/etc/rsyslog.d/*.conf" mode="optional")
$template IpTemplate,"/data/logs/%FROMHOST-IP%/%$YEAR%-%$MONTH%-%$DAY%/%PROGRAMNAME%.log"
:fromhost-ip, !isequal, "127.0.0.1" ?IpTemplate
if $fromhost-ip == '127.0.0.1' then stop
*.* ?IpTemplate
```

收集的日志目录展示

    logs
    └── 103.152.133.13
        ├── 2024-05-27
        │   ├── app1.log
        │   └── app2.log
        ├── 2024-05-28
        │   ├── app1.log
        │   └── app2.log
        └── 2024-05-29
            ├── app1.log
            └── app2.log
