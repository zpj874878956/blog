---
title: argocd+gitlab应用自动发布
date: 2024-03-13 16:40:03
permalink: /pages/a9f2de/
categories:
  - 运维
  - 系统
  - argocd
tags:
  - 
---

# gitlab仓库配置

推荐gitlab创建空仓库后，拉取到本地编辑好以后再提交，不要直接编辑gitlab的yaml文件，因为gitlab在线编辑时，换行与tab空格在argocd上可能存在识别失败，不是标准的yaml文件，无法创建应用。  
创建一个最简单的仓库，仅包含应用的yaml文件，文件内容如下

```bash
[root@k8s-master test-git]# tree test/
test/
├── manifests
│   └── test.yaml
└── README.md

1 directory, 2 files
[root@k8s-master test-git]# cat test/manifests/test.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  namespace: default
spec:
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
        resources:
          limits:
            memory: "128Mi"
            cpu: "500m"
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: myapp
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: myapp
  namespace: default
spec:
  entryPoints:
  - web
  routes:
  - match: Host(`myapp.test.com`)
    kind: Rule
    services:
      - name: myapp 
        port: 80  
```

gitlab仓库内容如下：

![2eb241a66555b688.jpg](http://pic.zzppjj.top/LightPicture/2024/03/2eb241a66555b688.jpg)

# argocd配置

## 添加仓库地址

添加仓库地址，Settings → Repositories，点击 Connect Repo using HTTPS 按钮：

![8ce7541c48d7260d.jpg](http://pic.zzppjj.top/LightPicture/2024/03/8ce7541c48d7260d.jpg)

填写以下信息

![6197a9d75a2dff83.jpg](http://pic.zzppjj.top/LightPicture/2024/03/6197a9d75a2dff83.jpg)

验证通过后显示如下，点击创建应用

![28f827d9d809275a.jpg](http://pic.zzppjj.top/LightPicture/2024/03/28f827d9d809275a.jpg)

## 创建应用

填写以下内容

![9106d5966f1f6507.jpg](http://pic.zzppjj.top/LightPicture/2024/03/9106d5966f1f6507.jpg)

![5a5b2c31cc989868.jpg](http://pic.zzppjj.top/LightPicture/2024/03/5a5b2c31cc989868.jpg)

创建完后如下所示：

![a36dec337f0a931b.jpg](http://pic.zzppjj.top/LightPicture/2024/03/a36dec337f0a931b.jpg)

# 访问验证

## 验证应用部署状态

查看k8s创建的资源信息，发现已经成功创建了对应的资源

```bash
[root@k8s-master test-git]# kubectl get pod 
NAME                                               READY   STATUS    RESTARTS         AGE
myapp-68c8648d6d-54brv                             1/1     Running   0                62s
[root@k8s-master test-git]# kubectl get svc
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)    AGE
myapp        ClusterIP      10.97.189.71    <none>           80/TCP     70s
[root@k8s-master test-git]# kubectl get ingressroute
NAME     AGE
myapp    78s
```

访问web页面验证

![4df641bf42ca7527.jpg](http://pic.zzppjj.top/LightPicture/2024/03/4df641bf42ca7527.jpg)

## 版本更新

接下来模拟配置变更，将镜像版本从v1改为v2

![cf18eba0acb5a576.jpg](http://pic.zzppjj.top/LightPicture/2024/03/cf18eba0acb5a576.jpg)

查看argocd信息，发现已经自动同步了yaml文件，并且正在进行发布

![2548c800bee72a15.jpg](http://pic.zzppjj.top/LightPicture/2024/03/2548c800bee72a15.jpg)

访问web页面状态，发现已经完成了发布工作。

![08504735e1d74486.jpg](http://pic.zzppjj.top/LightPicture/2024/03/08504735e1d74486.jpg)

此时整个应用关联关系如下

![6fe956b320167775.jpg](http://pic.zzppjj.top/LightPicture/2024/03/6fe956b320167775.jpg)

## 版本回退

点击history and rollback即可看到整个应用的所有发布记录，并且可以选择指定版本进行回退操作。

![a28064654ad1ddaa.jpg](http://pic.zzppjj.top/LightPicture/2024/03/a28064654ad1ddaa.jpg)

再次访问发现已经回退到v1版本

![84b07ff0130b4bfc.jpg](http://pic.zzppjj.top/LightPicture/2024/03/84b07ff0130b4bfc.jpg)

---

[原文链接](https://www.cuiliangblog.cn/detail/section/119675638)
