(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{428:function(s,a,t){"use strict";t.r(a);var n=t(0),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("原文链接："),a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ansible性能优化——提升ansible执行效率 - 吕振江 - 博客园"),a("OutboundLink")],1)]),s._v(" "),a("h1",{attrs:{id:"ansible性能优化-提升ansible执行效率"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ansible性能优化-提升ansible执行效率"}},[s._v("#")]),s._v(" "),a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ansible性能优化——提升ansible执行效率"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("目录")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#%E4%B8%80%E3%80%81%E5%85%B3%E9%97%ADgathering-facts%E5%8A%9F%E8%83%BD",target:"_blank",rel:"noopener noreferrer"}},[s._v("一、关闭gathering facts功能"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#%E4%BA%8C%E3%80%81%E5%BC%80%E5%90%AFssh-pipelining",target:"_blank",rel:"noopener noreferrer"}},[s._v("二、开启SSH pipelining"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#%E4%B8%89%E3%80%81%E5%BC%80%E5%90%AFssh%E9%95%BF%E8%BF%9E%E6%8E%A5",target:"_blank",rel:"noopener noreferrer"}},[s._v("三、开启SSH长连接"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("三、设置facts缓存\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#31-%E4%BD%BF%E7%94%A8json%E6%96%87%E4%BB%B6%E7%BC%93%E5%AD%98",target:"_blank",rel:"noopener noreferrer"}},[s._v("3.1 使用json文件缓存"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#32-%E4%BD%BF%E7%94%A8redis%E5%AD%98%E5%82%A8facts%E6%96%87%E4%BB%B6%E9%9C%80%E5%AE%89%E8%A3%85redis%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85python%E5%BA%93",target:"_blank",rel:"noopener noreferrer"}},[s._v("3.2 使用redis存储facts文件需安装redis，还需要安装python库"),a("OutboundLink")],1)])])]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#%E5%9B%9B%E3%80%81ansible%E5%8F%96%E6%B6%88%E4%BA%A4%E4%BA%92",target:"_blank",rel:"noopener noreferrer"}},[s._v("四、Ansible取消交互"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lvzhenjiang/p/14386197.html#%E4%BA%94%E3%80%81ansible%E7%9A%84-t%E9%80%89%E9%A1%B9%EF%BC%8C%E6%8F%90%E9%AB%98ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87",target:"_blank",rel:"noopener noreferrer"}},[s._v("五、Ansible的-t选项，提高ansible执行效率"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("最初，ansible的执行效率和saltstack(基于zeromq消息队列的方式)相比要慢的多的多，特别是被控节点量很大的时候。但是ansible发展到现在，它的效率得到了极大的改善。在被控节点不太多的时候，默认的设置已经够快。即使被控节点数量巨大的时候，也可以通过一些优化去极大的提高ansible的执行效率。所以在使用 Ansible 的过程中，当管理的服务器数量增加时，不得不面对一个无法避免的问题执行效率慢，这里列出一些解决办法。")]),s._v(" "),a("h3",{attrs:{id:"一、关闭gathering-facts功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、关闭gathering-facts功能"}},[s._v("#")]),s._v(" 一、关闭gathering facts功能")]),s._v(" "),a("p",[s._v("如果观察过ansible-playbook的执行过程，就会发现ansible-playbook的第1个步骤总是执行gather facts，不论你有没有在playbook设定这个tasks。\n如果你不需要获取被控机器的fact数据的话，就可以关闭获取fact数据功能。关闭之后，可以加快ansible-playbook的执行效率，尤其是你管理很大量的机器时，这非常明显。\n关闭获取facts很简单，只需要在playbook文件中加上"),a("code",[s._v('"gather_facts: False"')]),s._v(" 或者 "),a("code",[s._v('"gather_facts: No"')]),s._v("即可（False和No都为小写也可以）。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" test.yml\n- hosts: test_server\n  remote_user: root\n\n  tasks:\n    - name: this is a "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n      shell: "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"haha"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行这个paly，会发现第一个执行的是gather facts，因为默认是打开gather facts功能的！！！！")]),s._v("\n$ ansible-playbook test.yml\n\nPLAY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("test_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ******************************************************************************************************\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Gathering Facts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" **************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.102"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("this is a test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***************************************************************************************************\nchanged: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.102"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nchanged: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nPLAY RECAP **************************************************************************************************************\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.102                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[a("strong",[s._v("现在关闭gathering facts功能")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" test.yml\n- hosts: test_server\n  remote_user: root\n  gather_facts: False\n\n  tasks:\n    - name: this is a "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n      shell: "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"haha"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再执行这个play，就会发现没有了gathering facts执行过程，整个执行速度也快了！")]),s._v("\n$ ansible-playbook test.yml\n\nPLAY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("test_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ******************************************************************************************************\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("this is a test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***************************************************************************************************\nchanged: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.102"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nchanged: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nPLAY RECAP **************************************************************************************************************\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.102                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h3",{attrs:{id:"二、开启ssh-pipelining"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、开启ssh-pipelining"}},[s._v("#")]),s._v(" 二、开启SSH pipelining")]),s._v(" "),a("p",[s._v("pipeline是openssh的一个特性，"),a("code",[s._v("ssh pipelining")]),s._v(" 是一个加速Ansible执行速度的简单方法。")]),s._v(" "),a("p",[s._v("在ansible执行每个任务的整个流程中，有一个过程是将临时任务文件put到远程的ansible客户机上，然后通过"),a("code",[s._v("ssh")]),s._v("连接过去远程执行这个任务。\n如果开启了pipelining，一个任务的所有动作都在一个"),a("code",[s._v("ssh")]),s._v("会话中完成，也会省去"),a("code",[s._v("sftp")]),s._v("到远端的过程，它会直接将要执行的任务在"),a("code",[s._v("ssh")]),s._v("会话中进行。")]),s._v(" "),a("p",[s._v("ssh``pipelining 默认是关闭!!!!之所以默认关闭是为了兼容不同的"),a("code",[s._v("sudo")]),s._v("配置，主要是 requiretty 选项。如果不使用"),a("code",[s._v("sudo")]),s._v("，建议开启！！！\n打开此选项可以减少ansible执行没有传输时"),a("code",[s._v("ssh")]),s._v("在被控机器上执行任务的连接数。\n不过，如果使用"),a("code",[s._v("sudo")]),s._v("，必须关闭requiretty选项。修改"),a("code",[s._v("/etc/ansible/ansible.cfg")]),s._v(" 文件可以开启pipelining")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/ansible/ansible.cfg\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\npipelining "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" True\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("这样开启了pipelining之后, ansible执行的整个流程就少了一个PUT脚本去远程服务端的流程，然后就可以批量对机器执行命令试下，可以明显感受到速度的提升。")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("但是要注意的是：\n"),a("strong",[s._v("如果在ansible中使用"),a("code",[s._v("sudo")]),s._v("命令的话("),a("code",[s._v("ssh user@host sudo cmd")]),s._v(")，需要在被控节点的"),a("code",[s._v("/etc/sudoers")]),s._v("中禁用"),a("code",[s._v('"requiretty"')]),s._v("!!!!")])]),s._v(" "),a("p",[s._v("之所以要设置"),a("code",[s._v("/etc/sudoers")]),s._v("中的requiretty，是因为"),a("code",[s._v("ssh")]),s._v("远程执行命令时，它的环境是非登录式非交互式shell，默认不会分配"),a("code",[s._v("tty")]),s._v("，没有"),a("code",[s._v("tty")]),s._v("，"),a("code",[s._v("ssh")]),s._v("的"),a("code",[s._v("sudo")]),s._v('就无法关闭密码回显(使用\n"-tt"选项强制SSH分配'),a("code",[s._v("tty")]),s._v(")。所以出于安全考虑，"),a("code",[s._v("/etc/sudoers")]),s._v("中默认是开启requiretty的，它要求只有拥有"),a("code",[s._v("tty")]),s._v("的用户才能使用"),a("code",[s._v("sudo")]),s._v("，也就是说"),a("code",[s._v("ssh")]),s._v("连接过去不允许执行"),a("code",[s._v("sudo")]),s._v("。\n可以通过visudo编辑配置文件，注释该选项来禁用它。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" requiretty /etc/sudoers　　\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Defaults  requiretty")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"三、开启ssh长连接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、开启ssh长连接"}},[s._v("#")]),s._v(" 三、开启SSH长连接")]),s._v(" "),a("p",[s._v("ansible天然支持openssh，默认连接方式下，它对"),a("code",[s._v("ssh")]),s._v("的依赖性非常强。所以优化"),a("code",[s._v("ssh")]),s._v("连接，在一定程度上也在优化ansible。其中一点是开启"),a("code",[s._v("ssh")]),s._v("的长连接，即长时间保持连接状态。")]),s._v(" "),a("p",[s._v("Ansible模式是使用SSH和远程主机进行通信, 所以Ansible对SSH的依赖性非常强, 在OpenSSH 5.6版本以后SSH就支持了Multiplexing（多路复用）。\n所以如果Ansible中控机的SSH -V版本高于5.6时, 就可以使用ControlPersist来提高"),a("code",[s._v("ssh")]),s._v("连接速度，从而提高ansible执行效率。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/redhat-release \nCentOS Linux release "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.6")]),s._v(".1810 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Core"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-V")]),s._v("\nOpenSSH_7.4p1, OpenSSL "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".2k-fips  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/ansible/ansible.cfg\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nssh_args "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ControlMaster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ControlPersist")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5d\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意：ConrolPersist=5d, 这个参数是设置整个长连接保持时间为5天。")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("开启此参数的"),a("code",[s._v("ssh")]),s._v("长连接功能后，在会话过期前会一直建立连接，在"),a("code",[s._v("netstat")]),s._v("的结果中会看到"),a("code",[s._v("ssh")]),s._v("连接是一直established状态，且通过SSH连接过的设备都会在当前用户家目录的\n"),a("code",[s._v('".ansible/cp"')]),s._v("目录下生成一个socket文件，每个会话对应生成一个socket文件。也可以通过"),a("code",[s._v("netstat")]),s._v("命令查看, 会发现有一个ESTABLISHED状态的连接一直与远程设备进行着TCP连接。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ansible\nroot      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26064")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":32 ?        00:00:00 ssh: /root/.ansible/cp/cb9972d2a5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nroot      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26067")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":32 ?        00:00:00 ssh: /root/.ansible/cp/baefa88ac8 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" /root\nroot      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26064")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":32 ?        00:00:00 ssh: /root/.ansible/cp/cb9972d2a5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nroot      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26067")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":32 ?        00:00:00 ssh: /root/.ansible/cp/baefa88ac8 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /root/.ansible/cp/\nbaefa88ac8  cb9972d2a5\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("需要注意：\nControlPersist 特性需要高版本的SSH才支持，CentOS 6默认是不支持的，如果需要使用，需要自行升级openssh（确保SSH -V版本高于5.6）。\nControlPersist即持久化socket，一次验证，多次通信。并且只需要修改 "),a("code",[s._v("ssh")]),s._v(" 客户端就行，也就是 Ansible 机器即可。")]),s._v(" "),a("h3",{attrs:{id:"三、设置facts缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、设置facts缓存"}},[s._v("#")]),s._v(" 三、设置facts缓存")]),s._v(" "),a("p",[s._v("如果细心的话, 就会发现执行playbook的时候, 默认第一个task都是GATHERING FACTS, 这个过程就是Ansible在收集每台主机的facts信息。\n方便我们在playbook中直接饮用facts里的信息，当然如果你的playbook中不需要facts信息, 可以在playbook中设置"),a("code",[s._v('"gather_facts: False"')]),s._v("来提高playbook效率.")]),s._v(" "),a("p",[s._v("但是如果我们既想在每次执行playbook的时候都能收集facts, 又想加速这个收集过程, 那么就需要配置facts缓存了。")]),s._v(" "),a("h4",{attrs:{id:"_3-1-使用json文件缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-使用json文件缓存"}},[s._v("#")]),s._v(" 3.1 使用json文件缓存")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/ansible/ansible.cfg\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ngathering "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" smart\nfact_caching_timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86400")]),s._v("\nfact_caching "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jsonfile\nfact_caching_connection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /dev/shm/ansible_fact_cache\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正常配置palybook，不需要关闭gathering facts功能")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" test.yml \n---\n- hosts: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101\n  remote_user: root\n  vars:\n    - list: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,2")]),s._v(",3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  tasks:\n    - name: this is loop\n      debug: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item }}"')]),s._v("\n      with_items: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{list}}'")]),s._v("\n\n查看这个playbook过程，用时6.699s（第一次可能稍微慢点，缓存之后，后面执行就很快了）\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" ansible-playbook test.yml \n\nPLAY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *******************************************************************************************************************************\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Gathering Facts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" **************************************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("this is loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *****************************************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nPLAY RECAP **************************************************************************************************************************************\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   \n\n\nreal    0m6.699s\nuser    0m1.301s\nsys     0m0.250s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果去掉上面的facts缓存的四行配置，再次执行上面的playbok，发现用时10s左右！！！")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看缓存文件")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /dev/shm/ansible_fact_cache/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br")])]),a("h4",{attrs:{id:"_3-2-使用redis存储facts文件需安装redis-还需要安装python库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-使用redis存储facts文件需安装redis-还需要安装python库"}},[s._v("#")]),s._v(" 3.2 使用redis存储facts文件需安装redis，还需要安装python库")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis\n$ yum "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" epel-release\n$ yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" python-pip\n$ pip "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/ansible/ansible.cfg\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\ngathering "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" smart\nfacts_caching_timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86400")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置缓存过期时间86400秒")]),s._v("\nfacts_caching "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 使用redis或者 (或者使用memcached，即"facts_caching = memcached")')]),s._v("\nfact_caching_connection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6379\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#若redis设置了密码,比如密码为"admin"，则配置修改如下：')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fact_caching_connection = localhost:6379:0:admin")]),s._v("\n\n$ systemctl start redis\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i:6379")]),s._v("\nCOMMAND     PID  "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("   FD   TYPE DEVICE SIZE/OFF NODE NAME\nredis-ser "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26593")]),s._v(" redis    4u  IPv4 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("125427")]),s._v("      0t0  TCP localhost:6379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LISTEN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" ansible-playbook test.yml \n\nPLAY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *******************************************************************************************************************************\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Gathering Facts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" **************************************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("this is loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *****************************************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nPLAY RECAP **************************************************************************************************************************************\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   \n\n\nreal    0m6.720s\nuser    0m1.219s\nsys        0m0.338s\n\n需要注意：\n在使用redis缓存后，如果出现异常（若未出现，请忽略）：TypeError: the JSON object must be str, not "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'bytes'")]),s._v("。\n解决办法：\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" / "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" ansible\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/lib/python2.7/site-packages/ansible/plugins/cache/redis.py\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nself._cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" json.loads"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value.decode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'utf-8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为这个")]),s._v("\n\n查看redis存储情况\n$ redis-cli\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" keys *\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ansible_facts10.4.7.101"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ansible_cache_keys"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br")])]),a("p",[s._v("总之：不同网络环境下的耗时肯定是不同的，但是设置缓存是肯定可以加快 Ansible 运行速度的，特别是 playbook 的运行。")]),s._v(" "),a("h3",{attrs:{id:"四、ansible取消交互"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、ansible取消交互"}},[s._v("#")]),s._v(" 四、Ansible取消交互")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/ansible/ansible.cfg\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nhost_key_checking "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" False          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打开注释即可")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消ssh的yes和no的交互：")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /root/.ssh/config\nUserKnownHostsFile /dev/null\nConnectTimeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\nStrictHostKeyChecking no\n\n或者直接ssh时增加一个参数\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("StrictHostKeyChecking")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p22")]),s._v(" root@10.4.7.101\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h3",{attrs:{id:"五、ansible的-t选项-提高ansible执行效率"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、ansible的-t选项-提高ansible执行效率"}},[s._v("#")]),s._v(" 五、Ansible的-t选项，提高ansible执行效率")]),s._v(" "),a("p",[s._v("ansible的"),a("code",[s._v('"-t"')]),s._v("或"),a("code",[s._v('"--tree"')]),s._v("选项是将ansible的执行结果按主机名保存在指定目录下的文件中。")]),s._v(" "),a("p",[s._v("有些时候，ansible执行起来的速度会非常慢，这种慢体现在即使执行的是一个立即返回的简单命令(如"),a("code",[s._v("ping")]),s._v("模块)，也会耗时很久，且不是因为"),a("code",[s._v("ssh")]),s._v("连接慢导致的。\n如果使用-t选项，将第一次执行得到的结果按inventory中定义的主机名保存在文件中，下次执行到同一台主机时速度将会变快很多，即使之后不再加上-t选项，\n也可以在一定时间内保持迅速执行。即使执行速度正常（如执行一个Ping命令0.7秒左右），使用-t选项也可以在此基础上变得更快。")]),s._v(" "),a("p",[s._v("除了使用-t选项，使用重定向将结果重定向到某个文件中也是一样的效果。\n这也算是一种ansible提速方式，但在centos6上使用低版本ansible时，有时会出现执行很慢的现象，但不是每次都这样，且centos7执行速度正常\n所以这也是一种"),a("code",[s._v('"bug"')]),s._v("式问题，故这种方式没有通用性。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" ansible test_server "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostname"')]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" ansible test_server "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostname"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" /tmp/test\n\n$ ll /tmp/test/\n总用量 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n-rw-r--r--. "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("236")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("月   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.101\n-rw-r--r--. "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("307")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("月   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.102\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("上面做了对比，发现使用-t或重定向方式，将ansible的执行结果按主机名保存在指定目录下的文件中，ansible执行效率会有所提升。")]),s._v(" "),a("p",[s._v("*************** 当你发现自己的才华撑不起野心时，就请安静下来学习吧！***************")])])}),[],!1,null,null,null);a.default=e.exports}}]);