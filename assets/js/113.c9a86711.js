(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{466:function(t,s,a){"use strict";a.r(s);var e=a(0),r=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("ES支持快照功能，用于实现数据的备份与恢复。我们可以生成单个索引或整个集群的快照，并将其存储在共享文件系统上的存储库中，并且有一些插件支持 S3、HDFS、Azure、Google Cloud Storage 等上的远程存储库。")])]),t._v(" "),s("p",[t._v("因为minio兼容S3，而es支持将快照存储在远程S3存储服务中，因此实验以minio为例演示es的快照备份与恢复。")]),t._v(" "),s("h1",{attrs:{id:"部署minio"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署minio"}},[t._v("#")]),t._v(" 部署minio")]),t._v(" "),s("h2",{attrs:{id:"部署说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署说明"}},[t._v("#")]),t._v(" 部署说明")]),t._v(" "),s("p",[t._v("为了方便起见，本示例仅使用一台minio节点docker方式部署。在实际生产环境中，强烈建议使用二进制方式部署4台及以上节点的minio集群，提高容错率和服务可用性。")]),t._v(" "),s("h2",{attrs:{id:"docker部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker部署"}},[t._v("#")]),t._v(" docker部署")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir /data/minio")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# docker run -d -p 9000:9000 -p 9090:9090 --name minio -v /data/minio:/data -e "MINIO_ROOT_USER=root" -e "MINIO_ROOT_PASSWORD=1234qwer" --restart always quay.io/minio/minio server /data --console-address ":9090"')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h2",{attrs:{id:"访问测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#访问测试"}},[t._v("#")]),t._v(" 访问测试")]),t._v(" "),s("p",[t._v("访问http://192.168.10.132:9090 用户名为root 密码为1234qwer。")]),t._v(" "),s("h1",{attrs:{id:"创建bucket和access-key"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建bucket和access-key"}},[t._v("#")]),t._v(" 创建bucket和Access Key")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/0c426e542ef10327.jpg",alt:"0c426e542ef10327.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"创建bucket"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建bucket"}},[t._v("#")]),t._v(" 创建bucket")]),t._v(" "),s("p",[t._v("创建一个名为es-backup的bucket，并设置容量上限为1TB")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/2a0b52564eb6f9ad.jpg",alt:"2a0b52564eb6f9ad.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"创建access-key"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建access-key"}},[t._v("#")]),t._v(" 创建Access Key")]),t._v(" "),s("p",[t._v("创建access key并牢记，后续使用。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/5a8910b8db4aa290.jpg",alt:"5a8910b8db4aa290.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"创建访问控制权限"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建访问控制权限"}},[t._v("#")]),t._v(" 创建访问控制权限")]),t._v(" "),s("p",[t._v("Minio 的存储桶默认是不跟任何 Access Key 关联的，也就是说所有Access Key均可访问该bucket，这在实际生产环境中存在权限过大的问题。不过由于 Minio 支持标准的 S3 协议，我们可以给 Access Key 授予某个 Bucket 存储桶的访问权限，实现 Key 和 Bucket 的绑定。"),s("br"),t._v("\n创建policy")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/70d85dd1de3456e6.jpg",alt:"70d85dd1de3456e6.jpg"}})]),t._v(" "),s("p",[t._v("设置权限")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Version"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2012-10-17"')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Statement"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Effect"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow"')]),t._v(",\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Action"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3:ListAllMyBuckets"')]),t._v(",\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3:ListBucket"')]),t._v(",\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3:GetBucketLocation"')]),t._v(",\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3:GetObject"')]),t._v(",\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3:PutObject"')]),t._v(",\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3:DeleteObject"')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Resource"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"arn:aws:s3:::es-backup/*"')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])]),s("p",[t._v("创建user"),s("br"),t._v("\n这里 Access Key 是用户名，Access Secret 是对应的口令。设置时关联上刚才创建的 Policy 即可")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/c2c0e833ab5e478b.jpg",alt:"c2c0e833ab5e478b.jpg"}})]),t._v(" "),s("p",[t._v("我们就创建了一个新的存储桶，并且给这个存储桶设置了一个用户，同时授权了用户对存储桶的访问，包括列表、上传、下载这几个基本权限。")]),t._v(" "),s("h1",{attrs:{id:"配置es以支持minio备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置es以支持minio备份"}},[t._v("#")]),t._v(" 配置es以支持minio备份")]),t._v(" "),s("blockquote",[s("p",[t._v("以下操作在每个ES节点都要执行")])]),t._v(" "),s("h2",{attrs:{id:"安装s3插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装s3插件"}},[t._v("#")]),t._v(" 安装S3插件")]),t._v(" "),s("blockquote",[s("p",[t._v("在es8之前需要手动安装，8之后无需安装。")])]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /usr/share/elasticsearch/bin/elasticsearch-plugin install repository-s3 ")]),t._v("\n-"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Installing repository-s3\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("repository-s3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" is no longer a plugin but instead a module packaged with this distribution of Elasticsearch\n-"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Please restart Elasticsearch to activate any plugins installed\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h2",{attrs:{id:"添加s3地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加s3地址"}},[t._v("#")]),t._v(" 添加S3地址")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim /etc/elasticsearch/elasticsearch.yml")]),t._v("\ns3.client.default.endpoint: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.132:9000 "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# minio服务地址+端口")]),t._v("\ns3.client.default.protocol: http "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 非https时需要指定")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("h2",{attrs:{id:"添加access-key至密钥库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加access-key至密钥库"}},[t._v("#")]),t._v(" 添加Access key至密钥库")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /usr/share/elasticsearch/bin/elasticsearch-keystore add s3.client.default.access_key")]),t._v("\nEnter value "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" s3.client.default.access_key: \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /usr/share/elasticsearch/bin/elasticsearch-keystore add s3.client.default.secret_key")]),t._v("\nEnter value "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" s3.client.default.secret_key: \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h2",{attrs:{id:"重启es服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重启es服务"}},[t._v("#")]),t._v(" 重启es服务")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@es-fleet2 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart elasticsearch")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h1",{attrs:{id:"备份恢复验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#备份恢复验证"}},[t._v("#")]),t._v(" 备份恢复验证")]),t._v(" "),s("h2",{attrs:{id:"创建快照仓库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建快照仓库"}},[t._v("#")]),t._v(" 创建快照仓库")]),t._v(" "),s("p",[t._v("登录kibana——>点击菜单按钮——>Stack Management——>拍摄快照并还原——>存储库——>注册存储库，然后设置名称并选择类型为AWS S3")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/b49e4d2bba667d2e.jpg",alt:"b49e4d2bba667d2e.jpg"}})]),t._v(" "),s("p",[t._v("填写存储桶名称为es-backup，其他保持默认即可")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/882b64794374e689.jpg",alt:"882b64794374e689.jpg"}})]),t._v(" "),s("p",[t._v("注册完成后点击验证存储库，显示已连接。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/9643f0a15844429e.jpg",alt:"9643f0a15844429e.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"创建数据策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建数据策略"}},[t._v("#")]),t._v(" 创建数据策略")]),t._v(" "),s("p",[t._v("接下来，我们以导入的"),s("strong",[t._v("kibana_sample_data_flights")]),t._v("索引为例，演示数据的备份与恢复。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/99a2ebf08a77cfcf.jpg",alt:"99a2ebf08a77cfcf.jpg"}})]),t._v(" "),s("p",[t._v("创建备份策略，名称自定义，快照表达式填写<kibana_sample_data_flights-{now/d}>")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/1d7c53f65158add4.jpg",alt:"1d7c53f65158add4.jpg"}})]),t._v(" "),s("p",[t._v("选择索引为kibana_sample_data_flights")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/34d25275ce3b717b.jpg",alt:"34d25275ce3b717b.jpg"}})]),t._v(" "),s("p",[t._v("设置快照保留策略")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/07183b2cb604a6c2.jpg",alt:"07183b2cb604a6c2.jpg"}})]),t._v(" "),s("p",[t._v("备份策略创建后，界面如下所示")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/04a1746d5f170d9f.jpg",alt:"04a1746d5f170d9f.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"数据备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据备份"}},[t._v("#")]),t._v(" 数据备份")]),t._v(" "),s("p",[t._v("创建完策略后，es会在每天8点自动将数据上传至minIO增量备份，我们也可以点击立即执行，手动触发一次备份任务操作。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/a9895eb354657fab.jpg",alt:"a9895eb354657fab.jpg"}})]),t._v(" "),s("p",[t._v("点击立即执行后，查看快照信息，显示已备份完成。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/9b2f06d81f53c25c.jpg",alt:"9b2f06d81f53c25c.jpg"}})]),t._v(" "),s("p",[t._v("查看minIO的bucket信息，发现已成功上传数据")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/ed0a5f888cbe73d8.jpg",alt:"ed0a5f888cbe73d8.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"数据恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据恢复"}},[t._v("#")]),t._v(" 数据恢复")]),t._v(" "),s("p",[t._v("接下来删除index，模拟误操作情况发生。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/c8fedd844ffa7ebe.jpg",alt:"c8fedd844ffa7ebe.jpg"}})]),t._v(" "),s("p",[t._v("在快照菜单点击恢复按钮，执行恢复操作")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/fcc4f39c074e7e82.jpg",alt:"fcc4f39c074e7e82.jpg"}})]),t._v(" "),s("p",[t._v("使用默认选项还原即可")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/3e55982dd7035da9.jpg",alt:"3e55982dd7035da9.jpg"}})]),t._v(" "),s("p",[t._v("查看还原状态显示已完成")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/c0790ffb7a2fd7e6.jpg",alt:"c0790ffb7a2fd7e6.jpg"}})]),t._v(" "),s("p",[t._v("接下来打开索引管理，发现index已正常还原，且文档数、分片数、存储大小等信息与先前保持一致。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2024/03/0fa20ad526b88250.jpg",alt:"0fa20ad526b88250.jpg"}})]),t._v(" "),s("h2",{attrs:{id:"快照删除注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#快照删除注意事项"}},[t._v("#")]),t._v(" 快照删除注意事项")]),t._v(" "),s("p",[t._v("如果需要删除快照，一定要使用kibana或者用 API 删除快照，而不能用其他机制（比如手动删除，或者使用S3定期删除策略）。因为快照是增量备份，后面的快照数据依赖先前的文件。delete API 知道哪些数据还在被近期快照使用，只删除不再被使用的那部分数据。")]),t._v(" "),s("hr"),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.cuiliangblog.cn/detail/article/60",target:"_blank",rel:"noopener noreferrer"}},[t._v("原文链接"),s("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=r.exports}}]);