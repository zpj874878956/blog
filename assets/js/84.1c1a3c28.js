(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{439:function(s,a,t){"use strict";t.r(a);var e=t(0),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"二进制安装k8s-1-20"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二进制安装k8s-1-20"}},[s._v("#")]),s._v(" 二进制安装k8s 1.20")]),s._v(" "),a("h3",{attrs:{id:"一、集群环境说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、集群环境说明"}},[s._v("#")]),s._v(" 一、集群环境说明")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[s._v("主机名")]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("IP地址")]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("说明")])])]),s._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("k8s-master01")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.4.7.107")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("master节点")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("k8s-master02")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.4.7.108")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("master节点")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("k8s-master03")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.4.7.109")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("master节点")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("k8s-master-lb（在master节点）")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.4.7.236")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("keepalived虚拟IP")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("k8s-node01")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.4.7.110")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("worker节点")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("k8s-node02")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.4.7.111")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("worker节点")])])])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[a("strong",[s._v("配置信息")])]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("备注")])])]),s._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("系统版本")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("CentOS 7.9")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("Docker版本")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("19.03.x")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("Pod网段")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("172.168.0.0/12")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("Service网段")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("10.96.0.0/12")])])])]),s._v(" "),a("p",[s._v("注意：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("VIP（虚拟IP）不要和公司内网IP重复，首先去ping一下，不通才可用。VIP需要和主机在同一个局域网内！\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"二、基础环境配置-以下操作所有节点都得执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、基础环境配置-以下操作所有节点都得执行"}},[s._v("#")]),s._v(" 二、基础环境配置（以下操作所有节点都得执行）")]),s._v(" "),a("h4",{attrs:{id:"_2-1、配置hosts解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、配置hosts解析"}},[s._v("#")]),s._v(" 2.1、配置hosts解析")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("hostnamectl set-hostname k8s-master01\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("hostname")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EFO \n10.4.7.107 k8s-master01\n10.4.7.108 k8s-master02\n10.4.7.109 k8s-master03\n10.4.7.236 k8s-master-lb\n10.4.7.110 k8s-node01\n10.4.7.111 k8s-node02\nEFO")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("说明：10.4.7.236 k8s-master-lb # 如果不是高可用集群，该IP为Master01的IP")]),s._v(" "),a("h4",{attrs:{id:"_2-2、更换yum源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、更换yum源码"}},[s._v("#")]),s._v(" 2.2、更换yum源码")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo\n\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" yum-utils device-mapper-persistent-data lvm2\n\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/yum.repos.d/kubernetes.repo")]),s._v("\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/mirrors.cloud.aliyuncs.com/d'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/mirrors.aliyuncs.com/d'")]),s._v(" /etc/yum.repos.d/CentOS-Base.repo\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h4",{attrs:{id:"_2-3、安装常用工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、安装常用工具"}},[s._v("#")]),s._v(" 2.3、安装常用工具")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" jq psmisc "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" net-tools telnet yum-utils device-mapper-persistent-data lvm2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" lrzsz "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_2-4、关闭防火墙、selinux、dnsmasq、swap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4、关闭防火墙、selinux、dnsmasq、swap"}},[s._v("#")]),s._v(" 2.4、关闭防火墙、selinux、dnsmasq、swap")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl disable "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" firewalld \nsystemctl disable "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" dnsmasq\nsystemctl disable "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" NetworkManager\n\nsetenforce "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s#SELINUX=enforcing#SELINUX=disabled#g'")]),s._v(" /etc/sysconfig/selinux\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s#SELINUX=enforcing#SELINUX=disabled#g'")]),s._v(" /etc/selinux/config\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭swap分区")]),s._v("\nswapoff "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sysctl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("vm.swappiness")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ri")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/^[^#]*swap/s@^@#@'")]),s._v(" /etc/fstab\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h4",{attrs:{id:"_2-5、时间同步配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5、时间同步配置"}},[s._v("#")]),s._v(" 2.5、时间同步配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装ntpdate")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ntpdate "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更改时区")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sf")]),s._v(" /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置定时任务同步时间")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Asia/Shanghai'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/etc/timezone\nntpdate time2.aliyun.com\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入到crontab")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v("\n*/5 * * * * ntpdate time2.aliyun.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h4",{attrs:{id:"_2-6、优化linux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-6、优化linux"}},[s._v("#")]),s._v(" 2.6、优化Linux")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-SHn")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/security/limits.conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 末尾添加如下内容")]),s._v("\n* soft nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n* hard nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n* soft nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655350")]),s._v("\n* hard nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655350")]),s._v("\n* soft memlock unlimited\n* hard memlock unlimited\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 然后重启Linux")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("不做，2.7、所有节点升级系统并重启，此处升级没有升级内核，下节会单独升级内核：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CentOS7需要升级，CentOS8可以按需升级系统")]),s._v("\nyum update "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--exclude")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kernel* "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"三、内核升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、内核升级"}},[s._v("#")]),s._v(" 三、内核升级")]),s._v(" "),a("h4",{attrs:{id:"_3-1、配置免密登录-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、配置免密登录-master01上"}},[s._v("#")]),s._v(" 3.1、配置免密登录（Master01上）")]),s._v(" "),a("p",[s._v("Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一直回车就行")]),s._v("\nssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" rsa \n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" ssh-copy-id "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" .ssh/id_rsa.pub "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_3-2、下载安装所有的源码文件-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2、下载安装所有的源码文件-master01上"}},[s._v("#")]),s._v(" 3.2、下载安装所有的源码文件：（Master01上）")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /root/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/dotbalo/k8s-ha-install.git\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /root/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone git@git.zhlh6.cn:dotbalo/k8s-ha-install.git\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_3-3、下载升级所需安装包-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3、下载升级所需安装包-master01上"}},[s._v("#")]),s._v(" 3.3、下载升级所需安装包（Master01上）")]),s._v(" "),a("p",[s._v("CentOS7 需要升级内核至4.18+，本地升级的版本为4.19")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在master01节点下载内核")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /root\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从master01节点传到其他节点：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" k8s-master02 k8s-master03 k8s-node01 k8s-node02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(":/root/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"_3-4、内核升级-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4、内核升级-所有节点"}},[s._v("#")]),s._v(" 3.4、内核升级（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装内核")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /root "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum localinstall "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" kernel-ml*\ngrub2-set-default  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" grub2-mkconfig "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" /etc/grub2.cfg\ngrubby "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--args")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_namespace.enable=1"')]),s._v(" --update-kernel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("grubby --default-kernel"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查默认内核是不是4.19")]),s._v("\ngrubby --default-kernel /boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点重启，然后检查内核是不是4.19")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node02 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# uname -a")]),s._v("\nLinux k8s-node02 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.19")]),s._v(".12-1.el7.elrepo.x86_64 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1 SMP Fri Dec 21 11:06:36 EST 2018 x86_64 x86_64 x86_64 GNU/Linux")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"_3-5、安装ipvsadm-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5、安装ipvsadm-所有节点"}},[s._v("#")]),s._v(" 3.5、安装ipvsadm（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ipvsadm ipset sysstat conntrack libseccomp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入以下内容")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/modules-load.d/ipvs.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EFO\nip_vs\nip_vs_lc\nip_vs_wlc\nip_vs_rr\nip_vs_wrr\nip_vs_lblc\nip_vs_lblcr\nip_vs_dh\nip_vs_sh\nip_vs_fo\nip_vs_nq\nip_vs_sed\nip_vs_ftp\nip_vs_sh\nnf_conntrack\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\nEFO")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 然后执行")]),s._v("\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" systemd-modules-load.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("h4",{attrs:{id:"_3-6、开启一些k8s集群中必须的内核参数-配置k8s内核-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6、开启一些k8s集群中必须的内核参数-配置k8s内核-所有节点"}},[s._v("#")]),s._v(" 3.6、开启一些k8s集群中必须的内核参数，配置k8s内核（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/sysctl.d/k8s.conf")]),s._v("\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nfs.may_detach_mounts = 1\nvm.overcommit_memory=1\nvm.panic_on_oom=0\nfs.inotify.max_user_watches=89100\nfs.file-max=52706963\nfs.nr_open=52706963\nnet.netfilter.nf_conntrack_max=2310720\nnet.ipv4.tcp_keepalive_time = 600\nnet.ipv4.tcp_keepalive_probes = 3\nnet.ipv4.tcp_keepalive_intvl =15\nnet.ipv4.tcp_max_tw_buckets = 36000\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_max_orphans = 327680\nnet.ipv4.tcp_orphan_retries = 3\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.ip_conntrack_max = 65536\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.tcp_timestamps = 0\nnet.core.somaxconn = 16384\nEOF")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点配置完内核后，重启服务器，保证重启后内核依旧加载")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsmod | grep --color=auto -e ip_vs -e nf_conntrack")]),s._v("\nip_vs_ftp              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nnf_nat                 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32768")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" ip_vs_ftp\nip_vs_sed              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_nq               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_fo               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_sh               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_dh               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_lblcr            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_lblc             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_wrr              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_rr               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_wlc              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs_lc               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nip_vs                 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("151552")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp\nnf_conntrack          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("143360")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" nf_nat,ip_vs\nnf_defrag_ipv6         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20480")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" nf_conntrack\nnf_defrag_ipv4         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" nf_conntrack\nlibcrc32c              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" nf_conntrack,nf_nat,xfs,ip_vs\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br")])]),a("h3",{attrs:{id:"四、docker安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、docker安装"}},[s._v("#")]),s._v(" 四、Docker安装")]),s._v(" "),a("h4",{attrs:{id:"_4-1、安装docker-ce-19-03-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1、安装docker-ce-19-03-所有节点"}},[s._v("#")]),s._v(" 4.1、安装Docker-ce 19.03（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" docker-ce-19.03.* "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"_4-1-1温馨提示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1温馨提示"}},[s._v("#")]),s._v(" 4.1.1温馨提示：")]),s._v(" "),a("p",[s._v("由于新版kubelet建议使用systemd，所以可以把docker的CgroupDriver改成systemd")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /etc/docker\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/docker/daemon.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "exec-opts": ["native.cgroupdriver=systemd"]\n}\nEOF')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h5",{attrs:{id:"_4-1-2、所有节点设置开机自启动docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2、所有节点设置开机自启动docker"}},[s._v("#")]),s._v(" 4.1.2、所有节点设置开机自启动Docker")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"五、k8s及etcd安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、k8s及etcd安装"}},[s._v("#")]),s._v(" 五、K8s及etcd安装")]),s._v(" "),a("h4",{attrs:{id:"_5-1、下载kubernetes安装包-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1、下载kubernetes安装包-master01上"}},[s._v("#")]),s._v(" 5.1、下载kubernetes安装包（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意目前版本是1.20.0，你们安装时需要下载最新的1.20.x版本：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget https://dl.k8s.io/v1.20.0/kubernetes-server-linux-amd64.tar.gz")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_5-2、下载etcd安装包-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2、下载etcd安装包-master01上"}},[s._v("#")]),s._v(" 5.2、下载etcd安装包（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_5-3、解压kubernetes-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3、解压kubernetes-master01上"}},[s._v("#")]),s._v(" 5.3、解压kubernetes（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-xf")]),s._v(" kubernetes-server-linux-amd64.tar.gz  --strip-components"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" /usr/local/bin kubernetes/server/bin/kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("let,ctl,-apiserver,-controller-manager,-scheduler,-proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_5-4、解压etcd-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-4、解压etcd-master01上"}},[s._v("#")]),s._v(" 5.4、解压etcd（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxvf")]),s._v(" etcd-v3.4.13-linux-amd64.tar.gz --strip-components"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" /usr/local/bin etcd-v3.4.13-linux-amd64/etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(",ctl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_5-5、版本查看-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-5、版本查看-master01上"}},[s._v("#")]),s._v(" 5.5、版本查看（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubelet --version")]),s._v("\nKubernetes v1.20.0\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etcdctl version")]),s._v("\netcdctl version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".13\nAPI version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_5-6、将组件发送到其他节点-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-6、将组件发送到其他节点-master01上"}},[s._v("#")]),s._v(" 5.6、将组件发送到其他节点（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MasterNodes='k8s-master02 k8s-master03'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# WorkNodes='k8s-node01 k8s-node02'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for NODE in $MasterNodes; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for NODE in $WorkNodes; do     scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"_5-7、创建-opt-cni-bin目录-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-7、创建-opt-cni-bin目录-所有节点"}},[s._v("#")]),s._v(" 5.7、创建/opt/cni/bin目录（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /opt/cni/bin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_5-8、切换分支-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-8、切换分支-master01上"}},[s._v("#")]),s._v(" 5.8、切换分支（Master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到1.20.x分支（其他版本可以切换到其他分支）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看所有分支")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd k8s-ha-install/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 k8s-ha-install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git branch -a")]),s._v("\n* master\n  remotes/origin/HEAD -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" origin/master\n  remotes/origin/manual-installation\n  remotes/origin/manual-installation-v1.16.x\n  remotes/origin/manual-installation-v1.17.x\n  remotes/origin/manual-installation-v1.18.x\n  remotes/origin/manual-installation-v1.19.x\n  remotes/origin/manual-installation-v1.20.x\n  remotes/origin/master\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换分之")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" checkout manual-installation-v1.20.x\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成证书所需文件，如下所示")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 k8s-ha-install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nbootstrap  calico  CoreDNS  dashboard  kube-proxy  metrics-server-0.4.x  metrics-server-0.4.x-kubeadm  pki  snapshotter\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h3",{attrs:{id:"六、生成证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、生成证书"}},[s._v("#")]),s._v(" 六、生成证书")]),s._v(" "),a("p",[s._v("二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的")]),s._v(" "),a("h4",{attrs:{id:"_6-1、下载生成证书工具-master01"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1、下载生成证书工具-master01"}},[s._v("#")]),s._v(" 6.1、下载生成证书工具（Master01）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" /usr/local/bin/cfssl\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" /usr/local/bin/cfssljson\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /root\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv cfssl_linux-amd64 /usr/local/bin/cfssl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv cfssljson_linux-amd64  /usr/local/bin/cfssljson")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_6-2、生成etcd证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2、生成etcd证书"}},[s._v("#")]),s._v(" 6.2、生成etcd证书")]),s._v(" "),a("h5",{attrs:{id:"_6-2-1、创建etcd证书目录-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1、创建etcd证书目录-所有master节点"}},[s._v("#")]),s._v(" 6.2.1、创建etcd证书目录（所有Master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /etc/etcd/ssl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"_6-2-1、创建kubernetes证书目录-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1、创建kubernetes证书目录-所有节点"}},[s._v("#")]),s._v(" 6.2.1、创建kubernetes证书目录（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /etc/kubernetes/pki\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"_6-2-3、生成etcd证书-master01节点-将证书复制到其他节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-3、生成etcd证书-master01节点-将证书复制到其他节点"}},[s._v("#")]),s._v(" 6.2.3、生成etcd证书（Master01节点）将证书复制到其他节点")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/pki")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成etcd CA证书和CA证书的key")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 01:58:02 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating a new CA key and certificate from CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 01:58:02 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 01:58:02 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 01:58:02 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 01:58:03 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 01:58:03 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("140198241947074029848239512164671290627608591138")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以在-hostname 参数后面预留几个ip，方便日后扩容")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert \\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   -ca-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-ca-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-hostname")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,k8s-master01,k8s-master02,k8s-master03,10.4.7.107,10.4.7.108,10.4.7.109 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-profile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   etcd-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" /etc/etcd/ssl/etcd\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:00:04 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:00:04 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:00:04 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:00:05 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:00:05 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("470467884878418179395781489624244078991295464856")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h5",{attrs:{id:"_6-2-3、将证书复制到其他节点-master01节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-3、将证书复制到其他节点-master01节点"}},[s._v("#")]),s._v(" 6.2.3、将证书复制到其他节点（Master01节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterNodes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master02 k8s-master03'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WorkNodes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-node01 k8s-node02'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterNodes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mkdir -p /etc/etcd/ssl"')]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /etc/etcd/ssl/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/etcd/ssl/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h4",{attrs:{id:"_6-3、k8s组件证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3、k8s组件证书"}},[s._v("#")]),s._v(" 6.3、k8s组件证书")]),s._v(" "),a("h5",{attrs:{id:"_6-3-1、生成kubernetes证书-master-01节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-1、生成kubernetes证书-master-01节点"}},[s._v("#")]),s._v(" 6.3.1、生成kubernetes证书（Master 01节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/pki")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:05:33 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating a new CA key and certificate from CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:05:33 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:05:33 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:05:33 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:05:34 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:05:34 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("41601140313910114593243737048758611445671732018")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 10.96.0.1是k8s service的网段，如果说需要更改k8s service网段，那就需要更改10.96.0.1，")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果不是高可用集群，10.4.7.236为Master01的IP")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert   -ca=/etc/kubernetes/pki/ca.pem   -ca-key=/etc/kubernetes/pki/ca-key.pem   -config=ca-config.json -hostname=10.96.0.1,10.4.7.236,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,10.4.7.107,10.4.7.108,10.4.7.109   -profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:07:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:07:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:07:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:07:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:07:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("538625498609814572541825087295197801303230523180")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h5",{attrs:{id:"_6-3-2、生成apiserver的聚合证书-master-01节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-2、生成apiserver的聚合证书-master-01节点"}},[s._v("#")]),s._v(" 6.3.2、生成apiserver的聚合证书（Master 01节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:08:45 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating a new CA key and certificate from CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:08:45 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:08:45 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:08:45 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:08:46 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:08:46 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("614553480240998616305316696839282255811191572397")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 返回结果（忽略警告）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:09:23 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:09:23 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:09:23 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:09:23 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:09:23 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("525521597243375822253206665544676632452020336672")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:09:23 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" This certificate lacks a "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hosts"')]),s._v(" field. This makes it unsuitable "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v("\nwebsites. For "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information see the Baseline Requirements "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("https://cabforum.org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nspecifically, section "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.2")]),s._v(".3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Information Requirements"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h5",{attrs:{id:"_6-3-3、生成controller-manage的证书-master01节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-3、生成controller-manage的证书-master01节点"}},[s._v("#")]),s._v(" 6.3.3、生成controller-manage的证书（Master01节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl gencert \\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   -ca-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-profile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   manager-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" /etc/kubernetes/pki/controller-manager\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:10:59 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:10:59 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:10:59 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:10:59 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:10:59 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("90004917734039884153079426464391358123145661914")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:10:59 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" This certificate lacks a "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hosts"')]),s._v(" field. This makes it unsuitable "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v("\nwebsites. For "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information see the Baseline Requirements "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("https://cabforum.org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nspecifically, section "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.2")]),s._v(".3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Information Requirements"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# set-cluster：设置一个集群项,10.4.7.236是VIP")]),s._v("\nkubectl config set-cluster kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --certificate-authority"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.236:8443 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/controller-manager.kubeconfig\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nCluster "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubernetes"')]),s._v(" set.\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置一个环境项，一个上下文")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config set-context system:kube-controller-manager@kubernetes \\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-controller-manager "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/controller-manager.kubeconfig \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nContext "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:kube-controller-manager@kubernetes"')]),s._v(" created.\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# set-credentials 设置一个用户项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config set-credentials system:kube-controller-manager \\")]),s._v("\n     --client-certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/controller-manager.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --client-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/controller-manager-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/controller-manager.kubeconfig\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nUser "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:kube-controller-manager"')]),s._v(" set.\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用某个环境当做默认环境")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config use-context system:kube-controller-manager@kubernetes \\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/controller-manager.kubeconfig\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nSwitched to context "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:kube-controller-manager@kubernetes"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成scheduler证书")]),s._v("\ncfssl gencert "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   -ca-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-profile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   scheduler-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" /etc/kubernetes/pki/scheduler\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:16:12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:16:12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:16:12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:16:12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:16:12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("74188665800103042050582037108256409976332653077")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/21 02:16:12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" This certificate lacks a "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hosts"')]),s._v(" field. This makes it unsuitable "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v("\nwebsites. For "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information see the Baseline Requirements "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("https://cabforum.org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nspecifically, section "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.2")]),s._v(".3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Information Requirements"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443")]),s._v("\nkubectl config set-cluster kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --certificate-authority"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.236:8443 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/scheduler.kubeconfig\n\nkubectl config set-credentials system:kube-scheduler "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --client-certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/scheduler.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --client-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/scheduler-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/scheduler.kubeconfig\n\nkubectl config set-context system:kube-scheduler@kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-scheduler "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/scheduler.kubeconfig\n\nkubectl config use-context system:kube-scheduler@kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/scheduler.kubeconfig\n\ncfssl gencert "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   -ca-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-profile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   admin-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" /etc/kubernetes/pki/admin\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443")]),s._v("\nkubectl config set-cluster kubernetes     --certificate-authority"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.236:8443     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/admin.kubeconfig\n\nkubectl config set-credentials kubernetes-admin     --client-certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/admin.pem     --client-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/admin-key.pem     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/admin.kubeconfig\n\nkubectl config set-context kubernetes-admin@kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes-admin     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/admin.kubeconfig\n\nkubectl config use-context kubernetes-admin@kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/admin.kubeconfig\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br")])]),a("h5",{attrs:{id:"_6-3-4、创建serviceaccount-key-asecret"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-4、创建serviceaccount-key-asecret"}},[s._v("#")]),s._v(" 6.3.4、创建ServiceAccount Key asecret")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl genrsa -out /etc/kubernetes/pki/sa.key 2048")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nGenerating RSA private key, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v(" bit long modulus\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("+++\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".+++\ne is "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65537")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x10001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nwriting RSA key\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h5",{attrs:{id:"_6-3-5、发送证书至其他节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-5、发送证书至其他节点"}},[s._v("#")]),s._v(" 6.3.5、发送证书至其他节点")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" k8s-master02 k8s-master03"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /etc/kubernetes/pki "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /etc/kubernetes/pki/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/pki/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /etc/kubernetes/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h5",{attrs:{id:"_6-3-6、查看证书文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-6、查看证书文件"}},[s._v("#")]),s._v(" 6.3.6、查看证书文件")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /etc/kubernetes/pki/")]),s._v("\nadmin.csr      apiserver.csr      ca.csr      controller-manager.csr      front-proxy-ca.csr      front-proxy-client.csr      sa.key         scheduler-key.pem\nadmin-key.pem  apiserver-key.pem  ca-key.pem  controller-manager-key.pem  front-proxy-ca-key.pem  front-proxy-client-key.pem  sa.pub         scheduler.pem\nadmin.pem      apiserver.pem      ca.pem      controller-manager.pem      front-proxy-ca.pem      front-proxy-client.pem      scheduler.csr\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /etc/kubernetes/pki/ |wc -l")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"七、kubernetes系统组件配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、kubernetes系统组件配置"}},[s._v("#")]),s._v(" 七、Kubernetes系统组件配置")]),s._v(" "),a("h4",{attrs:{id:"_7-1、etcd配置-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1、etcd配置-所有master节点"}},[s._v("#")]),s._v(" 7.1、Etcd配置（所有Master节点）")]),s._v(" "),a("p",[s._v("etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址")]),s._v(" "),a("h5",{attrs:{id:"_7-1-1、master-01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1、master-01上"}},[s._v("#")]),s._v(" 7.1.1、Master 01上")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/etcd/etcd.config.yml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master01'")]),s._v("\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nheartbeat-interval: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nelection-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nquota-backend-bytes: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nlisten-peer-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.107:2380'")]),s._v("\nlisten-client-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.107:2379,http://127.0.0.1:2379'")]),s._v("\nmax-snapshots: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nmax-wals: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\ncors:\ninitial-advertise-peer-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.107:2380'")]),s._v("\nadvertise-client-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.107:2379'")]),s._v("\ndiscovery:\ndiscovery-fallback: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'proxy'")]),s._v("\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master01=https://10.4.7.107:2380,k8s-master02=https://10.4.7.108:2380,k8s-master03=https://10.4.7.109:2380'")]),s._v("\ninitial-cluster-token: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'etcd-k8s-cluster'")]),s._v("\ninitial-cluster-state: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new'")]),s._v("\nstrict-reconfig-check: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nenable-v2: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nenable-pprof: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nproxy: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'off'")]),s._v("\nproxy-failure-wait: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nproxy-refresh-interval: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nproxy-dial-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nproxy-write-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nproxy-read-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nclient-transport-security:\n  cert-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd.pem'")]),s._v("\n  key-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-key.pem'")]),s._v("\n  client-cert-auth: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  trusted-ca-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-ca.pem'")]),s._v("\n  auto-tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\npeer-transport-security:\n  cert-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd.pem'")]),s._v("\n  key-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-key.pem'")]),s._v("\n  peer-client-cert-auth: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  trusted-ca-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-ca.pem'")]),s._v("\n  auto-tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ndebug: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nlog-package-levels:\nlog-outputs: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nforce-new-cluster: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("h5",{attrs:{id:"_7-1-2、master-02上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2、master-02上"}},[s._v("#")]),s._v(" 7.1.2、Master 02上")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master02 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/etcd/etcd.config.yml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master02'")]),s._v("\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nheartbeat-interval: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nelection-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nquota-backend-bytes: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nlisten-peer-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.108:2380'")]),s._v("\nlisten-client-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.108:2379,http://127.0.0.1:2379'")]),s._v("\nmax-snapshots: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nmax-wals: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\ncors:\ninitial-advertise-peer-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.108:2380'")]),s._v("\nadvertise-client-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.108:2379'")]),s._v("\ndiscovery:\ndiscovery-fallback: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'proxy'")]),s._v("\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master01=https://10.4.7.107:2380,k8s-master02=https://10.4.7.108:2380,k8s-master03=https://10.4.7.109:2380'")]),s._v("\ninitial-cluster-token: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'etcd-k8s-cluster'")]),s._v("\ninitial-cluster-state: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new'")]),s._v("\nstrict-reconfig-check: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nenable-v2: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nenable-pprof: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nproxy: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'off'")]),s._v("\nproxy-failure-wait: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nproxy-refresh-interval: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nproxy-dial-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nproxy-write-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nproxy-read-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nclient-transport-security:\n  cert-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd.pem'")]),s._v("\n  key-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-key.pem'")]),s._v("\n  client-cert-auth: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  trusted-ca-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-ca.pem'")]),s._v("\n  auto-tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\npeer-transport-security:\n  cert-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd.pem'")]),s._v("\n  key-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-key.pem'")]),s._v("\n  peer-client-cert-auth: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  trusted-ca-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-ca.pem'")]),s._v("\n  auto-tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ndebug: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nlog-package-levels:\nlog-outputs: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nforce-new-cluster: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("h5",{attrs:{id:"_7-1-3、master-03上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-3、master-03上"}},[s._v("#")]),s._v(" 7.1.3、Master 03上")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master03 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/etcd/etcd.config.yml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master03'")]),s._v("\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nheartbeat-interval: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nelection-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nquota-backend-bytes: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nlisten-peer-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.109:2380'")]),s._v("\nlisten-client-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.109:2379,http://127.0.0.1:2379'")]),s._v("\nmax-snapshots: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nmax-wals: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\ncors:\ninitial-advertise-peer-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.109:2380'")]),s._v("\nadvertise-client-urls: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.4.7.109:2379'")]),s._v("\ndiscovery:\ndiscovery-fallback: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'proxy'")]),s._v("\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k8s-master01=https://10.4.7.107:2380,k8s-master02=https://10.4.7.108:2380,k8s-master03=https://10.4.7.109:2380'")]),s._v("\ninitial-cluster-token: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'etcd-k8s-cluster'")]),s._v("\ninitial-cluster-state: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'new'")]),s._v("\nstrict-reconfig-check: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nenable-v2: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nenable-pprof: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nproxy: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'off'")]),s._v("\nproxy-failure-wait: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nproxy-refresh-interval: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nproxy-dial-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nproxy-write-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nproxy-read-timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nclient-transport-security:\n  cert-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd.pem'")]),s._v("\n  key-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-key.pem'")]),s._v("\n  client-cert-auth: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  trusted-ca-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-ca.pem'")]),s._v("\n  auto-tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\npeer-transport-security:\n  cert-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd.pem'")]),s._v("\n  key-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-key.pem'")]),s._v("\n  peer-client-cert-auth: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  trusted-ca-file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd/etcd-ca.pem'")]),s._v("\n  auto-tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ndebug: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nlog-package-levels:\nlog-outputs: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nforce-new-cluster: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("h4",{attrs:{id:"_7-2、-创建service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2、-创建service"}},[s._v("#")]),s._v(" 7.2、 创建Service")]),s._v(" "),a("h5",{attrs:{id:"_7-2-1、创建etcd-service并启动-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-1、创建etcd-service并启动-所有master节点"}},[s._v("#")]),s._v(" 7.2.1、创建etcd service并启动（所有Master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/lib/systemd/system/etcd.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Etcd Service\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://coreos.com/etcd/docs/latest/\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("notify\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/etcd --config-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/etcd.config.yml\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on-failure\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNOFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Alias")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd3.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h5",{attrs:{id:"_7-2-2、创建etcd的证书目录-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-2、创建etcd的证书目录-所有master节点"}},[s._v("#")]),s._v(" 7.2.2、创建etcd的证书目录（所有Master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#所有")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /etc/kubernetes/pki/etcd\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/\nsystemctl daemon-reload\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" etcd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h5",{attrs:{id:"_7-2-3、查看集群状态-任意master"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-3、查看集群状态-任意master"}},[s._v("#")]),s._v(" 7.2.3、查看集群状态（任意master）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master03 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# export ETCDCTL_API=3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master03 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# etcdctl --endpoints="10.4.7.109:2379,10.4.7.108:2379,10.4.7.107:2379" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table')]),s._v("\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      ENDPOINT      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("        ID        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" VERSION "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" DB SIZE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" IS LEADER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" IS LEARNER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" RAFT "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("TERM")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" RAFT INDEX "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" RAFT APPLIED INDEX "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ERRORS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.109:2379 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" a77e5ca7bd4dc035 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".13 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" kB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("465")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.108:2379 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" e3adc675ac3b3dbd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".13 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" kB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("465")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107:2379 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 47a087175e3f17b3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".13 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" kB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("465")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"八、高可用配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#八、高可用配置"}},[s._v("#")]),s._v(" 八、高可用配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("高可用配置（注意：如果不是高可用集群，haproxy和keepalived无需安装）\n如果在云上安装也无需执行此章节的步骤，可以直接使用云上的lb，比如阿里云slb，腾讯云elb等\nSlb -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" haproxy -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" apiserver\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_8-1、安装keepalived和haproxy-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-1、安装keepalived和haproxy-所有master节点"}},[s._v("#")]),s._v(" 8.1、安装keepalived和haproxy（所有Master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" keepalived haproxy "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_8-2、master配置haproxy-master节点都配置一样"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-2、master配置haproxy-master节点都配置一样"}},[s._v("#")]),s._v(" 8.2、Master配置HAProxy，Master节点都配置一样")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/haproxy/haproxy.cfg\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v(" global\n  maxconn  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("\n  ulimit-n  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("\n  log  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 local0 err\n  stats "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" 30s\n\ndefaults\n  log global\n  mode  http\n  option  httplog\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" connect "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" client  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" server  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" http-request 15s\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" http-keep-alive 15s\n\nfrontend k8s-master\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:8443\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8443\n  mode tcp\n  option tcplog\n  tcp-request inspect-delay 5s\n  default_backend k8s-master\n\nbackend k8s-master\n  mode tcp\n  option tcplog\n  option tcp-check\n  balance roundrobin\n  default-server inter 10s downinter 5s rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" slowstart 60s maxconn "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("250")]),s._v(" maxqueue "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v(" weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n  server k8s-master01    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107:6443  check\n  server k8s-master02    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.108:6443  check\n  server k8s-master03    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.109:6443  check\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("h4",{attrs:{id:"_8-3、配置keepalived-master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3、配置keepalived-master节点"}},[s._v("#")]),s._v(" 8.3、配置KeepAlived（Master节点）")]),s._v(" "),a("p",[a("strong",[s._v("注意每个节点的IP和网卡（interface参数）")])]),s._v(" "),a("h5",{attrs:{id:"_8-3-1、master01"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-1、master01"}},[s._v("#")]),s._v(" 8.3.1、Master01")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/keepalived/keepalived.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Configuration File "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" keepalived\nglobal_defs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    router_id LVS_DEVEL\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_script chk_apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/keepalived/check_apiserver.sh"')]),s._v("\n    interval "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" \n    weight "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-5")]),s._v("\n    fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_instance VI_1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    state MASTER\n    interface ens33\n    mcast_src_ip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107\n    virtual_router_id "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n    priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),s._v("\n    nopreempt\n    advert_int "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    authentication "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.236\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    track_script "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      chk_apiserver \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h5",{attrs:{id:"_8-3-2、master02"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-2、master02"}},[s._v("#")]),s._v(" 8.3.2、Master02")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/keepalived/keepalived.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Configuration File "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" keepalived\nglobal_defs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    router_id LVS_DEVEL\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_script chk_apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/keepalived/check_apiserver.sh"')]),s._v("\n    interval "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" \n    weight "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-5")]),s._v("\n    fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_instance VI_1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    state BACKUP\n    interface ens33\n    mcast_src_ip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.108\n    virtual_router_id "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n    priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n    nopreempt\n    advert_int "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    authentication "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.236\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    track_script "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      chk_apiserver \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h5",{attrs:{id:"_8-3-3、master03"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-3、master03"}},[s._v("#")]),s._v(" 8.3.3、Master03")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/keepalived/keepalived.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Configuration File "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" keepalived\nglobal_defs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    router_id LVS_DEVEL\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_script chk_apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/keepalived/check_apiserver.sh"')]),s._v("\n    interval "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    weight "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-5")]),s._v("\n    fall "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  \n    rise "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_instance VI_1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    state BACKUP\n    interface ens33\n    mcast_src_ip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.109\n    virtual_router_id "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n    priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n    nopreempt\n    advert_int "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    authentication "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.236\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    track_script "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      chk_apiserver \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h5",{attrs:{id:"_8-3-4、健康检查脚本-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-4、健康检查脚本-所有master节点"}},[s._v("#")]),s._v(" 8.3.4、健康检查脚本（所有master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/keepalived/check_apiserver.sh  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EFO\n#!/bin/bash\n\nerr=0\nfor k in "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\ndo\n    check_code="),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("pgrep haproxy"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n    if [[ "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$check_code")]),s._v(' == "" ]]; then\n        err='),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("expr")]),s._v(" $err + "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n        sleep 1\n        continue\n    else\n        err=0\n        break\n    fi\ndone\n\nif [[ "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$err")]),s._v(' != "0" ]]; then\n    echo "systemctl stop keepalived"\n    /usr/bin/systemctl stop keepalived\n    exit 1\nelse\n    exit 0\nfi\nEFO')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 授权")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /etc/keepalived/check_apiserver.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("h5",{attrs:{id:"_8-3-5、节点启动haproxy和keepalived-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-5、节点启动haproxy和keepalived-所有master节点"}},[s._v("#")]),s._v(" 8.3.5、节点启动haproxy和keepalived（所有master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl daemon-reload\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" haproxy\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" keepalived\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"_8-3-6、vip测试-master01"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-6、vip测试-master01"}},[s._v("#")]),s._v(" 8.3.6、VIP测试 （master01）")]),s._v(" "),a("h6",{attrs:{id:"重要-如果安装了keepalived和haproxy-需要测试keepalived是否是正常的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重要-如果安装了keepalived和haproxy-需要测试keepalived是否是正常的"}},[s._v("#")]),s._v(" 重要：如果安装了keepalived和haproxy，需要测试keepalived是否是正常的")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 看到有VIP绑定到ens33网卡上了")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip a | grep ens33")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": ens33: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc pfifo_fast state UP group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107/24 brd "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.255 scope global ens33\n    inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.236/32 scope global ens33\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 任意节点，检查haproxy")]),s._v("\ntelnet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.236 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v("\n\n如果ping不通且telnet没有出现 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"]"')]),s._v("，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等\n所有节点查看防火墙状态必须为disable和inactive：systemctl status firewalld\n所有节点查看selinux状态，必须为disable：getenforce\nmaster节点查看haproxy和keepalived状态：systemctl status keepalived haproxy\nmaster节点查看监听端口：netstat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-lntp")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h3",{attrs:{id:"九、kubernetes组件配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#九、kubernetes组件配置"}},[s._v("#")]),s._v(" 九、Kubernetes组件配置")]),s._v(" "),a("h4",{attrs:{id:"_9-1、apiserver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-1、apiserver"}},[s._v("#")]),s._v(" 9.1、Apiserver")]),s._v(" "),a("p",[s._v("所有Master节点创建kube-apiserver service，# 注意，如果不是高可用集群，10.4.7.236改为master01的地址")]),s._v(" "),a("p",[s._v("注意本文档使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改")]),s._v(" "),a("h5",{attrs:{id:"_9-1-1、master01配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-1、master01配置"}},[s._v("#")]),s._v(" 9.1.1、Master01配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/lib/systemd/system/kube-apiserver.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Kubernetes API Server\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/kubernetes/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kube-apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--v")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--logtostderr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --allow-privileged"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --bind-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --secure-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --insecure-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --advertise-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-cluster-ip-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.0/12  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-node-port-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("-32767  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-servers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-cafile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-certfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-keyfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --tls-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --tls-private-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-client-certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-client-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.pub  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-signing-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.key  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-issuer"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://kubernetes.default.svc.cluster.local "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-preferred-address-types"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("InternalIP,ExternalIP,Hostname  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --enable-admission-plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --authorization-mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Node,RBAC  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --enable-bootstrap-token-auth"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --proxy-client-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-client.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --proxy-client-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-client-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-allowed-names"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("aggregator  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-group-headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-Group  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-extra-headers-prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-Extra-  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-username-headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-User\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --token-auth-file=/etc/kubernetes/token.csv")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on-failure\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNOFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br")])]),a("h5",{attrs:{id:"_9-1-2、master02配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-2、master02配置"}},[s._v("#")]),s._v(" 9.1.2、Master02配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/lib/systemd/system/kube-apiserver.service \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Kubernetes API Server\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/kubernetes/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kube-apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--v")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--logtostderr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --allow-privileged"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --bind-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --secure-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --insecure-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --advertise-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.108 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-cluster-ip-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.0/12  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-node-port-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("-32767  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-servers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-cafile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-certfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-keyfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --tls-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --tls-private-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-client-certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-client-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.pub  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-signing-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.key  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-issuer"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://kubernetes.default.svc.cluster.local "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-preferred-address-types"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("InternalIP,ExternalIP,Hostname  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --enable-admission-plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --authorization-mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Node,RBAC  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --enable-bootstrap-token-auth"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --proxy-client-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-client.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --proxy-client-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-client-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-allowed-names"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("aggregator  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-group-headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-Group  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-extra-headers-prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-Extra-  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-username-headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-User\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --token-auth-file=/etc/kubernetes/token.csv")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on-failure\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNOFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br")])]),a("h5",{attrs:{id:"_9-1-3、master03配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-3、master03配置"}},[s._v("#")]),s._v(" 9.1.3、Master03配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/lib/systemd/system/kube-apiserver.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Kubernetes API Server\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/kubernetes/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kube-apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--v")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--logtostderr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --allow-privileged"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --bind-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --secure-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --insecure-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --advertise-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.109 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-cluster-ip-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.0/12  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-node-port-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("-32767  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-servers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-cafile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-certfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --etcd-keyfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/etcd/ssl/etcd-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --tls-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --tls-private-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-client-certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-client-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.pub  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-signing-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.key  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-issuer"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://kubernetes.default.svc.cluster.local "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --kubelet-preferred-address-types"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("InternalIP,ExternalIP,Hostname  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --enable-admission-plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --authorization-mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Node,RBAC  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --enable-bootstrap-token-auth"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-ca.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --proxy-client-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-client.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --proxy-client-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-client-key.pem  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-allowed-names"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("aggregator  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-group-headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-Group  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-extra-headers-prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-Extra-  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-username-headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("X-Remote-User\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --token-auth-file=/etc/kubernetes/token.csv")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on-failure\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LimitNOFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br")])]),a("h5",{attrs:{id:"_9-1-4、启动apiserver-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-4、启动apiserver-所有master节点"}},[s._v("#")]),s._v(" 9.1.4、启动apiserver（所有Master节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" kube-apiserver\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看日志")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /var/log/messages\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检测kube-server状态")]),s._v("\nsystemctl status kube-apiserver\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\n● kube-apiserver.service - Kubernetes API Server\n   Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/usr/lib/systemd/system/kube-apiserver.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: disabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Mon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-21 03:50:34 CST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 56s ago\n     Docs: https://github.com/kubernetes/kubernetes\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下日志不需要理会，是正常的日志 ")]),s._v("\nbalancer_conn_wrappers.go:78"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" pickfirstBalancer: HandleSubConnStateChange: 0xc01124e0e0, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("READY "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("nil"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nDec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" 03:51:19 k8s-master01 kube-apiserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10428")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1221 03:51:19.699478   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10428")]),s._v(" controlbuf.go:508"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" transport: loopyWriter.run returning. connection error: desc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"transport is closing"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h4",{attrs:{id:"_9-2、配置kube-controller-manager-service-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-2、配置kube-controller-manager-service-所有master节点"}},[s._v("#")]),s._v(" 9.2、配置kube-controller-manager service （所有Master节点）")]),s._v(" "),a("p",[s._v("注意本文档使用的k8s Pod网段为172.16.0.0/12，该网段不能和宿主机的网段、k8s Service网段的重复，请按需修改")]),s._v(" "),a("h5",{attrs:{id:"_9-2-1、三master配置文件节点相同"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-1、三master配置文件节点相同"}},[s._v("#")]),s._v(" 9.2.1、三Master配置文件节点相同")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /usr/lib/systemd/system/kube-controller-manager.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Kubernetes Controller Manager\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/kubernetes/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kube-controller-manager "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--v")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--logtostderr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--address")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --root-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --cluster-signing-cert-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --cluster-signing-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --service-account-private-key-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/sa.key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/controller-manager.kubeconfig "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --leader-elect"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --use-service-account-credentials"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --node-monitor-grace-period"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("40s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --node-monitor-period"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --pod-eviction-timeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("2m0s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--controllers")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("*,bootstrapsigner,tokencleaner "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --allocate-node-cidrs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --cluster-cidr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".0.0/12 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --requestheader-client-ca-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/front-proxy-ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --node-cidr-mask-size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h5",{attrs:{id:"_9-2-2、启动-所有matser节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-2、启动-所有matser节点"}},[s._v("#")]),s._v(" 9.2.2、启动（所有matser节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" kube-controller-manager\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"_9-2-3、查看状态-所有matser节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-3、查看状态-所有matser节点"}},[s._v("#")]),s._v(" 9.2.3、查看状态（所有matser节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl  status kube-controller-manager\n\n● kube-controller-manager.service - Kubernetes Controller Manager\n   Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/usr/lib/systemd/system/kube-controller-manager.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: disabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Mon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-21 03:59:21 CST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 28s ago\n     Docs: https://github.com/kubernetes/kubernetes\n Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13594")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kube-controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_9-3、配置kube-scheduler-service-所有master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-3、配置kube-scheduler-service-所有master节点"}},[s._v("#")]),s._v(" 9.3、配置kube-scheduler service（所有Master节点）")]),s._v(" "),a("h5",{attrs:{id:"_9-3-1、所有master节点配置文件相同"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-3-1、所有master节点配置文件相同"}},[s._v("#")]),s._v(" 9.3.1、所有master节点配置文件相同")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /usr/lib/systemd/system/kube-scheduler.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Kubernetes Scheduler\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/kubernetes/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kube-scheduler "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--v")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--logtostderr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--address")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      --leader-elect"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/scheduler.kubeconfig\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h5",{attrs:{id:"_9-3-2、启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-3-2、启动"}},[s._v("#")]),s._v(" 9.3.2、启动")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v(" systemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" kube-scheduler\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"_9-3-3、查看状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-3-3、查看状态"}},[s._v("#")]),s._v(" 9.3.3、查看状态")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl status kube-scheduler\n\n● kube-scheduler.service - Kubernetes Scheduler\n   Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/usr/lib/systemd/system/kube-scheduler.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: disabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Mon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-21 04:03:50 CST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 17s ago\n     Docs: https://github.com/kubernetes/kubernetes\n Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10915")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kube-scheduler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"十、tls-bootstrapping配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十、tls-bootstrapping配置"}},[s._v("#")]),s._v(" 十、TLS Bootstrapping配置")]),s._v(" "),a("h4",{attrs:{id:"_10-1、创建bootstrap-master01节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-1、创建bootstrap-master01节点"}},[s._v("#")]),s._v(" 10.1、创建bootstrap（Master01节点）")]),s._v(" "),a("p",[s._v("注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/bootstrap")]),s._v("\n\nkubectl config set-cluster kubernetes     --certificate-authority"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.236:8443     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/bootstrap-kubelet.kubeconfig\n\nkubectl config set-credentials tls-bootstrap-token-user     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("c8ad9c.2e4d610cf3e7426e "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/bootstrap-kubelet.kubeconfig\n\nkubectl config set-context tls-bootstrap-token-user@kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("tls-bootstrap-token-user     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/bootstrap-kubelet.kubeconfig\n\nkubectl config use-context tls-bootstrap-token-user@kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/bootstrap-kubelet.kubeconfig\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("注意：如果要修改bootstrap.secret.yaml的token-id和token-secret，需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致"),a("img",{attrs:{src:"images/image-20210517202456220.png",alt:"image-20210517202456220"}})]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apiVersion: v1\nkind: Secret\nmetadata:\n  name: bootstrap-token-c8ad9c\n  namespace: kube-system\ntype: bootstrap.kubernetes.io/token\nstringData:\n  description: \"The default bootstrap token generated by 'kubelet '.\"\n  token-id: c8ad9c   #这个跟metadata.name 后面那个一样\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/bootstrap")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 bootstrap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 bootstrap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f bootstrap.secret.yaml ")]),s._v("\nsecret/bootstrap-token-c8ad9c created\nclusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created\nclusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created\nclusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created\nclusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created\nclusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"十一、node节点配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十一、node节点配置"}},[s._v("#")]),s._v(" 十一、Node节点配置")]),s._v(" "),a("h4",{attrs:{id:"_11-1、复制证书至node节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-1、复制证书至node节点"}},[s._v("#")]),s._v(" 11.1、复制证书至Node节点")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/kubernetes/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" k8s-master02 k8s-master03 k8s-node01 k8s-node02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" etcd-ca.pem etcd.pem etcd-key.pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /etc/etcd/ssl/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/etcd/ssl/\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /etc/kubernetes/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$FILE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FILE}")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h4",{attrs:{id:"_11-2、kubelet配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2、kubelet配置"}},[s._v("#")]),s._v(" 11.2、Kubelet配置")]),s._v(" "),a("h5",{attrs:{id:"_11-2-1、创建相关目录-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-1、创建相关目录-所有节点"}},[s._v("#")]),s._v(" 11.2.1、创建相关目录（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"_11-2-2、配置kubelet-service-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-2、配置kubelet-service-所有节点"}},[s._v("#")]),s._v(" 11.2.2、配置kubelet service（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /usr/lib/systemd/system/kubelet.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Kubernetes Kubelet\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/kubernetes/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("docker.service\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Requires")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("docker.service\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kubelet\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("StartLimitInterval")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h5",{attrs:{id:"_11-2-3、配置kubelet-service的配置文件-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-3、配置kubelet-service的配置文件-所有节点"}},[s._v("#")]),s._v(" 11.2.3、配置kubelet service的配置文件（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/systemd/system/kubelet.service.d/10-kubelet.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \"")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kubelet "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_KUBECONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_CONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_SYSTEM_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_EXTRA_ARGS")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h5",{attrs:{id:"_11-2-4、kubelet的配置文件-所有节点-启动所有节点kubelet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-4、kubelet的配置文件-所有节点-启动所有节点kubelet"}},[s._v("#")]),s._v(" 11.2.4、kubelet的配置文件（所有节点）启动所有节点kubelet")]),s._v(" "),a("h6",{attrs:{id:"注意-如果更改了k8s的service网段-需要更改kubelet-conf-yml-的clusterdns-配置-改成k8s-service网段的第十个地址-比如10-96-0-10-k8s的service网段开始设置的是10-96-0-0-12"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意-如果更改了k8s的service网段-需要更改kubelet-conf-yml-的clusterdns-配置-改成k8s-service网段的第十个地址-比如10-96-0-10-k8s的service网段开始设置的是10-96-0-0-12"}},[s._v("#")]),s._v(" 注意：如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10（k8s的service网段开始设置的是10.96.0.0/12）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /etc/kubernetes/kubelet-conf.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("apiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\naddress: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\nport: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10250")]),s._v("\nreadOnlyPort: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10255")]),s._v("\nauthentication:\n  anonymous:\n    enabled: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  webhook:\n    cacheTTL: 2m0s\n    enabled: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.pem\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\ncgroupDriver: systemd\ncgroupsPerQOS: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nclusterDNS:\n- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10\nclusterDomain: cluster.local\ncontainerLogMaxFiles: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\ncontainerLogMaxSize: 10Mi\ncontentType: application/vnd.kubernetes.protobuf\ncpuCFSQuota: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ncpuManagerPolicy: none\ncpuManagerReconcilePeriod: 10s\nenableControllerAttachDetach: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nenableDebuggingHandlers: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nenforceNodeAllocatable:\n- pods\neventBurst: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\neventRecordQPS: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nevictionHard:\n  imagefs.available: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("%\n  memory.available: 100Mi\n  nodefs.available: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("%\n  nodefs.inodesFree: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("%\nevictionPressureTransitionPeriod: 5m0s\nfailSwapOn: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nfileCheckFrequency: 20s\nhairpinMode: promiscuous-bridge\nhealthzBindAddress: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\nhealthzPort: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10248")]),s._v("\nhttpCheckFrequency: 20s\nimageGCHighThresholdPercent: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v("\nimageGCLowThresholdPercent: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\nimageMinimumGCAge: 2m0s\niptablesDropBit: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\niptablesMasqueradeBit: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("\nkubeAPIBurst: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\nkubeAPIQPS: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nmakeIPTablesUtilChains: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nmaxOpenFiles: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v("\nmaxPods: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v("\nnodeStatusUpdateFrequency: 10s\noomScoreAdj: "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-999")]),s._v("\npodPidsLimit: "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-1")]),s._v("\nregistryBurst: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\nregistryPullQPS: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nresolvConf: /etc/resolv.conf\nrotateCertificates: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nruntimeRequestTimeout: 2m0s\nserializeImagePulls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nstaticPodPath: /etc/kubernetes/manifests\nstreamingConnectionIdleTimeout: 4h0m0s\nsyncFrequency: 1m0s\nvolumeStatsAggPeriod: 1m0s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br")])]),a("h5",{attrs:{id:"_11-2-5、启动kubelet-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-5、启动kubelet-所有节点"}},[s._v("#")]),s._v(" 11.2.5、启动kubelet（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl daemon-reload\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" kubelet\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看此时系统日志")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /var/log/messages\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h5",{attrs:{id:"_11-2-6、查看集群状态-matser01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-6、查看集群状态-matser01上"}},[s._v("#")]),s._v(" 11.2.6、查看集群状态（matser01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get node")]),s._v("\nNAME           STATUS     ROLES    AGE     VERSION\nk8s-master01   NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   3m48s   v1.20.0\nk8s-master02   NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   3m48s   v1.20.0\nk8s-master03   NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   3m48s   v1.20.0\nk8s-node01     NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   3m47s   v1.20.0\nk8s-node02     NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   3m48s   v1.20.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_11-3、kube-proxy配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-3、kube-proxy配置"}},[s._v("#")]),s._v(" 11.3、kube-proxy配置")]),s._v(" "),a("p",[s._v("注意，如果不是高可用集群，10.4.7.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443")]),s._v(" "),a("h5",{attrs:{id:"_11-3-1、master01执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-3-1、master01执行"}},[s._v("#")]),s._v(" 11.3.1、Master01执行")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install")]),s._v("\n\nkubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system create serviceaccount kube-proxy\n\nkubectl create clusterrolebinding system:kube-proxy         "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--clusterrole")]),s._v(" system:node-proxier         "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--serviceaccount")]),s._v(" kube-system:kube-proxy\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SECRET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system get sa/kube-proxy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("jsonpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{.secrets[0].name}'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("JWT_TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system get secret/$SECRET "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("jsonpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{.data.token}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PKI_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("K8S_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes\n\nkubectl config set-cluster kubernetes     --certificate-authority"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.pem     --embed-certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://10.4.7.236:8443     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${K8S_DIR}")]),s._v("/kube-proxy.kubeconfig\n\nkubectl config set-credentials kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${JWT_TOKEN}")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/kube-proxy.kubeconfig\n\nkubectl config set-context kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/kube-proxy.kubeconfig\n\nkubectl config use-context kubernetes     "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/kube-proxy.kubeconfig\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h5",{attrs:{id:"_11-3-2、发送kube-proxy的systemd-service文件发送到其他节点-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-3-2、发送kube-proxy的systemd-service文件发送到其他节点-master01上"}},[s._v("#")]),s._v(" 11.3.2、发送kube-proxy的systemd Service文件发送到其他节点（master01上）")]),s._v(" "),a("p",[s._v("如果更改了集群Pod的网段，需要更改kube-proxy/kube-proxy.conf的clusterCIDR: 172.16.0.0/12参数为pod的网段。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /root/k8s-ha-install/kube-proxy/kube-proxy.conf")]),s._v("\nclusterCIDR: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".0.0/12\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h5",{attrs:{id:"分发配置文件-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分发配置文件-master01上"}},[s._v("#")]),s._v(" 分发配置文件（master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" k8s-master01 k8s-master02 k8s-master03"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${K8S_DIR}")]),s._v("/kube-proxy.kubeconfig "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/kube-proxy.kubeconfig\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" kube-proxy/kube-proxy.conf "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/kube-proxy.conf\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" kube-proxy/kube-proxy.service "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/usr/lib/systemd/system/kube-proxy.service\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("NODE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" k8s-node01 k8s-node02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /etc/kubernetes/kube-proxy.kubeconfig "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/kube-proxy.kubeconfig\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" kube-proxy/kube-proxy.conf "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/etc/kubernetes/kube-proxy.conf\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" kube-proxy/kube-proxy.service "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NODE")]),s._v(":/usr/lib/systemd/system/kube-proxy.service\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h5",{attrs:{id:"_11-3-3、启动kube-proxy-所有节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-3-3、启动kube-proxy-所有节点"}},[s._v("#")]),s._v(" 11..3.3、启动kube-proxy（所有节点）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v(" systemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" kube-proxy\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"十二、安装calico"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十二、安装calico"}},[s._v("#")]),s._v(" 十二、安装Calico")]),s._v(" "),a("p",[s._v("Calico的安装请必须听视频课程和最后一章升级Calico的视频")]),s._v(" "),a("h4",{attrs:{id:"_12-1、安装calico-在master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-1、安装calico-在master01上"}},[s._v("#")]),s._v(" 12.1、安装Calico（在master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/calico/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改calico-etcd.yaml的以下位置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'s#etcd_endpoints: "http://<ETCD_IP>:<ETCD_PORT>"#etcd_endpoints: "https://10.4.7.107:2379,https://10.4.7.108:2379,https://10.4.7.109:2379"#g\'')]),s._v(" calico-etcd.yaml\n\n\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_CA")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/kubernetes/pki/etcd/etcd-ca.pem "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_CERT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/kubernetes/pki/etcd/etcd.pem "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_KEY")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/kubernetes/pki/etcd/etcd-key.pem "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s@# etcd-key: null@etcd-key: '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_KEY}")]),s._v("@g; s@# etcd-cert: null@etcd-cert: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CERT}")]),s._v("@g; s@# etcd-ca: null@etcd-ca: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA}")]),s._v('@g"')]),s._v(" calico-etcd.yaml\n\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'s#etcd_ca: ""#etcd_ca: "/calico-secrets/etcd-ca"#g; s#etcd_cert: ""#etcd_cert: "/calico-secrets/etcd-cert"#g; s#etcd_key: "" #etcd_key: "/calico-secrets/etcd-key" #g\'')]),s._v(" calico-etcd.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更改此处为自己的pod网段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POD_SUBNET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.168.0.0/12"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: \"192.168.0.0/16\"@  value: '")]),s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${POD_SUBNET}")]),s._v('"'),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@g'")]),s._v(" calico-etcd.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h4",{attrs:{id:"_12-2、apply"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-2、apply"}},[s._v("#")]),s._v(" 12.2、apply")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 calico"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f calico-etcd.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nsecret/calico-etcd-secrets created\nconfigmap/calico-config created\nclusterrole.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrole.rbac.authorization.k8s.io/calico-node created\nclusterrolebinding.rbac.authorization.k8s.io/calico-node created\ndaemonset.apps/calico-node created\nserviceaccount/calico-node created\ndeployment.apps/calico-kube-controllers created\nserviceaccount/calico-kube-controllers created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"_12-3、查看容器状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-3、查看容器状态"}},[s._v("#")]),s._v(" 12.3、查看容器状态")]),s._v(" "),a("h5",{attrs:{id:"如果容器状态异常可以使用kubectl-describe-或者logs查看容器的日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如果容器状态异常可以使用kubectl-describe-或者logs查看容器的日志"}},[s._v("#")]),s._v(" 如果容器状态异常可以使用kubectl describe 或者logs查看容器的日志")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 calico"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get po -n kube-system")]),s._v("\nNAME                                       READY   STATUS     RESTARTS   AGE\ncalico-kube-controllers-5f6d4b864b-pq2qw   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Pending    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          45s\ncalico-node-75blv                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Init:0/2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          46s\ncalico-node-hw27b                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Init:0/2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          46s\ncalico-node-k2wdf                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Init:0/2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          46s\ncalico-node-l58lz                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Init:0/2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          46s\ncalico-node-v2qlq                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Init:0/2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          46s\ncoredns-867d46bfc6-8vzrk                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Pending    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          10m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"十三、安装coredns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十三、安装coredns"}},[s._v("#")]),s._v(" 十三、安装CoreDNS")]),s._v(" "),a("h4",{attrs:{id:"_13-1、安装对应版本-推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-1、安装对应版本-推荐"}},[s._v("#")]),s._v(" 13.1、安装对应版本（推荐）")]),s._v(" "),a("p",[s._v("master01操作")]),s._v(" "),a("p",[s._v("如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /root/k8s-ha-install/\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 k8s-ha-install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# sed -i "s#10.96.0.10#10.96.0.10#g" CoreDNS/coredns.yaml')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_13-2、安装coredns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-2、安装coredns"}},[s._v("#")]),s._v(" 13.2、安装coredns")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 k8s-ha-install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  create -f CoreDNS/coredns.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nserviceaccount/coredns created\nclusterrole.rbac.authorization.k8s.io/system:coredns created\nclusterrolebinding.rbac.authorization.k8s.io/system:coredns created\nconfigmap/coredns created\ndeployment.apps/coredns created\nservice/kube-dns created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"_13-3、安装最新版coredns-不建议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-3、安装最新版coredns-不建议"}},[s._v("#")]),s._v(" 13.3、安装最新版CoreDNS（不建议）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/coredns/deployment.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" deployment/kubernetes\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./deploy.sh -s -i 10.96.0.10 | kubectl apply -f -")]),s._v("\nserviceaccount/coredns created\nclusterrole.rbac.authorization.k8s.io/system:coredns created\nclusterrolebinding.rbac.authorization.k8s.io/system:coredns created\nconfigmap/coredns created\ndeployment.apps/coredns created\nservice/kube-dns created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看状态")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get po -n kube-system -l k8s-app=kube-dns")]),s._v("\nNAME                       READY   STATUS    RESTARTS   AGE\ncoredns-85b4878f78-h29kh   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          8h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h3",{attrs:{id:"十四、安装metrics-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十四、安装metrics-server"}},[s._v("#")]),s._v(" 十四、安装Metrics Server")]),s._v(" "),a("p",[s._v("在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率")]),s._v(" "),a("h4",{attrs:{id:"_14-1、安装metrics-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-1、安装metrics-server"}},[s._v("#")]),s._v(" 14.1、安装metrics server")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/metrics-server-0.4.x/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 metrics-server-0.4.x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  create -f . ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行结果")]),s._v("\nserviceaccount/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\nservice/metrics-server created\ndeployment.apps/metrics-server created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h4",{attrs:{id:"_14-2、等待metrics-server启动然后查看状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-2、等待metrics-server启动然后查看状态"}},[s._v("#")]),s._v(" 14.2、等待metrics server启动然后查看状态")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  top node             ")]),s._v("\nNAME           CPU"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cores"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   CPU%   MEMORY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   MEMORY%   \nk8s-master01   384m         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("%    1110Mi          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("59")]),s._v("%       \nk8s-master02   334m         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("%    1086Mi          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("58")]),s._v("%       \nk8s-master03   324m         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("%    1043Mi          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v("%       \nk8s-node01     208m         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("%    573Mi           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("%       \nk8s-node02     180m         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("%     534Mi           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("%\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"十五、安装dashboard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十五、安装dashboard"}},[s._v("#")]),s._v(" 十五、安装dashboard")]),s._v(" "),a("p",[s._v("Dashboard用于展示集群中的各类资源，同时也可以通过Dashboard实时查看Pod的日志和在容器中执行一些命令等。")]),s._v(" "),a("h4",{attrs:{id:"_15-1、安装指定版本dashboard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_15-1、安装指定版本dashboard"}},[s._v("#")]),s._v(" 15.1、安装指定版本dashboard")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/k8s-ha-install/dashboard/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 dashboard"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  create -f .")]),s._v("\nserviceaccount/admin-user created\nclusterrolebinding.rbac.authorization.k8s.io/admin-user created\nnamespace/kubernetes-dashboard created\nserviceaccount/kubernetes-dashboard created\nservice/kubernetes-dashboard created\nsecret/kubernetes-dashboard-certs created\nsecret/kubernetes-dashboard-csrf created\nsecret/kubernetes-dashboard-key-holder created\nconfigmap/kubernetes-dashboard-settings created\nrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created\ndeployment.apps/kubernetes-dashboard created\nservice/dashboard-metrics-scraper created\ndeployment.apps/dashboard-metrics-scraper created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h4",{attrs:{id:"_15-2、安装最新版"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_15-2、安装最新版"}},[s._v("#")]),s._v(" 15.2、安装最新版")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 官方GitHub地址：https://github.com/kubernetes/dashboard")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以在官方dashboard查看到最新版dashboard")]),s._v("\n\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建管理员用户vim admin.yaml")]),s._v("\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin-user\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding \nmetadata: \n  name: admin-user\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: admin-user\n  namespace: kube-system\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" admin.yaml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h4",{attrs:{id:"_15-3、登录dashboard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_15-3、登录dashboard"}},[s._v("#")]),s._v(" 15.3、登录dashboard")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更改dashboard的svc为NodePort")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard")]),s._v("\n将ClusterIP更改为NodePort\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看端口号")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc kubernetes-dashboard -n kubernetes-dashboard")]),s._v("\nNAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("         AGE\nkubernetes-dashboard   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".77.112   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":30902/TCP   4m10s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据自己的实例端口号，通过任意安装了kube-proxy的宿主机或者VIP的IP+端口即可访问到dashboard")]),s._v("\n页面访问：https://10.4.7.236:30902/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h4",{attrs:{id:"_15-4、查看token值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_15-4、查看token值"}},[s._v("#")]),s._v(" 15.4、查看token值")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"十六、集群验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十六、集群验证"}},[s._v("#")]),s._v(" 十六、集群验证")]),s._v(" "),a("h4",{attrs:{id:"_16-1、安装busybox-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1、安装busybox-master01上"}},[s._v("#")]),s._v(" 16.1、安装busybox（master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("cat"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" -")]),s._v('\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox\n  namespace: default\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    command:\n      - sleep\n      - "3600"\n    imagePullPolicy: IfNotPresent\n  restartPolicy: Always\nEOF')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h4",{attrs:{id:"_16-2、验证步骤-matser01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-2、验证步骤-matser01上"}},[s._v("#")]),s._v(" 16.2、验证步骤（matser01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".    Pod必须能解析Service\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".    Pod必须能解析跨namespace的Service\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".    每个节点都必须要能访问Kubernetes的kubernetes svc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("和kube-dns的service "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".    Pod和Pod之间要能通\n    a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    同namespace能通信\n    b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    跨namespace能通信\n    c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    跨机器能通信\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_16-3、步骤演示-matser01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-3、步骤演示-matser01上"}},[s._v("#")]),s._v(" 16.3、步骤演示（matser01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 首先查看po是否安装成功")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get po")]),s._v("\nNAME      READY   STATUS    RESTARTS   AGE\nbusybox   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m11s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看svc是否正常")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc")]),s._v("\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   AGE\nkubernetes   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP   163m\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看Pod是否能能解析Service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec  busybox -n default -- nslookup kubernetes ")]),s._v("\nServer:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10\nAddress "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      kubernetes\nAddress "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1 kubernetes.default.svc.cluster.local\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看Pod是否能解析跨namespace的Service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec  busybox -n default -- nslookup kube-dns.kube-system")]),s._v("\nServer:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10\nAddress "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      kube-dns.kube-system\nAddress "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10 kube-dns.kube-system.svc.cluster.local\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 跟我以上结果一致就成功了")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h4",{attrs:{id:"_16-4、使用telnet命令验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-4、使用telnet命令验证"}},[s._v("#")]),s._v(" 16.4、使用telnet命令验证")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点安装telnet命令,有的话忽略")]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" telnet\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有机器 10.96.0.1  443  kubernetes svc 443")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有机器 10.96.0.10 53   kube-dns的service 53")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不会自动断开就是成功了")]),s._v("\ntelnet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("\ntelnet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v("\n\nTrying "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nConnected to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1.\nEscape character is "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^]'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"_16-5、使用curl命令验证-所有机器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-5、使用curl命令验证-所有机器"}},[s._v("#")]),s._v(" 16.5、使用curl命令验证（所有机器）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 10.96.0.10:53")]),s._v("\ncurl: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Empty reply from server\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"_16-6、容器验证-master01上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-6、容器验证-master01上"}},[s._v("#")]),s._v(" 16.6、容器验证（master01上）")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get po -n kube-system")]),s._v("\nNAME                                       READY   STATUS    RESTARTS   AGE\ncalico-kube-controllers-5f6d4b864b-pq2qw   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m\ncalico-node-75blv                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m\ncalico-node-hw27b                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m\ncalico-node-k2wdf                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m\ncalico-node-l58lz                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m\ncalico-node-v2qlq                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m\ncoredns-867d46bfc6-8vzrk                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          72m\nmetrics-server-595f65d8d5-kgn8c            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          60m\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get po -n kube-system -owide")]),s._v("\nNAME                                       READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES\ncalico-kube-controllers-5f6d4b864b-pq2qw   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          63m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107   k8s-master01   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ncalico-node-75blv                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          63m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.110   k8s-node01     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ncalico-node-hw27b                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          63m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.108   k8s-master02   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ncalico-node-k2wdf                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          63m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.107   k8s-master01   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ncalico-node-l58lz                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          63m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.109   k8s-master03   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ncalico-node-v2qlq                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          63m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.111   k8s-node02     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\ncoredns-867d46bfc6-8vzrk                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          73m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.161")]),s._v(".125.2   k8s-node01     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nmetrics-server-595f65d8d5-kgn8c            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          62m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.161")]),s._v(".125.1   k8s-node01     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 能进去就ok")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it calico-node-v2qlq -n  kube-system  -- sh")]),s._v("\nsh-4.4"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入node01，然后能ping通node02就行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it calico-node-v2qlq -n  kube-system  -- bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node02 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.4.7.111")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.111 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.111"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.111: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.123")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.111: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.090")]),s._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".7.111 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 46ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.090")]),s._v("/0.106/0.123/0.019 ms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br")])]),a("h3",{attrs:{id:"十七、生产环境关键性配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十七、生产环境关键性配置"}},[s._v("#")]),s._v(" 十七、生产环境关键性配置")]),s._v(" "),a("p",[s._v("17.1、关键性配置请参考视频，"),a("strong",[s._v("不要直接配置！")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点都改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/docker/daemon.json\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry-mirrors"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://registry.docker-cn.com"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://hub-mirror.c.163.com"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://docker.mirrors.ustc.edu.cn"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exec-opts"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"native.cgroupdriver=systemd"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-concurrent-downloads"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",  \n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-concurrent-uploads"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",  \n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"log-opts"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-size"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"300m"')]),s._v(",    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-file"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",  \n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"live-restore"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" \n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n\nmax-concurrent-downloads "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载并发数")]),s._v("\nmax-concurrent-uploads   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上传并发数")]),s._v("\nmax-size                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志文件最大到多少切割 （此处是300m）")]),s._v("\nmax-file                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志文件保留个数    （此处是2个）")]),s._v("\nlive-restore             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启这个参数，重启docker不会影响上面的参数")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点改完重启docker")]),s._v("\nsystemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl restart "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/lib/systemd/system/kube-controller-manager.service\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 找个位置加上,在三个master节点")]),s._v("\n --experimental-cluster-signing-duration"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("876000h0m0s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 改完重启")]),s._v("\nsystemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl restart kube-controller-manager\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点，更换成以下的配置文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node02 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/systemd/system/kubelet.service.d/10-kubelet.conf ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384    --image-pull-progress-deadline=30m \"")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kubelet "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_KUBECONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_CONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_SYSTEM_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_EXTRA_ARGS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有节点、添加如下配置-----  注意请更具生成环境配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/kubernetes/kubelet-conf.yml\n\nrotateServerCertificates: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nallowedUnsafeSysctls:\n - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"net.core*"')]),s._v("\n - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"net.ipv4.*"')]),s._v("\nkubeReserved:\n  cpu: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10m"')]),s._v("\n  memory: 10Mi\n  ephemeral-storage: 10Mi\nsystemReserved:\n  cpu: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v("\n  memory: 20Mi\n  ephemeral-storage: 1Gi\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 改完重启")]),s._v("\nsystemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl restart kubelet\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看日志没报错就行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -f /var/log/messages                            ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 角色名字更改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl label node k8s-master01 node-role.kubernetes.io/matser=''")]),s._v("\nnode/k8s-master01 labeled\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get node")]),s._v("\nNAME           STATUS   ROLES    AGE    VERSION\nk8s-master01   Ready    matser   129m   v1.20.0   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 成功更改")]),s._v("\nk8s-master02   Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   129m   v1.20.0\nk8s-master03   Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   129m   v1.20.0\nk8s-node01     Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   129m   v1.20.0\nk8s-node02     Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   129m   v1.20.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br")])]),a("h3",{attrs:{id:"十八、安装总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十八、安装总结"}},[s._v("#")]),s._v(" 十八、安装总结")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、    kubeadm\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、    二进制\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、    自动化安装\n    a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    Ansible\n        i.    Master节点安装不需要写自动化。\n        ii.    添加Node节点，playbook。\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、    安装需要注意的细节\n    a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    上面的细节配置\n    b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    生产环境中etcd一定要和系统盘分开，一定要用ssd硬盘。\n    c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    Docker数据盘也要和系统盘分开，有条件的话可以使用ssd硬盘\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"十九、bootstrapping"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十九、bootstrapping"}},[s._v("#")]),s._v(" 十九、Bootstrapping")]),s._v(" "),a("p",[s._v("这里是补充扩展的知识")]),s._v(" "),a("h4",{attrs:{id:"bootstrapping-csr申请和证书颁发原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bootstrapping-csr申请和证书颁发原理"}},[s._v("#")]),s._v(" Bootstrapping CSR申请和证书颁发原理")]),s._v(" "),a("p",[s._v("1.kubelet启动")]),s._v(" "),a("p",[s._v("2.kubele t查找 kubelet.kubeconfig 文件，假设没有这个文件")]),s._v(" "),a("p",[s._v("3.kubelet 会查找本地 bootstrap-kubelet.kubeconfig")]),s._v(" "),a("p",[s._v("4.kubelet 读取 bootstrap.kubeconfig 文件，检索apiserver 的 url 和一个token")]),s._v(" "),a("p",[s._v("5.kubelet 链接 apiserver, 使用这个token 进行认证")]),s._v(" "),a("p",[s._v("​    a) apiserver 会识别tokenid，  apiserver 会查找该 tokenid 对应的 bootstrap 的要给 secret")]),s._v(" "),a("p",[s._v("​    b) 找这个 secret 中的一个字段， apiserver 把这个 token 识别成一个 username，名称是 system:bootstrap:"),a("token-id",[s._v("，属于system:bootstrappers这个组，这个组具有申请csr的权限, 该组的权限绑定在一个叫 system:node-bootstrapper的 clusterrole； clusterrole k8s 集群级别的权限控制，它作用整个k8s集群。")])],1),s._v(" "),a("p",[s._v("​    c) CSR： 相当于申请表，可以拿着这个申请表去申请我们的证书。")]),s._v(" "),a("p",[s._v("6.经过上面的认证，kubelet 就有了一个创建和检索 CSR的权限。")]),s._v(" "),a("p",[s._v("7.kubelet 为自己创建一个CSR，名称为 kubernetes.io/kube-apiserver-clinet-kubelet")]),s._v(" "),a("p",[s._v("8.CSR 被允许有两种方式：")]),s._v(" "),a("p",[s._v("​    a) k8s 管理员使用 kubectl 手动的颁发证书")]),s._v(" "),a("p",[s._v("​    b) 如果配置了相关权限，kube-controller-manager 会自动同意。")]),s._v(" "),a("ol",{attrs:{start:"9"}},[a("li",[a("p",[s._v("CSR 被同意后， controller-manager 创建 kubelet的证书文件")])]),s._v(" "),a("li",[a("p",[s._v("controller-manager 将证书更新至 csr的 status字段")])]),s._v(" "),a("li",[a("p",[s._v("kubelet 从 apiserver 获取证书")])]),s._v(" "),a("li",[a("p",[s._v("kubelet 从获取到的 ey 和证书文件 创建 kubelet.kubeconfig")])]),s._v(" "),a("li",[a("p",[s._v("kubelet 启动完成并正常工作")])]),s._v(" "),a("li",[a("p",[s._v("可选：如果配置了自动续期，kubelet 会在证书文件过期的时候利用之前的 kubeconfig 文件去申请一个新的证书，相当于续约。")])]),s._v(" "),a("li",[a("p",[s._v("新的证书被同意或签发，取决于我们的配置。")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);