(window.webpackJsonp=window.webpackJsonp||[]).push([[288],{645:function(s,n,a){"use strict";a.r(n);var e=a(0),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"replica-sets"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#replica-sets"}},[s._v("#")]),s._v(" Replica Sets")]),s._v(" "),n("h2",{attrs:{id:"_1-1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-简介"}},[s._v("#")]),s._v(" 1.1 简介")]),s._v(" "),n("p",[s._v("MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供冗余和高可用性，是所有生产部署的基础。")]),s._v(" "),n("p",[s._v("也可以说，副本集类似于有自动故障恢复功能的主从集群。通俗的讲就是用多台机器进行同一数据的异步同步，从而使多台机器拥有同一数据的多个副本，并且当主库当掉时在不需要用户干预的情况下自动切换其他备份服务器做主库。而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载。")]),s._v(" "),n("p",[s._v("（1）冗余和数据可用性")]),s._v(" "),n("p",[s._v("复制提供冗余并提高数据可用性。 通过在不同数据库服务器上提供多个数据副本，复制可提供一定级别的容错功能，以防止丢失单个数据库服务器。")]),s._v(" "),n("p",[s._v("在某些情况下，复制可以提供增加的读取性能，因为客户端可以将读取操作发送到不同的服务上， 在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性。 您还可以为专用目的维护其他副本，例如灾难恢复，报告或备份。")]),s._v(" "),n("p",[s._v("（2）MongoDB中的复制")]),s._v(" "),n("p",[s._v("副本集是一组维护相同数据集的mongod实例。 副本集包含多个数据承载节点和可选的一个仲裁节点。在承载数据的节点中，一个且仅一个成员被视为主节点，而其他节点被视为次要（从）节点。")]),s._v(" "),n("p",[s._v("主节点接收所有写操作。 副本集只能有一个主要能够确认具有{w：“most”}写入关注的写入; 虽然在某些情况下，另一个mongod实例可能暂时认为自己也是主要的。主要记录其操作日志中的数据集的所有更改，即oplog。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918164831238.png",alt:"image-20200918092648938"}})]),s._v(" "),n("p",[s._v("辅助(副本)节点复制主节点的oplog并将操作应用于其数据集，以使辅助节点的数据集反映主节点的数据集。 如果主要人员不在，则符合条件的中学将举行选举以选出新的主要人员。")]),s._v(" "),n("p",[s._v("（3）主从复制和副本集区别")]),s._v(" "),n("p",[s._v("主从集群和副本集最大的区别就是副本集没有固定的“主节点”；整个集群会选出一个“主节点”，当其挂掉后，又在剩下的从节点中选中其他节点为“主节点”，副本集总有一个活跃点(主、primary)和一个或多个备份节点(从、secondary)。")]),s._v(" "),n("h2",{attrs:{id:"_1-2-副本集的三个角色"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-副本集的三个角色"}},[s._v("#")]),s._v(" 1.2 副本集的三个角色")]),s._v(" "),n("p",[s._v("副本集有两种类型三种角色")]),s._v(" "),n("p",[s._v("两种类型：")]),s._v(" "),n("ul",[n("li",[s._v("主节点（ Primary）类型：数据操作的主要连接点，可读写。")]),s._v(" "),n("li",[s._v("次要（辅助、从）节点（ Secondaries）类型：数据冗余备份节点，可以读或选举。")])]),s._v(" "),n("p",[s._v("三种角色：")]),s._v(" "),n("ul",[n("li",[s._v("主要成员（Primary）：主要接收所有写操作。就是主节点。")]),s._v(" "),n("li",[s._v("副本成员（Replicate）：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可以读操作（但需要配置）。是默认的一种从节点类型。")]),s._v(" "),n("li",[s._v("仲裁者（ Arbiter）：不保留任何数据的副本，只具有投票选举作用。当然也可以将仲裁服务器维护为副本集的一部分，即副本成员同时也可以是仲裁者。也是一种从节点类型。")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918164912986.png",alt:"image-20200918092959669"}})]),s._v(" "),n("p",[s._v("关于仲裁者的额外说明：")]),s._v(" "),n("p",[s._v("您可以将额外的mongod实例添加到副本集作为仲裁者。 仲裁者不维护数据集。 仲裁者的目的是通过响应其他副本集成员的心跳和选举请求来维护副本集中的仲裁。 因为它们不存储数据集，所以仲裁器可以是提供副本集仲裁功能的好方法，其资源成本比具有数据集的全功能副本集成员更便宜。")]),s._v(" "),n("p",[s._v("如果您的副本集具有偶数个成员，请添加仲裁者以获得主要选举中的“大多数”投票。 仲裁者不需要专用硬件。")]),s._v(" "),n("p",[s._v("仲裁者将永远是仲裁者，而主要人员可能会退出并成为次要人员，而次要人员可能成为选举期间的主要人员。")]),s._v(" "),n("p",[s._v("如果你的副本+主节点的个数是偶数，建议加一个仲裁者，形成奇数，容易满足大多数的投票。")]),s._v(" "),n("p",[s._v("如果你的副本+主节点的个数是奇数，可以不加仲裁者。")]),s._v(" "),n("h2",{attrs:{id:"_1-3-副本集架构目标"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-副本集架构目标"}},[s._v("#")]),s._v(" 1.3 副本集架构目标")]),s._v(" "),n("p",[s._v("一主一副本一仲裁")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918164931592.png",alt:"image-20200918093150930"}})]),s._v(" "),n("h2",{attrs:{id:"_1-4-副本集的创建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-副本集的创建"}},[s._v("#")]),s._v(" 1.4 副本集的创建")]),s._v(" "),n("h3",{attrs:{id:"_1-4-1-第一步-创建主节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-第一步-创建主节点"}},[s._v("#")]),s._v(" 1.4.1 第一步：创建主节点")]),s._v(" "),n("p",[s._v("建立存放数据和日志的目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------myrs\n#主节点\nmkdir -p /mongodb/replica_sets/myrs_27017/log \\ &\nmkdir -p /mongodb/replica_sets/myrs_27017/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/replica_sets/myrs_27017/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myrs_27017 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/replica_sets/myrs_27017/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/replica_sets/myrs_27017/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/replica_sets/myrs_27017/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #bindIp\n    #绑定的端口\n    port: 27017\nreplication:\n    #副本集的名称\n    replSetName: myrs\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("启动节点服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost replica_sets]# /usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 54257\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"_1-4-2-第二步-创建副本节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-第二步-创建副本节点"}},[s._v("#")]),s._v(" 1.4.2 第二步：创建副本节点")]),s._v(" "),n("p",[s._v("建立存放数据和日志的目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------myrs\n#副本节点\nmkdir -p /mongodb/replica_sets/myrs_27018/log \\ &\nmkdir -p /mongodb/replica_sets/myrs_27018/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/replica_sets/myrs_27018/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myrs_27018 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/replica_sets/myrs_27018/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/replica_sets/myrs_27018/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/replica_sets/myrs_27018/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #bindIp\n    #绑定的端口\n    port: 27018\nreplication:\n    #副本集的名称\n    replSetName: myrs\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("启动节点服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost replica_sets]# /usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 54361\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"_1-4-3-第三步-创建仲裁节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-3-第三步-创建仲裁节点"}},[s._v("#")]),s._v(" 1.4.3 第三步：创建仲裁节点")]),s._v(" "),n("p",[s._v("建立存放数据和日志的目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------myrs\n#仲裁节点\nmkdir -p /mongodb/replica_sets/myrs_27019/log \\ &\nmkdir -p /mongodb/replica_sets/myrs_27019/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/replica_sets/myrs_27019/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myrs_27019 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/replica_sets/myrs_27019/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/replica_sets/myrs_27019/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/replica_sets/myrs_27019/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #bindIp\n    #绑定的端口\n    port: 27019\nreplication:\n    #副本集的名称\n    replSetName: myrs\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("启动节点服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost replica_sets]# /usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 54410\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"_1-4-4-第四步-初始化配置副本集和主节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-4-第四步-初始化配置副本集和主节点"}},[s._v("#")]),s._v(" 1.4.4 第四步：初始化配置副本集和主节点")]),s._v(" "),n("p",[s._v("使用客户端命令连接任意一个节点，但这里尽量要连接主节点(27017节点)：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host=180.76.159.126 --port=27017\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("结果，连接上之后，很多命令无法使用，，比如 show dbs 等，必须初始化副本集才行")]),s._v(" "),n("p",[s._v("准备初始化新的副本集：")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.initiate(configuration)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("【示例】")]),s._v(" "),n("p",[s._v("使用默认的配置来初始化副本集：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.initiate()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行结果：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('> rs.initiate()\n{\n    "info2" : "no configuration specified. Using a default configuration for the set",\n    "me" : "180.76.159.126:27017",\n    "ok" : 1,\n    "operationTime" : Timestamp(1565760476, 1),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1565760476, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\nmyrs:SECONDARY>\nmyrs:PRIMARY>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("ul",[n("li",[s._v("“ok”的值为1，说明创建成功。")]),s._v(" "),n("li",[s._v("命令行提示符发生变化，变成了一个从节点角色，此时默认不能读写。稍等片刻，回车，变成主节点。")])]),s._v(" "),n("h3",{attrs:{id:"_1-4-5-第五步-查看副本集的配置内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-5-第五步-查看副本集的配置内容"}},[s._v("#")]),s._v(" 1.4.5 第五步：查看副本集的配置内容")]),s._v(" "),n("p",[s._v("返回包含当前副本集配置的文档。")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.conf(configuration)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[n("code",[s._v("rs.config()")]),s._v(" 是该方法的别名。")]),s._v(" "),n("p",[s._v("configuration：可选，如果没有配置，则使用默认主节点配置。")]),s._v(" "),n("p",[s._v("【示例】")]),s._v(" "),n("p",[s._v("在27017上执行副本集中当前节点的默认节点配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.conf()\n{\n    "_id" : "myrs",\n    "version" : 1,\n    "protocolVersion" : NumberLong(1),\n    "writeConcernMajorityJournalDefault" : true,\n    "members" : [\n        {\n            "_id" : 0,\n            "host" : "180.76.159.126:27017",\n            "arbiterOnly" : false,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 1,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        }\n    ],\n    "settings" : {\n        "chainingAllowed" : true,\n        "heartbeatIntervalMillis" : 2000,\n        "heartbeatTimeoutSecs" : 10,\n        "electionTimeoutMillis" : 10000,\n        "catchUpTimeoutMillis" : -1,\n        "catchUpTakeoverDelayMillis" : 30000,\n        "getLastErrorModes" : {\n\n        },\n        "getLastErrorDefaults" : {\n            "w" : 1,\n            "wtimeout" : 0\n        },\n        "replicaSetId" : ObjectId("5d539bdcd6a308e600d126bb")\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v('"_id" : "myrs"')]),s._v(" ：副本集的配置数据存储的主键值，默认就是副本集的名字")]),s._v(" "),n("li",[n("code",[s._v('"members"')]),s._v(" ：副本集成员数组，此时只有一个： “host” : “180.76.159.126:27017” ，该成员不是仲裁节点：”arbiterOnly” : false ，优先级（权重值）： “priority” : 1,")]),s._v(" "),n("li",[n("code",[s._v('"settings"')]),s._v(" ：副本集的参数配置。")])]),s._v(" "),n("p",[s._v("提示：副本集配置的查看命令，本质是查询的是 system.replset 的表中的数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> use local\nswitched to db local\nmyrs:PRIMARY> show collections\noplog.rs\nreplset.election\nreplset.minvalid\nreplset.oplogTruncateAfterPoint\nstartup_log\nsystem.replset\nsystem.rollback.id\nmyrs:PRIMARY> db.system.replset.find()\n{ "_id" : "myrs", "version" : 1, "protocolVersion" : NumberLong(1),\n"writeConcernMajorityJournalDefault" : true, "members" : [ { "_id" : 0, "host" :\n"180.76.159.126:27017", "arbiterOnly" : false, "buildIndexes" : true, "hidden" :\nfalse, "priority" : 1, "tags" : { }, "slaveDelay" : NumberLong(0), "votes" : 1\n} ], "settings" : { "chainingAllowed" : true, "heartbeatIntervalMillis" : 2000,\n"heartbeatTimeoutSecs" : 10, "electionTimeoutMillis" : 10000,\n"catchUpTimeoutMillis" : -1, "catchUpTakeoverDelayMillis" : 30000,\n"getLastErrorModes" : { }, "getLastErrorDefaults" : { "w" : 1, "wtimeout" : 0\n}, "replicaSetId" : ObjectId("5d539bdcd6a308e600d126bb") } }\nmyrs:PRIMARY>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h3",{attrs:{id:"_1-4-6-第六步-查看副本集状态"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-6-第六步-查看副本集状态"}},[s._v("#")]),s._v(" 1.4.6 第六步：查看副本集状态")]),s._v(" "),n("p",[s._v("检查副本集状态。")]),s._v(" "),n("p",[s._v("说明：")]),s._v(" "),n("p",[s._v("返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态。")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.status()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("【示例】")]),s._v(" "),n("p",[s._v("在27017上查看副本集状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.status()\n{\n    "set" : "myrs",\n    "date" : ISODate("2019-08-14T05:29:45.161Z"),\n    "myState" : 1,\n    "term" : NumberLong(1),\n    "syncingTo" : "",\n    "syncSourceHost" : "",\n    "syncSourceId" : -1,\n    "heartbeatIntervalMillis" : NumberLong(2000),\n    "optimes" : {\n        "lastCommittedOpTime" : {\n            "ts" : Timestamp(1565760578, 1),\n            "t" : NumberLong(1)\n        },\n        "readConcernMajorityOpTime" : {\n            "ts" : Timestamp(1565760578, 1),\n            "t" : NumberLong(1)\n        },\n        "appliedOpTime" : {\n            "ts" : Timestamp(1565760578, 1),\n            "t" : NumberLong(1)\n        },\n        "durableOpTime" : {\n            "ts" : Timestamp(1565760578, 1),\n            "t" : NumberLong(1)\n        }\n    },\n    "lastStableCheckpointTimestamp" : Timestamp(1565760528, 1),\n    "members" : [\n        {\n        "_id" : 0,\n        "name" : "180.76.159.126:27017",\n        "health" : 1,\n        "state" : 1,\n        "stateStr" : "PRIMARY",\n        "uptime" : 419,\n        "optime" : {\n            "ts" : Timestamp(1565760578, 1),\n            "t" : NumberLong(1)\n        },\n        "optimeDate" : ISODate("2019-08-14T05:29:38Z"),\n        "syncingTo" : "",\n        "syncSourceHost" : "",\n        "syncSourceId" : -1,\n        "infoMessage" : "could not find member to sync from",\n        "electionTime" : Timestamp(1565760476, 2),\n        "electionDate" : ISODate("2019-08-14T05:27:56Z"),\n        "configVersion" : 1,\n        "self" : true,\n        "lastHeartbeatMessage" : ""\n        }\n    ],\n    "ok" : 1,\n    "operationTime" : Timestamp(1565760578, 1),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1565760578, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v('"set" : "myrs"')]),s._v(" ：副本集的名字")]),s._v(" "),n("li",[n("code",[s._v('"myState"')]),s._v(" : 1：说明状态正常")]),s._v(" "),n("li",[n("code",[s._v('"members"')]),s._v(" ：副本集成员数组，此时只有一个： "),n("code",[s._v('"name" : "180.76.159.126:27017"')]),s._v(" ，该成员的角色是 "),n("code",[s._v('"stateStr" : "PRIMARY"')]),s._v(", 该节点是健康的： "),n("code",[s._v('"health" : 1')]),s._v(" 。")])]),s._v(" "),n("h3",{attrs:{id:"_1-4-7-第七步-添加副本从节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-7-第七步-添加副本从节点"}},[s._v("#")]),s._v(" 1.4.7 第七步：添加副本从节点")]),s._v(" "),n("p",[s._v("在主节点添加从节点，将其他成员加入到副本集")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.add(host, arbiterOnly)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("选项：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Parameter")]),s._v(" "),n("th",[s._v("Type")]),s._v(" "),n("th",[s._v("Description")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("host")]),s._v(" "),n("td",[s._v("string or document")]),s._v(" "),n("td",[s._v("要添加到副本集的新成员。 指定为字符串或配置文档：1）如果是一个字符串，则需要指定新成员的主机名和可选的端口号；2）如果是一个文档，请指定在members数组中找到的副本集成员配置文档。 您必须在成员配置文档中指定主机字段。有关文档配置字段的说明，详见下方文档：“主机成员的配置文档”")])]),s._v(" "),n("tr",[n("td",[s._v("arbiterOnly")]),s._v(" "),n("td",[s._v("boolean")]),s._v(" "),n("td",[s._v("可选的。 仅在 值为字符串时适用。 如果为true，则添加的主机是仲裁者。")])])])]),s._v(" "),n("p",[s._v("主机成员的配置文档：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("{\n    _id: <int>,\n    host: <string>,     // required\n    arbiterOnly: <boolean>,\n    buildIndexes: <boolean>,\n    hidden: <boolean>,\n    priority: <number>,\n    tags: <document>,\n    slaveDelay: <int>,\n    votes: <number>\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("【示例】")]),s._v(" "),n("p",[s._v("将27018的副本节点添加到副本集中：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.add("180.76.159.126:27018")\n{\n    "ok" : 1,\n    "operationTime" : Timestamp(1565761757, 1),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1565761757, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[s._v("“ok” : 1 ：说明添加成功。")])]),s._v(" "),n("p",[s._v("查看副本集状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.status()\n{\n    "set" : "myrs",\n    "date" : ISODate("2019-08-14T05:50:05.738Z"),\n    "myState" : 1,\n    "term" : NumberLong(1),\n    "syncingTo" : "",\n    "syncSourceHost" : "",\n    "syncSourceId" : -1,\n    "heartbeatIntervalMillis" : NumberLong(2000),\n    "optimes" : {\n        "lastCommittedOpTime" : {\n            "ts" : Timestamp(1565761798, 1),\n            "t" : NumberLong(1)\n        },\n        "readConcernMajorityOpTime" : {\n            "ts" : Timestamp(1565761798, 1),\n            "t" : NumberLong(1)\n        },\n        "appliedOpTime" : {\n            "ts" : Timestamp(1565761798, 1),\n            "t" : NumberLong(1)\n        },\n        "durableOpTime" : {\n            "ts" : Timestamp(1565761798, 1),\n            "t" : NumberLong(1)\n        }\n    },\n    "lastStableCheckpointTimestamp" : Timestamp(1565761798, 1),\n    "members" : [\n        {\n            "_id" : 0,\n            "name" : "180.76.159.126:27017",\n            "health" : 1,\n            "state" : 1,\n            "stateStr" : "PRIMARY",\n            "uptime" : 1639,\n            "optime" : {\n                "ts" : Timestamp(1565761798, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-08-14T05:49:58Z"),\n            "syncingTo" : "",\n            "syncSourceHost" : "",\n            "syncSourceId" : -1,\n            "infoMessage" : "",\n            "electionTime" : Timestamp(1565760476, 2),\n            "electionDate" : ISODate("2019-08-14T05:27:56Z"),\n            "configVersion" : 2,\n            "self" : true,\n            "lastHeartbeatMessage" : ""\n        },\n        {\n            "_id" : 1,\n            "name" : "180.76.159.126:27018",\n            "health" : 1,\n            "state" : 2,\n            "stateStr" : "SECONDARY",\n            "uptime" : 48,\n            "optime" : {\n                "ts" : Timestamp(1565761798, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDurable" : {\n                "ts" : Timestamp(1565761798, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-08-14T05:49:58Z"),\n            "optimeDurableDate" : ISODate("2019-08-14T05:49:58Z"),\n            "lastHeartbeat" : ISODate("2019-08-14T05:50:05.294Z"),\n            "lastHeartbeatRecv" : ISODate("2019-08-\n            14T05:50:05.476Z"),\n            "pingMs" : NumberLong(0),\n            "lastHeartbeatMessage" : "",\n            "syncingTo" : "180.76.159.126:27017",\n            "syncSourceHost" : "180.76.159.126:27017",\n            "syncSourceId" : 0,\n            "infoMessage" : "",\n            "configVersion" : 2\n        }\n    ],\n    "ok" : 1,\n    "operationTime" : Timestamp(1565761798, 1),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1565761798, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v('"name" : "180.76.159.126:27018"')]),s._v(" 是第二个节点的名字，其角色是 "),n("code",[s._v('"stateStr" : "SECONDARY"')])])]),s._v(" "),n("h3",{attrs:{id:"_1-4-8-第八步-添加仲裁从节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-8-第八步-添加仲裁从节点"}},[s._v("#")]),s._v(" 1.4.8 第八步：添加仲裁从节点")]),s._v(" "),n("p",[s._v("添加一个仲裁节点到副本集")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.addArb(host)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将27019的仲裁节点添加到副本集中：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.addArb("180.76.159.126:27019")\n{\n    "ok" : 1,\n    "operationTime" : Timestamp(1565761959, 1),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1565761959, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v('"ok" : 1')]),s._v(" ：说明添加成功。")])]),s._v(" "),n("p",[s._v("查看副本集状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.status()\n{\n    "set" : "myrs",\n    "date" : ISODate("2019-08-14T05:53:27.198Z"),\n    "myState" : 1,\n    "term" : NumberLong(1),\n    "syncingTo" : "",\n    "syncSourceHost" : "",\n    "syncSourceId" : -1,\n    "heartbeatIntervalMillis" : NumberLong(2000),\n    "optimes" : {\n        "lastCommittedOpTime" : {\n            "ts" : Timestamp(1565761998, 1),\n            "t" : NumberLong(1)\n        },\n        "readConcernMajorityOpTime" : {\n            "ts" : Timestamp(1565761998, 1),\n            "t" : NumberLong(1)\n        },\n        "appliedOpTime" : {\n            "ts" : Timestamp(1565761998, 1),\n            "t" : NumberLong(1)\n        },\n        "durableOpTime" : {\n            "ts" : Timestamp(1565761998, 1),\n            "t" : NumberLong(1)\n        }\n    },\n    "lastStableCheckpointTimestamp" : Timestamp(1565761978, 1),\n    "members" : [\n        {\n            "_id" : 0,\n            "name" : "180.76.159.126:27017",\n            "health" : 1,\n            "state" : 1,\n            "stateStr" : "PRIMARY",\n            "uptime" : 1841,\n            "optime" : {\n                "ts" : Timestamp(1565761998, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-08-14T05:53:18Z"),\n            "syncingTo" : "",\n            "syncSourceHost" : "",\n            "syncSourceId" : -1,\n            "infoMessage" : "",\n            "electionTime" : Timestamp(1565760476, 2),\n            "electionDate" : ISODate("2019-08-14T05:27:56Z"),\n            "configVersion" : 3,\n            "self" : true,\n            "lastHeartbeatMessage" : ""\n        },\n        {\n            "_id" : 1,\n            "name" : "180.76.159.126:27018",\n            "health" : 1,\n            "state" : 2,\n            "stateStr" : "SECONDARY",\n            "uptime" : 249,\n            "optime" : {\n                "ts" : Timestamp(1565761998, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDurable" : {\n                "ts" : Timestamp(1565761998, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-08-14T05:53:18Z"),\n            "optimeDurableDate" : ISODate("2019-08-14T05:53:18Z"),\n            "lastHeartbeat" : ISODate("2019-08-14T05:53:25.668Z"),\n            "lastHeartbeatRecv" : ISODate("2019-08-14T05:53:26.702Z"),\n            "pingMs" : NumberLong(0),\n            "lastHeartbeatMessage" : "",\n            "syncingTo" : "180.76.159.126:27017",\n            "syncSourceHost" : "180.76.159.126:27017",\n            "syncSourceId" : 0,\n            "infoMessage" : "",\n            "configVersion" : 3\n        },\n        {\n            "_id" : 2,\n            "name" : "180.76.159.126:27019",\n            "health" : 1,\n            "state" : 7,\n            "stateStr" : "ARBITER",\n            "uptime" : 47,\n            "lastHeartbeat" : ISODate("2019-08-14T05:53:25.668Z"),\n            "lastHeartbeatRecv" : ISODate("2019-08-14T05:53:25.685Z"),\n            "pingMs" : NumberLong(0),\n            "lastHeartbeatMessage" : "",\n            "syncingTo" : "",\n            "syncSourceHost" : "",\n            "syncSourceId" : -1,\n            "infoMessage" : "",\n            "configVersion" : 3\n        }\n    ],\n    "ok" : 1,\n    "operationTime" : Timestamp(1565761998, 1),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1565761998, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v('"name" : "180.76.159.126:27019"')]),s._v(" 是第二个节点的名字，其角色是 "),n("code",[s._v('"stateStr" : "ARBITER"')])])]),s._v(" "),n("h2",{attrs:{id:"_1-5-副本集的数据读写操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-副本集的数据读写操作"}},[s._v("#")]),s._v(" 1.5 副本集的数据读写操作")]),s._v(" "),n("p",[s._v("目标：测试三个不同角色的节点的数据读写情况")]),s._v(" "),n("p",[s._v("登录主节点27017，写入和读取数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017\nmyrs:PRIMARY> use articledb\nswitched to db articledb\nmyrs:PRIMARY> db\narticledb\nmyrs:PRIMARY> db.comment.insert({"articleid":"100000","content":"今天天气真好，阳光明媚","userid":"1001","nickname":"Rose","createdatetime":new Date()})\nWriteResult({ "nInserted" : 1 })\nmyrs:PRIMARY> db.comment.find()\n{ "_id" : ObjectId("5d4d2ae3068138b4570f53bf"), "articleid" : "100000","content" : "今天天气真好，阳光明媚", "userid" : "1001", "nickname" : "Rose","createdatetime" : ISODate("2019-08-09T08:12:19.427Z") }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("登录从节点27018")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27018\nmyrs:SECONDARY> show dbs;\n2019-09-10T10:56:51.953+0800 E QUERY  [js] Error: listDatabases failed:{\n    "operationTime" : Timestamp(1568084204, 1),\n    "ok" : 0,\n    "errmsg" : "not master and slaveOk=false",\n    "code" : 13435,\n    "codeName" : "NotMasterNoSlaveOk",\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1568084204, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n       }\n   }\n} :\n_getErrorWithCode@src/mongo/shell/utils.js:25:13\nMongo.prototype.getDBs@src/mongo/shell/mongo.js:139:1\nshellHelper.show@src/mongo/shell/utils.js:882:13\nshellHelper@src/mongo/shell/utils.js:766:15\n@(shellhelp2):1:1\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行。")]),s._v(" "),n("p",[s._v("因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置")]),s._v(" "),n("p",[s._v("设置读操作权限：")]),s._v(" "),n("p",[s._v("说明：")]),s._v(" "),n("p",[s._v("设置为奴隶节点，允许在从成员上运行读的操作")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.slaveOk()\n#或\nrs.slaveOk(true)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("该命令是 "),n("code",[s._v("db.getMongo().setSlaveOk()")]),s._v(" 的简化命令。")]),s._v(" "),n("p",[s._v("【示例】")]),s._v(" "),n("p",[s._v("在27018上设置作为奴隶节点权限，具备读权限：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs:SECONDARY> rs.slaveOk()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("此时，在执行查询命令，运行成功！")]),s._v(" "),n("p",[s._v("但仍然不允许插入。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:SECONDARY> rs.slaveOk()\nmyrs:SECONDARY> show dbs;\nadmin    0.000GB\narticledb  0.000GB\nconfig   0.000GB\nlocal    0.000GB\nmyrs:SECONDARY> use articledb\nswitched to db articledb\nmyrs:SECONDARY> show collections\ncomment\nmyrs:SECONDARY> db.comment.find()\n{ "_id" : ObjectId("5d7710c04cfd7eee2e3cdabe"), "articleid" : "100000","content" : "今天天气真好，阳光明媚", "userid" : "1001", "nickname" : "Rose","createdatetime" : ISODate("2019-09-10T02:56:00.467Z") }\nmyrs:SECONDARY> db.comment.insert({"_id":"1","articleid":"100001","content":"我们不应该把清晨浪费在手机上，健康很重要，k一杯温水幸福你我他。","userid":"1002","nickname":"相忘于江湖","createdatetime":new Date("2019-08-05T22:08:15.522Z"),"likenum":NumberInt(1000),"state":"1"})\nWriteCommandError({\n    "operationTime" : Timestamp(1568084434, 1),\n    "ok" : 0,\n    "errmsg" : "not master",\n    "code" : 10107,\n    "codeName" : "NotMaster",\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1568084434, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("现在可实现了读写分离，让主插入数据，让从来读取数据。")]),s._v(" "),n("p",[s._v("如果要取消作为奴隶节点的读权限：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:SECONDARY> rs.slaveOk(false)\nmyrs:SECONDARY> db.comment.find()\nError: error: {\n    "operationTime" : Timestamp(1568084459, 1),\n    "ok" : 0,\n    "errmsg" : "not master and slaveOk=false",\n    "code" : 13435,\n    "codeName" : "NotMasterNoSlaveOk",\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1568084459, 1),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("仲裁者节点，不存放任何业务数据的，可以登录查看")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27019\nmyrs:ARBITER> rs.slaveOk()\nmyrs:ARBITER> show dbs\nlocal  0.000GB\nmyrs:ARBITER> use local\nswitched to db local\nmyrs:ARBITER> show collections\nreplset.minvalid\nreplset.oplogTruncateAfterPoint\nstartup_log\nsystem.replset\nsystem.rollback.id\nmyrs:ARBITER>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("发现，只存放副本集配置等数据。")]),s._v(" "),n("h2",{attrs:{id:"_1-6-主节点的选举原则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-主节点的选举原则"}},[s._v("#")]),s._v(" 1.6 主节点的选举原则")]),s._v(" "),n("p",[s._v("MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件：")]),s._v(" "),n("ul",[n("li",[s._v("主节点故障")]),s._v(" "),n("li",[s._v("主节点网络不可达（默认心跳信息为10秒）")]),s._v(" "),n("li",[s._v("人工干预（rs.stepDown(600)）")])]),s._v(" "),n("p",[s._v("一旦触发选举，就要根据一定规则来选主节点。")]),s._v(" "),n("p",[s._v("选举规则是根据票数来决定谁获胜：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("票数最高，且获得了 “大多数”成员的投票支持的节点获胜。")]),s._v(" "),n("p",[s._v("“大多数”的定义为：假设复制集内投票成员数量为N，则大多数为 N/2 + 1。例如：3个投票成员，则大多数的值是2。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务，处于只读状态。")])]),s._v(" "),n("li",[n("p",[s._v("若票数相同，且都获得了 “大多数”成员的投票支持的，数据新的节点获胜。")]),s._v(" "),n("p",[s._v("数据的新旧是通过操作日志oplog来对比的。")])])]),s._v(" "),n("p",[s._v("在获得票数的时候，优先级（priority）参数影响重大。")]),s._v(" "),n("p",[s._v("可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件。")]),s._v(" "),n("p",[s._v("默认情况下，优先级的值是1")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> rs.conf()\n{\n    "_id" : "myrs",\n    "version" : 3,\n    "protocolVersion" : NumberLong(1),\n    "writeConcernMajorityJournalDefault" : true,\n    "members" : [\n        {\n            "_id" : 0,\n            "host" : "180.76.159.126:27017",\n            "arbiterOnly" : false,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 1,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        },\n        {\n            "_id" : 1,\n            "host" : "180.76.159.126:27018",\n            "arbiterOnly" : false,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 1,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        },\n        {\n            "_id" : 2,\n            "host" : "180.76.159.126:27019",\n            "arbiterOnly" : true,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 0,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        }\n    ],\n    "settings" : {\n        "chainingAllowed" : true,\n        "heartbeatIntervalMillis" : 2000,\n        "heartbeatTimeoutSecs" : 10,\n        "electionTimeoutMillis" : 10000,\n        "catchUpTimeoutMillis" : -1,\n        "catchUpTakeoverDelayMillis" : 30000,\n        "getLastErrorModes" : {\n\n        },\n        "getLastErrorDefaults" : {\n            "w" : 1,\n            "wtimeout" : 0\n        },\n        "replicaSetId" : ObjectId("5d539bdcd6a308e600d126bb")\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br")])]),n("p",[s._v("可以看出，主节点和副本节点的优先级各为 1，即，默认可以认为都已经有了一票。但选举节点，优先级是0，（要注意是，官方说了，选举节点的优先级必须是0，不能是别的值。即不具备选举权，但具有投票权）")]),s._v(" "),n("p",[s._v("【了解】修改优先级")]),s._v(" "),n("p",[s._v("比如，下面提升从节点的优先级：")]),s._v(" "),n("p",[s._v("1）先将配置导入cfg变量")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("myrs:SECONDARY> cfg=rs.conf()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("2 ）然后修改值（ID号默认从0开始）")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("myrs:SECONDARY> cfg.members[1].priority=2\n2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("3 ）重新加载配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:SECONDARY> rs.reconfig(cfg)\n{ "ok" : 1 }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("稍等片刻会重新开始选举。")]),s._v(" "),n("h2",{attrs:{id:"_1-7-故障测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-故障测试"}},[s._v("#")]),s._v(" 1.7 故障测试")]),s._v(" "),n("h3",{attrs:{id:"_1-7-1-副本节点故障测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-1-副本节点故障测试"}},[s._v("#")]),s._v(" 1.7.1 副本节点故障测试")]),s._v(" "),n("p",[s._v("关闭27018副本节点：")]),s._v(" "),n("p",[s._v("发现，主节点和仲裁节点对27018的心跳失败。因为主节点还在，因此，没有触发投票选举。")]),s._v(" "),n("p",[s._v("如果此时，在主节点写入数据。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('db.comment.insert({"_id":"1","articleid":"100001","content":"我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。","userid":"1002","nickname":"相忘于江湖","createdatetime":new Date("2019-08-05T22:08:15.522Z"),"likenum":NumberInt(1000),"state":"1"})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("再启动从节点，会发现，主节点写入的数据，会自动同步给从节点。")]),s._v(" "),n("h3",{attrs:{id:"_1-7-2-主节点故障测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-2-主节点故障测试"}},[s._v("#")]),s._v(" 1.7.2 主节点故障测试")]),s._v(" "),n("p",[s._v("关闭27017节点")]),s._v(" "),n("p",[s._v("发现，从节点和仲裁节点对27017的心跳失败，当失败超过10秒，此时因为没有主节点了，会自动发起投票。")]),s._v(" "),n("p",[s._v("而副本节点只有27018，因此，候选人只有一个就是27018，开始投票。")]),s._v(" "),n("p",[s._v("27019向27018投了一票，27018本身自带一票，因此共两票，超过了“大多数”")]),s._v(" "),n("p",[s._v("27019是仲裁节点，没有选举权，27018不向其投票，其票数是0.")]),s._v(" "),n("p",[s._v("最终结果，27018成为主节点。具备读写功能。")]),s._v(" "),n("p",[s._v("在27018写入数据查看。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('db.comment.insert({"_id":"2","articleid":"100001","content":"我夏天空腹喝凉开水，冬天喝温开水","userid":"1005","nickname":"伊人憔悴","createdatetime":new Date("2019-08-05T23:58:51.485Z"),"likenum":NumberInt(888),"state":"1"})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("再启动 27017节点，发现27017变成了从节点，27018仍保持主节点。")]),s._v(" "),n("p",[s._v("登录27017节点，发现是从节点了，数据自动从27018同步。")]),s._v(" "),n("p",[s._v("从而实现了高可用。")]),s._v(" "),n("h3",{attrs:{id:"_1-7-3-仲裁节点和主节点故障"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-3-仲裁节点和主节点故障"}},[s._v("#")]),s._v(" 1.7.3 仲裁节点和主节点故障")]),s._v(" "),n("p",[s._v("先关掉仲裁节点27019，")]),s._v(" "),n("p",[s._v("关掉现在的主节点27018")]),s._v(" "),n("p",[s._v("登录27017后，发现，27017仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入。")]),s._v(" "),n("p",[s._v("为啥不选举了？因为27017的票数，没有获得大多数，即没有大于等于2，它只有默认的一票（优先级是1）")]),s._v(" "),n("p",[s._v("如果要触发选举，随便加入一个成员即可。")]),s._v(" "),n("ul",[n("li",[s._v("如果只加入 27019仲裁节点成员，则主节点一定是27017，因为没得选了，仲裁节点不参与选举，但参与投票。（不演示）")]),s._v(" "),n("li",[s._v("如果只加入 27018节点，会发起选举。因为27017和27018都是两票，则按照谁数据新，谁当主节点。")])]),s._v(" "),n("h3",{attrs:{id:"_1-7-4-仲裁节点和从节点故障"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-4-仲裁节点和从节点故障"}},[s._v("#")]),s._v(" 1.7.4 仲裁节点和从节点故障")]),s._v(" "),n("p",[s._v("先关掉仲裁节点27019，")]),s._v(" "),n("p",[s._v("关掉现在的副本节点27018")]),s._v(" "),n("p",[s._v("10秒后，27017主节点自动降级为副本节点。（服务降级）")]),s._v(" "),n("p",[s._v("副本集不可写数据了，已经故障了。")]),s._v(" "),n("h2",{attrs:{id:"_1-8-compass-连接副本集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-8-compass-连接副本集"}},[s._v("#")]),s._v(" 1.8 Compass 连接副本集")]),s._v(" "),n("p",[s._v("compass连接：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918165004924.png",alt:"image-20200918102748168"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/202009181650221.png",alt:"image-20200918102811874"}})]),s._v(" "),n("h2",{attrs:{id:"_1-9-springdatamongodb-连接副本集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-9-springdatamongodb-连接副本集"}},[s._v("#")]),s._v(" 1.9 SpringDataMongoDB 连接副本集")]),s._v(" "),n("p",[s._v("副本集语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mongodb://host1,host2,host3/articledb?connect=replicaSet&slaveOk=true&replicaSet=副本集名字\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("其中：")]),s._v(" "),n("ul",[n("li",[s._v("slaveOk=true ：开启副本节点读的功能，可实现读写分离。")]),s._v(" "),n("li",[s._v("connect=replicaSet ：自动到副本集中选择读写的主机。如果slaveOK是打开的，则实现了读写分离")])]),s._v(" "),n("p",[s._v("【示例】")]),s._v(" "),n("p",[s._v("连接 replica set 三台服务器 (端口 27017, 27018, 和27019)，直接连接第一个服务器，无论是replica set一部分或者主服务器或者从服务器，写入操作应用在主服务器 并且分布查询到从服务器。")]),s._v(" "),n("p",[s._v("修改配置文件application.yml")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n    #数据源配置\n    data:\n        mongodb:\n            # 主机地址\n            #   host: 180.76.159.126\n            # 数据库\n            #   database: articledb\n            # 默认端口是27017\n            #   port: 27017\n            #也可以使用uri连接\n            #uri: mongodb://192.168.40.134:27017/articledb\n            # 副本集的连接字符串\n            uri: mongodb://180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&slaveOk=true&replicaSet=myrs\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("注意：")]),s._v(" "),n("p",[s._v("主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点。")]),s._v(" "),n("p",[s._v("SpringDataMongoDB自动实现了读写分离：")]),s._v(" "),n("p",[s._v("写操作时，只打开主节点连接；读操作是，同时打开主节点和从节点连接，但使用从节点获取数据。")]),s._v(" "),n("p",[s._v("完整的连接字符串的参考（了解）：")]),s._v(" "),n("p",[s._v("MongoDB客户端连接语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("strong",[s._v("mongodb://")]),s._v(" 这是固定的格式，必须要指定。")]),s._v(" "),n("li",[n("strong",[s._v("username:password@")]),s._v(" 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库")]),s._v(" "),n("li",[n("strong",[s._v("host1")]),s._v(" 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。")]),s._v(" "),n("li",[n("strong",[s._v("portX")]),s._v(" 可选的指定端口，如果不填，默认为27017")]),s._v(" "),n("li",[n("strong",[s._v("/database")]),s._v(" 如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开test 数据库。")]),s._v(" "),n("li",[n("strong",[s._v("?options")]),s._v(" 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&或;（分号）隔开")])]),s._v(" "),n("p",[s._v("标准的连接格式包含了多个选项(options)，如下所示：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("选项")]),s._v(" "),n("th",[s._v("描述")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("replicaSet=name")]),s._v(" "),n("td",[s._v("验证replica set的名称。 Impliesconnect=replicaSet.")])]),s._v(" "),n("tr",[n("td",[s._v("slaveOk=true|false")]),s._v(" "),n("td",[s._v("true:在connect=direct模式下，驱动会连接第一台机器，即使这台服务器不是主。在connect=replicaSet模式下，驱动会发送所有的写请求到主并且把读取操作分布在其他从服务器。false: 在connect=direct模式下，驱动会自动找寻主服务器. 在connect=replicaSet 模式下，驱动仅仅连接主服务器，并且所有的读写命令都连接到主服务器。")])]),s._v(" "),n("tr",[n("td",[s._v("safe=true|false")]),s._v(" "),n("td",[s._v("true: 在执行更新操作之后，驱动都会发送getLastError命令来确保更新成功。(还要参考 wtimeoutMS).false: 在每次更新之后，驱动不会发送getLastError来确保更新成功。")])]),s._v(" "),n("tr",[n("td",[s._v("w=n")]),s._v(" "),n("td",[s._v("驱动添加 { w : n } 到getLastError命令. 应用于safe=true。")])]),s._v(" "),n("tr",[n("td",[s._v("wtimeoutMS=ms")]),s._v(" "),n("td",[s._v("驱动添加 { wtimeout : ms } 到 getlasterror 命令. 应用于 safe=true.")])]),s._v(" "),n("tr",[n("td",[s._v("fsync=true|false")]),s._v(" "),n("td",[s._v("true: 驱动添加 { fsync : true } 到 getlasterror 命令.应用于safe=true.false: 驱动不会添加到getLastError命令中。")])]),s._v(" "),n("tr",[n("td",[s._v("journal=true|false")]),s._v(" "),n("td",[s._v("如果设置为 true, 同步到 journal (在提交到数据库前写入到实体中).应用于 safe=true")])]),s._v(" "),n("tr",[n("td",[s._v("connectTimeoutMS=ms")]),s._v(" "),n("td",[s._v("可以打开连接的时间")])]),s._v(" "),n("tr",[n("td",[s._v("socketTimeoutMS=ms")]),s._v(" "),n("td",[s._v("发送和接受sockets的时间")])])])]),s._v(" "),n("h1",{attrs:{id:"_2-分片集群-sharded-cluster"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-分片集群-sharded-cluster"}},[s._v("#")]),s._v(" 2. 分片集群-Sharded Cluster")]),s._v(" "),n("h2",{attrs:{id:"_2-1-分片概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-分片概念"}},[s._v("#")]),s._v(" 2.1 分片概念")]),s._v(" "),n("p",[s._v("分片（sharding）是一种跨多台机器分布数据的方法， MongoDB使用分片来支持具有非常大的数据集和高吞吐量操作的部署。")]),s._v(" "),n("p",[s._v("换句话说：分片(sharding)是指将数据拆分，将其分散存在不同的机器上的过程。有时也用分区(partitioning)来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机就可以储存更多的数据，处理更多的负载。")]),s._v(" "),n("p",[s._v("具有大型数据集或高吞吐量应用程序的数据库系统可以会挑战单个服务器的容量。例如，高查询率会耗尽服务器的CPU容量。工作集大小大于系统的RAM会强调磁盘驱动器的I / O容量。")]),s._v(" "),n("p",[s._v("有两种解决系统增长的方法：垂直扩展和水平扩展。")]),s._v(" "),n("p",[s._v("垂直扩展意味着增加单个服务器的容量，例如使用更强大的CPU，添加更多RAM或增加存储空间量。可用技术的局限性可能会限制单个机器对于给定工作负载而言足够强大。此外，基于云的提供商基于可用的硬件配置具有硬性上限。结果，垂直缩放有实际的最大值。")]),s._v(" "),n("p",[s._v("水平扩展意味着划分系统数据集并加载多个服务器，添加其他服务器以根据需要增加容量。虽然单个机器的总体速度或容量可能不高，但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率。扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低。权衡是基础架构和部署维护的复杂性增加。")]),s._v(" "),n("p",[s._v("MongoDB支持通过分片进行水平扩展。")]),s._v(" "),n("h2",{attrs:{id:"_2-2-分片集群包含的组件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-分片集群包含的组件"}},[s._v("#")]),s._v(" 2.2 分片集群包含的组件")]),s._v(" "),n("p",[s._v("MongoDB分片群集包含以下组件：")]),s._v(" "),n("ul",[n("li",[s._v("分片（存储）：每个分片包含分片数据的子集。 每个分片都可以部署为副本集。")]),s._v(" "),n("li",[s._v("mongos （路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。")]),s._v(" "),n("li",[s._v("config servers （“调度”的配置）：配置服务器存储群集的元数据和配置设置。 从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS）。")])]),s._v(" "),n("p",[s._v("下图描述了分片集群中组件的交互：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918165044703.png",alt:"image-20200918110216367"}})]),s._v(" "),n("p",[s._v("MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上。")]),s._v(" "),n("h2",{attrs:{id:"_2-3-分片集群架构目标"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-分片集群架构目标"}},[s._v("#")]),s._v(" 2.3 分片集群架构目标")]),s._v(" "),n("p",[s._v("两个分片节点副本集（3+3）+一个配置节点副本集（3）+两个路由节点（2），共11个服务节点。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918165105108.png",alt:"image-20200918110313173"}})]),s._v(" "),n("h2",{attrs:{id:"_2-4-分片-存储-节点副本集的创建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-分片-存储-节点副本集的创建"}},[s._v("#")]),s._v(" 2.4 分片（存储）节点副本集的创建")]),s._v(" "),n("p",[s._v("所有的的配置文件都直接放到 sharded_cluster 的相应的子目录下面，默认配置文件名字：mongod.conf")]),s._v(" "),n("h3",{attrs:{id:"_2-4-1-第一套副本集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-第一套副本集"}},[s._v("#")]),s._v(" 2.4.1 第一套副本集")]),s._v(" "),n("p",[s._v("准备存放数据和日志的目录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------myshardrs01\nmkdir -p /mongodb/sharded_cluster/myshardrs01_27018/log \\ &\nmkdir -p /mongodb/sharded_cluster/myshardrs01_27018/data/db \\ &\n\nmkdir -p /mongodb/sharded_cluster/myshardrs01_27118/log \\ &\nmkdir -p /mongodb/sharded_cluster/myshardrs01_27118/data/db \\ &\n\nmkdir -p /mongodb/sharded_cluster/myshardrs01_27218/log \\ &\nmkdir -p /mongodb/sharded_cluster/myshardrs01_27218/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myshardrs01_27018 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myshardrs01_27018/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #bindIp\n    #绑定的端口\n    port: 27018\nreplication:\n    #副本集的名称\n    replSetName: myshardrs01\nsharding:\n    #分片角色\n    clusterRole: shardsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[s._v("sharding.clusterRole：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Value")]),s._v(" "),n("th",[s._v("Description")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("configsvr")]),s._v(" "),n("td",[s._v("Start this instance as a config server. The instance starts on port 27019 by default.")])]),s._v(" "),n("tr",[n("td",[s._v("shardsvr")]),s._v(" "),n("td",[s._v("Start this instance as a shard . The instance starts on port 27018 by default.")])])])]),s._v(" "),n("p",[s._v("注意：")]),s._v(" "),n("p",[s._v("设置sharding.clusterRole需要mongod实例运行复制。 要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称。")]),s._v(" "),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myshardrs01_27118 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myshardrs01_27118/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27118\nreplication:\n    replSetName: myshardrs01\nsharding:\n    clusterRole: shardsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myshardrs01_27218 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myshardrs01_27218/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.pid"\nnet:\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27218\nreplication:\n    replSetName: myshardrs01\nsharding:\n    clusterRole: shardsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("启动第一套副本集：一主一副本一仲裁")]),s._v(" "),n("p",[s._v("依次启动三个mongod服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123223\nchild process started successfully, parent exiting\n\n[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123292\nchild process started successfully, parent exiting\n\n[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123326\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("查看服务是否启动：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# ps -ef |grep mongod\npolkitd  61622  61604  0 7月31 ?    00:04:29 mongod --bind_ip_all\nroot   123223    1  1 01:10 ?     00:00:01 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf\nroot   123292    1  4 01:11 ?     00:00:00 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf\nroot   123326    1  6 01:11 ?     00:00:00 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"_2-4-1-1-初始化副本集和创建主节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-1-初始化副本集和创建主节点"}},[s._v("#")]),s._v(" 2.4.1.1 初始化副本集和创建主节点：")]),s._v(" "),n("p",[s._v("使用客户端命令连接任意一个节点，但这里尽量要连接主节点：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27018\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行初始化副本集命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.initiate()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看副本集情况")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.status()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("主节点配置查看")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.conf()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_2-4-1-2-添加副本节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-2-添加副本节点"}},[s._v("#")]),s._v(" 2.4.1.2 添加副本节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('rs.add("180.76.159.126:27118")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_2-4-1-3-添加仲裁节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-3-添加仲裁节点"}},[s._v("#")]),s._v(" 2.4.1.3 添加仲裁节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('rs.addArb("180.76.159.126:27218")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看副本集的配置情况")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myshardrs01:PRIMARY> rs.conf()\n{\n    "_id" : "myshardrs01",\n    "version" : 3,\n    "protocolVersion" : NumberLong(1),\n    "writeConcernMajorityJournalDefault" : true,\n    "members" : [\n        {\n            "_id" : 0,\n            "host" : "180.76.159.126:27018",\n            "arbiterOnly" : false,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 1,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        },\n        {\n            "_id" : 1,\n            "host" : "180.76.159.126:27118",\n            "arbiterOnly" : false,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 1,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        },\n        {\n            "_id" : 2,\n            "host" : "180.76.159.126:27218",\n            "arbiterOnly" : true,\n            "buildIndexes" : true,\n            "hidden" : false,\n            "priority" : 0,\n            "tags" : {\n\n            },\n            "slaveDelay" : NumberLong(0),\n            "votes" : 1\n        }\n    ],\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br")])]),n("h3",{attrs:{id:"_2-4-2-第二套副本集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-第二套副本集"}},[s._v("#")]),s._v(" 2.4.2 第二套副本集")]),s._v(" "),n("p",[s._v("准备存放数据和日志的目录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------myshardrs02\nmkdir -p /mongodb/sharded_cluster/myshardrs02_27318/log \\ &\nmkdir -p /mongodb/sharded_cluster/myshardrs02_27318/data/db \\ &\n\nmkdir -p /mongodb/sharded_cluster/myshardrs02_27418/log \\ &\nmkdir -p /mongodb/sharded_cluster/myshardrs02_27418/data/db \\ &\n\nmkdir -p /mongodb/sharded_cluster/myshardrs02_27518/log \\ &\nmkdir -p /mongodb/sharded_cluster/myshardrs02_27518/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myshardrs02_27318 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myshardrs02_27318/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.pid"\nnet:\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27318\nreplication:\n    replSetName: myshardrs02\nsharding:\n    clusterRole: shardsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myshardrs02_27418 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myshardrs02_27418/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27418\nreplication:\n    replSetName: myshardrs02\nsharding:\n    clusterRole: shardsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myshardrs02_27518 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myshardrs02_27518/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27518\nreplication:\n    replSetName: myshardrs02\nsharding:\n    clusterRole: shardsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("启动第二套副本集：一主一副本一仲裁")]),s._v(" "),n("p",[s._v("依次启动三个mongod服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123223\nchild process started successfully, parent exiting\n\n[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123292\nchild process started successfully, parent exiting\n\n[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123326\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("查看服务是否启动：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# ps -ef |grep mongod\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_2-4-2-1-初始化副本集和创建主节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-1-初始化副本集和创建主节点"}},[s._v("#")]),s._v(" 2.4.2.1 初始化副本集和创建主节点")]),s._v(" "),n("p",[s._v("使用客户端命令连接任意一个节点，但这里尽量要连接主节点：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27318\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行初始化副本集命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.initiate()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看副本集情况 (节选内容)：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.status()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("主节点配置查看：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.conf()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_2-4-2-2-添加副本节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-2-添加副本节点"}},[s._v("#")]),s._v(" 2.4.2.2 添加副本节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('rs.add("180.76.159.126:27418")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_2-4-2-3-添加仲裁节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-3-添加仲裁节点"}},[s._v("#")]),s._v(" 2.4.2.3 添加仲裁节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('rs.addArb("180.76.159.126:27518")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看副本集的配置情况")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myshardrs02:PRIMARY> rs.status()\n{\n    "set" : "myshardrs02",\n    "date" : ISODate("2019-07-31T21:38:22.463Z"),\n    "myState" : 1,\n    "term" : NumberLong(1),\n    "syncingTo" : "",\n    "syncSourceHost" : "",\n    "syncSourceId" : -1,\n    "heartbeatIntervalMillis" : NumberLong(2000),\n    "optimes" : {\n        "lastCommittedOpTime" : {\n            "ts" : Timestamp(1564609094, 1),\n            "t" : NumberLong(1)\n        },\n        "readConcernMajorityOpTime" : {\n            "ts" : Timestamp(1564609094, 1),\n            "t" : NumberLong(1)\n        },\n        "appliedOpTime" : {\n            "ts" : Timestamp(1564609094, 1),\n            "t" : NumberLong(1)\n        },\n        "durableOpTime" : {\n            "ts" : Timestamp(1564609094, 1),\n            "t" : NumberLong(1)\n        }\n    },\n    "lastStableCheckpointTimestamp" : Timestamp(1564609074, 1),\n    "members" : [\n        {\n            "_id" : 0,\n            "name" : "180.76.159.126:27318",\n            "health" : 1,\n            "state" : 1,\n            "stateStr" : "PRIMARY",\n            "uptime" : 5086,\n            "optime" : {\n                "ts" : Timestamp(1564609094, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-07-31T21:38:14Z"),\n            "syncingTo" : "",\n            "syncSourceHost" : "",\n            "syncSourceId" : -1,\n            "infoMessage" : "",\n            "electionTime" : Timestamp(1564604032, 2),\n            "electionDate" : ISODate("2019-07-31T20:13:52Z"),\n            "configVersion" : 3,\n            "self" : true,\n            "lastHeartbeatMessage" : ""\n        },\n        {\n            "_id" : 1,\n            "name" : "180.76.159.126:27418",\n            "health" : 1,\n            "state" : 2,\n            "stateStr" : "SECONDARY",\n            "uptime" : 4452,\n            "optime" : {\n                "ts" : Timestamp(1564609094, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDurable" : {\n                "ts" : Timestamp(1564609094, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-07-31T21:38:14Z"),\n            "optimeDurableDate" : ISODate("2019-07-31T21:38:14Z"),\n            "lastHeartbeat" : ISODate("2019-07-31T21:38:21.178Z"),\n            "lastHeartbeatRecv" : ISODate("2019-07-31T21:38:20.483Z"),\n            "pingMs" : NumberLong(0),\n            "lastHeartbeatMessage" : "",\n            "syncingTo" : "180.76.159.126:27518",\n            "syncSourceHost" : "180.76.159.126:27518",\n            "syncSourceId" : 2,\n            "infoMessage" : "",\n            "configVersion" : 3\n        },\n        {\n            "_id" : 2,\n            "name" : "180.76.159.126:27518",\n            "health" : 1,\n            "state" : 2,\n            "stateStr" : "SECONDARY",\n            "uptime" : 4448,\n            "optime" : {\n                "ts" : Timestamp(1564609094, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDurable" : {\n                "ts" : Timestamp(1564609094, 1),\n                "t" : NumberLong(1)\n            },\n            "optimeDate" : ISODate("2019-07-31T21:38:14Z"),\n            "optimeDurableDate" : ISODate("2019-07-31T21:38:14Z"),\n            "lastHeartbeat" : ISODate("2019-07-31T21:38:21.178Z"),\n            "lastHeartbeatRecv" : ISODate("2019-07-31T21:38:22.096Z"),\n            "pingMs" : NumberLong(0),\n            "lastHeartbeatMessage" : "",\n            "syncingTo" : "180.76.159.126:27318",\n            "syncSourceHost" : "180.76.159.126:27318",\n            "syncSourceId" : 0,\n            "infoMessage" : "",\n            "configVersion" : 3\n        }\n    ],\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br")])]),n("h2",{attrs:{id:"_2-5-配置节点副本集的创建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-配置节点副本集的创建"}},[s._v("#")]),s._v(" 2.5 配置节点副本集的创建")]),s._v(" "),n("p",[s._v("第一步：准备存放数据和日志的目录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------configrs\n#建立数据节点data和日志目录\nmkdir -p /mongodb/sharded_cluster/myconfigrs_27019/log \\ &\nmkdir -p /mongodb/sharded_cluster/myconfigrs_27019/data/db \\ &\n\nmkdir -p /mongodb/sharded_cluster/myconfigrs_27119/log \\ &\nmkdir -p /mongodb/sharded_cluster/myconfigrs_27119/data/db \\ &\n\nmkdir -p /mongodb/sharded_cluster/myconfigrs_27219/log \\ &\nmkdir -p /mongodb/sharded_cluster/myconfigrs_27219/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myconfigrs_27019 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myconfigrs_27019/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27019\nreplication:\n    replSetName: myconfigrs\nsharding:\n    clusterRole: configsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myconfigrs_27119")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myconfigrs_27119/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27119\nreplication:\n    replSetName: myconfigrs\nsharding:\n    clusterRole: configsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("myconfigrs_27219")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/sharded_cluster/myconfigrs_27219/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27219\nreplication:\n    replSetName: myconfigrs\nsharding:\n    clusterRole: configsvr\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("启动配置副本集：一主两副本")]),s._v(" "),n("p",[s._v("依次启动三个mongod服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123223\nchild process started successfully, parent exiting\n\n[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123292\nchild process started successfully, parent exiting\n\n[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 123326\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("查看服务是否启动：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# ps -ef |grep mongod\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"_2-5-1-初始化副本集和创建主节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-1-初始化副本集和创建主节点"}},[s._v("#")]),s._v(" 2.5.1 初始化副本集和创建主节点")]),s._v(" "),n("p",[s._v("使用客户端命令连接任意一个节点，但这里尽量要连接主节点：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27019\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行初始化副本集命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.initiate()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看副本集情况 (节选内容)：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.status()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("主节点配置查看：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rs.conf()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"_2-5-2-添加两个副本节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-2-添加两个副本节点"}},[s._v("#")]),s._v(" 2.5.2 添加两个副本节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myshardrs01:PRIMARY> rs.add("180.76.159.126:27119")\nmyshardrs01:PRIMARY> rs.add("180.76.159.126:27219")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("查看副本集的配置情况：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("myshardrs01:PRIMARY> rs.conf()\nmyshardrs01:PRIMARY> rs.status()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"_2-6-路由节点的创建和操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-路由节点的创建和操作"}},[s._v("#")]),s._v(" 2.6 路由节点的创建和操作")]),s._v(" "),n("h3",{attrs:{id:"_2-6-1-第一个路由节点的创建和连接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-1-第一个路由节点的创建和连接"}},[s._v("#")]),s._v(" 2.6.1 第一个路由节点的创建和连接")]),s._v(" "),n("p",[s._v("第一步：准备存放数据和日志的目录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------mongos01\nmkdir -p /mongodb/sharded_cluster/mymongos_27017/log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("mymongos_27017节点：")]),s._v(" "),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vi /mongodb/sharded_cluster/mymongos_27017/mongos.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("mongos.conf：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/mymongos_27017/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: /mongodb/sharded_cluster/mymongos_27017/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #bindIp\n    #绑定的端口\n    port: 27017\nsharding:\n    #指定配置节点副本集\n    configDB: myconfigrs/180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("启动mongos：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# /usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27017/mongos.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 129874\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("提示：启动如果失败，可以查看 log目录下的日志，查看失败原因。")]),s._v(" "),n("p",[s._v("客户端登录mongos")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("此时，写不进去数据，如果写数据会报错：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> use aadb\nswitched to db aadb\nmongos> db.aa.insert({aa:"aa"})\nWriteCommandError({\n    "ok" : 0,\n    "errmsg" : "unable to initialize targeter for write op for collection aa.aa :: caused by :: Database aa not found :: caused by :: No shards found",\n    "code" : 70,\n    "codeName" : "ShardNotFound",\n    "operationTime" : Timestamp(1564600123, 2),\n    "$clusterTime" : {\n    "clusterTime" : Timestamp(1564600123, 2),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("原因：通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据。")]),s._v(" "),n("h3",{attrs:{id:"_2-6-2-在路由节点上进行分片配置操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-2-在路由节点上进行分片配置操作"}},[s._v("#")]),s._v(" 2.6.2 在路由节点上进行分片配置操作")]),s._v(" "),n("p",[s._v("使用命令添加分片：")]),s._v(" "),n("h4",{attrs:{id:"_2-6-2-1-添加分片"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-2-1-添加分片"}},[s._v("#")]),s._v(" 2.6.2.1 添加分片：")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('sh.addShard("IP:Port")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将第一套分片副本集添加进来：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos>sh.addShard("myshardrs01/192.168.0.2:27018,180.76.159.126:27118,180.76.159.126:27218")\n{\n    "shardAdded" : "myshardrs01",\n    "ok" : 1,\n    "operationTime" : Timestamp(1564611970, 4),\n    "$clusterTime" : {\n    "clusterTime" : Timestamp(1564611970, 4),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("查看分片状态情况：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> sh.status()\n--- Sharding Status ---\n    sharding version: {\n        "_id" : 1,\n        "minCompatibleVersion" : 5,\n        "currentVersion" : 6,\n        "clusterId" : ObjectId("5d4211b798f3f9a48522c68b")\n    }\n    shards:\n        {  "_id" : "myshardrs01",  "host" : "myshardrs01/180.76.159.126:27018,180.76.159.126:27118",  "state" : 1 }\n    active mongoses:\n        "4.0.10" : 1\n    autosplit:\n        Currently enabled: yes\n    balancer:\n        Currently enabled:  yes\n        Currently running:  no\n        Failed balancer rounds in last 5 attempts:  0\n        Migration Results for the last 24 hours:\n            No recent migrations\n    databases:\n        {  "_id" : "config",  "primary" : "config",  "partitioned" : true }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("继续将第二套分片副本集添加进来：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos>sh.addShard("myshardrs02/192.168.0.2:27318,180.76.159.126:27418,180.76.159.126:27518")\n{\n    "shardAdded" : "myshardrs02",\n    "ok" : 1,\n    "operationTime" : Timestamp(1564612147, 5),\n    "$clusterTime" : {\n    "clusterTime" : Timestamp(1564612147, 5),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("查看分片状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> sh.status()\n--- Sharding Status ---\n    sharding version: {\n        "_id" : 1,\n        "minCompatibleVersion" : 5,\n        "currentVersion" : 6,\n        "clusterId" : ObjectId("5d4211b798f3f9a48522c68b")\n    }\n    shards:\n        {  "_id" : "myshardrs01",  "host" : "myshardrs01/180.76.159.126:27018,180.76.159.126:27118",  "state" : 1 }\n        {  "_id" : "myshardrs02",  "host" : "myshardrs02/180.76.159.126:27318,180.76.159.126:27418",  "state" : 1 }\n    active mongoses:\n        "4.0.10" : 1\n    autosplit:\n        Currently enabled: yes\n    balancer:\n        Currently enabled:  yes\n        Currently running:  no\n        Failed balancer rounds in last 5 attempts:  0\n        Migration Results for the last 24 hours:\n            No recent migrations\n    databases:\n        {  "_id" : "config",  "primary" : "config",  "partitioned" : true }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片。")]),s._v(" "),n("p",[s._v("移除分片参考(了解)：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('use admin\ndb.runCommand( { removeShard: "myshardrs02" } )\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("注意：如果只剩下最后一个 shard，是无法删除的")]),s._v(" "),n("p",[s._v("移除时会自动转移分片数据，需要一个时间过程。")]),s._v(" "),n("p",[s._v("完成后，再次执行删除分片命令才能真正删除。")]),s._v(" "),n("h4",{attrs:{id:"_2-6-2-2-开启分片功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-2-2-开启分片功能"}},[s._v("#")]),s._v(" 2.6.2.2 开启分片功能")]),s._v(" "),n("p",[s._v("sh.enableSharding(“库名”)、sh.shardCollection(“库名.集合名”,{“key”:1})")]),s._v(" "),n("p",[s._v("在mongos上的articledb数据库配置sharding:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> sh.enableSharding("articledb")\n{\n    "ok" : 1,\n    "operationTime" : Timestamp(1564612296, 5),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1564612296, 5),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("查看分片状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> sh.status()\n--- Sharding Status ---\n    sharding version: {\n        "_id" : 1,\n        "minCompatibleVersion" : 5,\n        "currentVersion" : 6,\n        "clusterId" : ObjectId("5d4211b798f3f9a48522c68b")\n    }\n    shards:\n        {  "_id" : "myshardrs01",  "host" : "myshardrs01/180.76.159.126:27018,180.76.159.126:27118",  "state" : 1 }\n        {  "_id" : "myshardrs02",  "host" : "myshardrs02/180.76.159.126:27318,180.76.159.126:27418",  "state" : 1 }\n    active mongoses:\n        "4.0.10" : 1\n    autosplit:\n        Currently enabled: yes\n    balancer:\n        Currently enabled:  yes\n        Currently running:  no\n        Failed balancer rounds in last 5 attempts:  0\n        Migration Results for the last 24 hours:\n            No recent migrations\n    databases:\n        {  "_id" : "articledb",  "primary" : "myshardrs02",  "partitioned" : true, "version" : {  "uuid" : UUID("788c9a3b-bb6a-4cc2-a597-974694772986"), "lastMod" : 1 } }\n        {  "_id" : "config",  "primary" : "config",  "partitioned" : true }\n            config.system.sessions\n                shard key: { "_id" : 1 }\n                unique: false\n                balancing: true\n                chunks:\n                    myshardrs01   1\n                { "_id" : { "$minKey" : 1 } } --\x3e> { "_id" : { "$maxKey" : 1 } } on : myshardrs01 Timestamp(1, 0)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("h4",{attrs:{id:"_2-6-2-3-集合分片"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-2-3-集合分片"}},[s._v("#")]),s._v(" 2.6.2.3 集合分片")]),s._v(" "),n("p",[s._v("对集合分片，你必须使用 sh.shardCollection() 方法指定集合和分片键")]),s._v(" "),n("p",[s._v("语法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("sh.shardCollection(namespace, key, unique)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("参数：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Parameter")]),s._v(" "),n("th",[s._v("Type")]),s._v(" "),n("th",[s._v("Description")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("namespace")]),s._v(" "),n("td",[s._v("string")]),s._v(" "),n("td",[s._v("要（分片）共享的目标集合的命名空间，格式： .")])]),s._v(" "),n("tr",[n("td",[s._v("key")]),s._v(" "),n("td",[s._v("document")]),s._v(" "),n("td",[s._v("用作分片键的索引规范文档。shard键决定MongoDB如何在shard之间分发文档。除非集合为空，否则索引必须在shardcollection命令之前存在。如果集合为空，则MongoDB在对集合进行分片之前创建索引，前提是支持分片键的索引不存在。简单的说：由包含字段和该字段的索引遍历方向的文档组成。")])]),s._v(" "),n("tr",[n("td",[s._v("unique")]),s._v(" "),n("td",[s._v("boolean")]),s._v(" "),n("td",[s._v("当值为true情况下，片键字段上会限制为确保是唯一索引。哈希策略片键不支持唯一索引。默认是false。")])])])]),s._v(" "),n("p",[s._v("对集合进行分片时,你需要选择一个 片键（Shard Key） , shard key 是每条记录都必须包含的,且建立了索引的单个字段或复合字段,MongoDB按照片键将数据划分到不同的 数据块 中,并将 数据块 均衡地分布到所有分片中.为了按照片键划分数据块,MongoDB使用 基于哈希的分片方式（随机平均分配）或者基于范围的分片方式（数值大小分配） 。")]),s._v(" "),n("p",[s._v("用什么字段当片键都可以，如：nickname作为片键，但一定是必填字段。")]),s._v(" "),n("p",[n("strong",[s._v("分片规则一：哈希策略")])]),s._v(" "),n("p",[s._v("对于 基于哈希的分片 ,MongoDB计算一个字段的哈希值,并用这个哈希值来创建数据块.")]),s._v(" "),n("p",[s._v("在使用基于哈希分片的系统中,拥有”相近”片键的文档 很可能不会 存储在同一个数据块中,因此数据的分离性更好一些.")]),s._v(" "),n("p",[s._v("使用nickname作为片键，根据其值的哈希值进行数据分片")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> sh.shardCollection("articledb.comment",{"nickname":"hashed"})\n{\n    "collectionsharded" : "articledb.comment",\n    "collectionUUID" : UUID("ddea6ed8-ee61-4693-bd16-196acc3a45e8"),\n    "ok" : 1,\n    "operationTime" : Timestamp(1564612840, 28),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1564612840, 28),\n        "signature" : {\n            "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n            "keyId" : NumberLong(0)\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("查看分片状态：sh.status()")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(' databases:\n {  "_id" : "articledb",  "primary" : "myshardrs02",  "partitioned" : true,  "version" : {  "uuid" : UUID("251436b7-86c2-4cd8-9a88-70874af29364"), "lastMod" : 1 } }\n     articledb.comment\n         shard key: { "nickname" : "hashed" }\n         unique: false\n         balancing: true\n         chunks:\n             myshardrs01   2\n             myshardrs02   2\n         { "nickname" : { "$minKey" : 1 } } --\x3e> { "nickname" : NumberLong("-4611686018427387902") } on : myshardrs01 Timestamp(1, 0)\n         { "nickname" : NumberLong("-4611686018427387902") } --\x3e> { "nickname" : NumberLong(0) } on : myshardrs01 Timestamp(1, 1)\n         { "nickname" : NumberLong(0) } --\x3e> { "nickname" : NumberLong("4611686018427387902") } on : myshardrs02 Timestamp(1, 2)\n         { "nickname" : NumberLong("4611686018427387902") } --\x3e> { "nickname" : { "$maxKey" : 1 } } on : myshardrs02 Timestamp(1, 3)\n\n{  "_id" : "config",  "primary" : "config",  "partitioned" : true }\n    config.system.sessions\n        shard key: { "_id" : 1 }\n        unique: false\n        balancing: true\n        chunks:\n            myshardrs01   1\n        { "_id" : { "$minKey" : 1 } } --\x3e> { "_id" : { "$maxKey" : 1 } } on : myshardrs01 Timestamp(1, 0)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[n("strong",[s._v("分片规则二：范围策略")])]),s._v(" "),n("p",[s._v("对于 基于范围的分片 ,MongoDB按照片键的范围把数据分成不同部分.假设有一个数字的片键:想象一个从负无穷到正无穷的直线,每一个片键的值都在直线上画了一个点.MongoDB把这条直线划分为更短的不重叠的片段,并称之为 数据块 ,每个数据块包含了片键在一定范围内的数据.")]),s._v(" "),n("p",[s._v("在使用片键做范围划分的系统中,拥有”相近”片键的文档很可能存储在同一个数据块中,因此也会存储在同一个分片中.")]),s._v(" "),n("p",[s._v("如使用作者年龄字段作为片键，按照点赞数的值进行分片：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> sh.shardCollection("articledb.author",{"age":1})\n{\n    "collectionsharded" : "articledb.author",\n    "collectionUUID" : UUID("9a47bdaa-213a-4039-9c18-e70bfc369df7"),\n    "ok" : 1,\n    "operationTime" : Timestamp(1567512803, 13),\n    "$clusterTime" : {\n        "clusterTime" : Timestamp(1567512803, 13),\n        "signature" : {\n            "hash" : BinData(0,"eE9QT5yE5sL1Tyr7+3U8GRy5+5Q="),\n            "keyId" : NumberLong("6732061237309341726")\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("注意的是：")]),s._v(" "),n("ul",[n("li",[s._v("一个集合只能指定一个片键，否则报错。")]),s._v(" "),n("li",[s._v("一旦对一个集合分片，分片键和分片值就不可改变。 如：不能给集合选择不同的分片键、不能更新分片键的值。")]),s._v(" "),n("li",[s._v("根据age索引进行分配数据。")])]),s._v(" "),n("p",[s._v("查看分片状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('articledb.author\n    shard key: { "age" : 1 }\n    unique: false\n    balancing: true\n    chunks:\n        myshardrs01 1\n    { "age" : { "$minKey" : 1 } } --\x3e> { "age" : { "$maxKey" : 1 } } on : myshardrs01 Timestamp(1, 0)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("基于范围的分片方式与基于哈希的分片方式性能对比：")]),s._v(" "),n("p",[s._v("基于范围的分片方式提供了更高效的范围查询,给定一个片键的范围,分发路由可以很简单地确定哪个数据块存储了请求需要的数据,并将请求转发到相应的分片中.")]),s._v(" "),n("p",[s._v("不过,基于范围的分片会导致数据在不同分片上的不均衡,有时候,带来的消极作用会大于查询性能的积极作用.比如,如果片键所在的字段是线性增长的,一定时间内的所有请求都会落到某个固定的数据块中,最终导致分布在同一个分片中.在这种情况下,一小部分分片承载了集群大部分的数据,系统并不能很好地进行扩展.")]),s._v(" "),n("p",[s._v("与此相比,基于哈希的分片方式以范围查询性能的损失为代价,保证了集群中数据的均衡.哈希值的随机性使数据随机分布在每个数据块中,因此也随机分布在不同分片中.但是也正由于随机性,一个范围查询很难确定应该请求哪些分片,通常为了返回需要的结果,需要请求所有分片.")]),s._v(" "),n("p",[s._v("如无特殊情况，一般推荐使用 Hash Sharding。")]),s._v(" "),n("p",[s._v("而使用 _id 作为片键是一个不错的选择，因为它是必有的，你可以使用数据文档 _id 的哈希作为片键。")]),s._v(" "),n("p",[s._v("这个方案能够是的读和写都能够平均分布，并且它能够保证每个文档都有不同的片键所以数据块能够很精细。")]),s._v(" "),n("p",[s._v("似乎还是不够完美，因为这样的话对多个文档的查询必将命中所有的分片。虽说如此，这也是一种比较好的方案了。")]),s._v(" "),n("p",[s._v("理想化的 shard key 可以让 documents 均匀地在集群中分布：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/2020091816513874.png",alt:"image-20200918121206254"}})]),s._v(" "),n("p",[s._v("显示集群的详细信息：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mongos> db.printShardingStatus()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mongos> sh.isBalancerRunning()\nfalse\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("查看当前 Balancer状态：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mongos> sh.getBalancerState()\ntrue\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"_2-6-3-分片后插入数据测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-3-分片后插入数据测试"}},[s._v("#")]),s._v(" 2.6.3 分片后插入数据测试")]),s._v(" "),n("p",[s._v("测试一（哈希规则）：登录mongs后，向comment循环插入1000条数据做测试：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> use articledb\nswitched to db articledb\nmongos> for(var i=1;i<=1000;i++){db.comment.insert({_id:i+"",nickname:"BoBo"+i})}\nWriteResult({ "nInserted" : 1 })\nmongos> db.comment.count()\n1000\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("提示： js的语法，因为mongo的shell是一个JavaScript的shell。")]),s._v(" "),n("p",[s._v("注意：从路由上插入的数据，必须包含片键，否则无法插入。")]),s._v(" "),n("p",[s._v("分别登陆两个片的主节点，统计文档数量")]),s._v(" "),n("p",[s._v("第一个分片副本集：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27018\n\nmyshardrs01:PRIMARY> use articledb\nswitched to db articledb\nmyshardrs01:PRIMARY> db.comment.count()\n507\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("第二个分片副本集：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27318\n\nmyshardrs02:PRIMARY> use articledb\nswitched to db articledb\nmyshardrs02:PRIMARY> db.comment.count()\n493\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("可以看到， 1000条数据近似均匀的分布到了2个shard上。是根据片键的哈希值分配的。")]),s._v(" "),n("p",[s._v("这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能。")]),s._v(" "),n("p",[s._v("使用db.comment.stats()查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况。")]),s._v(" "),n("p",[s._v("使用sh.status()查看本库内所有集合的分片信息。")]),s._v(" "),n("p",[s._v("测试二（范围规则）：登录mongs后，向comment循环插入1000条数据做测试：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> use articledb\nswitched to db articledb\nmongos> for(var i=1;i<=20000;i++){db.author.save({"name":"BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo"+i,"age":NumberInt(i%120)})}\nWriteResult({ "nInserted" : 1 })\nmongos> db.comment.count()\n20000\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("插入成功后，仍然要分别查看两个分片副本集的数据情况。")]),s._v(" "),n("p",[s._v("分片效果：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('articledb.author\n    shard key: { "age" : 1 }\n    unique: false\n    balancing: true\n    chunks:\n        myshardrs01 2\n        myshardrs02 1\n    { "age" : { "$minKey" : 1 } } --\x3e> { "age" : 0 } on : myshardrs02 Timestamp(2, 0)\n    { "age" : 0 } --\x3e> { "age" : 112 } on : myshardrs01 Timestamp(2, 1)\n    { "age" : 112 } --\x3e> { "age" : { "$maxKey" : 1 } } on : myshardrs01 Timestamp(1, 3)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("如果查看状态发现没有分片，则可能是由于以下原因造成了：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("系统繁忙，正在分片中。")])]),s._v(" "),n("li",[n("p",[s._v("数据块（chunk）没有填满，默认的数据块尺寸（chunksize）是64M，填满后才会考虑向其他片的数据块填充数据，因此，为了测试，可以将其改小，这里改为1M，操作如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('use config\ndb.settings.save( { _id:"chunksize", value: 1 } )\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("测试完改回来：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('db.settings.save( { _id:"chunksize", value: 64 } )\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])]),s._v(" "),n("p",[s._v("注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可。")]),s._v(" "),n("h3",{attrs:{id:"_2-6-4-再增加一个路由节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-4-再增加一个路由节点"}},[s._v("#")]),s._v(" 2.6.4 再增加一个路由节点")]),s._v(" "),n("p",[s._v("文件夹：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#-----------mongos02\nmkdir -p /mongodb/sharded_cluster/mymongos_27117/log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("新建或修改配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vi /mongodb/sharded_cluster/mymongos_27117/mongos.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("mongos.conf：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/sharded_cluster/mymongos_27117/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: /mongodb/sharded_cluster/mymongos_27117/log/mongod.pid"\nnet:\n    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip\n    #bindIpAll: true\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #bindIp\n    #绑定的端口\n    port: 27117\nsharding:\n    configDB: myconfigrs/180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("启动mongos2：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost bin]# /usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27117/mongos.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 129874\nchild process started successfully, parent exiting\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("使用mongo客户端登录27117，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了。")]),s._v(" "),n("h2",{attrs:{id:"_2-7-compass-连接分片集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-compass-连接分片集群"}},[s._v("#")]),s._v(" 2.7 Compass 连接分片集群")]),s._v(" "),n("p",[s._v("compass连接：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/2020091816515942.png",alt:"image-20200918122259273"}})]),s._v(" "),n("p",[s._v("提示：和连接单机 mongod一样。")]),s._v(" "),n("p",[s._v("连接成功后，上方有mongos和分片集群的提示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918165217814.png",alt:"image-20200918122329943"}})]),s._v(" "),n("h2",{attrs:{id:"_2-8-springdatamongdb-连接分片集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-8-springdatamongdb-连接分片集群"}},[s._v("#")]),s._v(" 2.8 SpringDataMongDB 连接分片集群")]),s._v(" "),n("p",[s._v("Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的。")]),s._v(" "),n("p",[s._v("多个路由的时候的SpringDataMongoDB的客户端配置参考如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n    #数据源配置\n    data:\n        mongodb:\n            # 主机地址\n            #   host: 180.76.159.126\n            # 数据库\n            #   database: articledb\n            # 默认端口是27017\n            #   port: 27017\n            #也可以使用uri连接\n            #   uri: mongodb://192.168.40.134:28017/articledb\n            # 连接副本集字符串\n            #   uri: mongodb://180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&slaveOk=true&replicaSet=myrs\n            #连接路由字符串\n            uri: mongodb://180.76.159.126:27017,180.76.159.126:27117/articledb\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("通过日志发现，写入数据的时候，会选择一个路由写入")]),s._v(" "),n("h2",{attrs:{id:"_2-9-清除所有的节点数据-备用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-9-清除所有的节点数据-备用"}},[s._v("#")]),s._v(" 2.9 清除所有的节点数据（备用）")]),s._v(" "),n("p",[s._v("如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作：")]),s._v(" "),n("p",[s._v("第一步：查询出所有的测试服务节点的进程：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost sharded_cluster]# ps -ef |grep mongo\nroot    10184    1  0 06:04 ?     00:01:25 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf\nroot    10219    1  0 06:04 ?     00:01:25 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf\nroot    10253    1  0 06:04 ?     00:00:46 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf\nroot    10312    1  0 06:04 ?     00:01:23 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf\nroot    10346    1  0 06:05 ?     00:01:23 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf\nroot    10380    1  0 06:05 ?     00:00:44 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf\nroot    10414    1  1 06:05 ?     00:01:36 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf\nroot    10453    1  1 06:05 ?     00:01:37 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf\nroot    10492    1  1 06:05 ?     00:01:38 /usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf\nroot    11392    1  0 06:15 ?     00:00:24 /usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27017/mongos.conf\nroot    14829    1  0 07:15 ?     00:00:13 /usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27117/mongos.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("根据上述的进程编号，依次中断进程：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("kill -2 进程编号\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("第二步：清除所有的节点的数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rm -rf /mongodb/sharded_cluster/myconfigrs_27019/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myconfigrs_27119/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myconfigrs_27219/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myshardrs01_27018/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myshardrs01_27118/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myshardrs01_27218/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myshardrs02_27318/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myshardrs02_27418/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/myshardrs02_27518/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/mymongos_27017/data/db/*.* \\ &\nrm -rf /mongodb/sharded_cluster/mymongos_27117/data/db/*.*\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("第三步：查看或修改有问题的配置")]),s._v(" "),n("p",[s._v("第四步：依次启动所有节点，不包括路由节点：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置")]),s._v(" "),n("p",[s._v("第六步：检查路由mongos的配置，并启动mongos")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/mymongos_27017/mongos.cfg\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/mymongos_27017/mongos.cfg\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("第七步：mongo登录mongos，在其上进行相关操作。")]),s._v(" "),n("h1",{attrs:{id:"_3-安全认证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-安全认证"}},[s._v("#")]),s._v(" 3. 安全认证")]),s._v(" "),n("h2",{attrs:{id:"_3-1-mongodb-的用户和角色权限简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-mongodb-的用户和角色权限简介"}},[s._v("#")]),s._v(" 3.1 MongoDB 的用户和角色权限简介")]),s._v(" "),n("p",[s._v("默认情况下，MongoDB实例启动运行时是没有启用用户访问权限控制的，也就是说，在实例本机服务器上都可以随意连接到实例进行各种操作，MongoDB不会对连接客户端进行用户验证，这是非常危险的。")]),s._v(" "),n("p",[s._v("mongodb官网上说，为了能保障mongodb的安全可以做以下几个步骤：")]),s._v(" "),n("ul",[n("li",[s._v("使用新的端口，默认的27017端口如果一旦知道了ip就能连接上，不太安全。")]),s._v(" "),n("li",[s._v("设置mongodb的网络环境，最好将mongodb部署到公司服务器内网，这样外网是访问不到的。公司内部访问使用vpn等。")]),s._v(" "),n("li",[s._v("开启安全认证。认证要同时设置服务器之间的内部认证方式，同时要设置客户端连接到集群的账号密码认证方式。")])]),s._v(" "),n("p",[s._v("为了强制开启用户访问控制(用户验证)，则需要在MongoDB实例启动时使用选项 – auth 或在指定启动配置文件中添加选项 auth=true 。")]),s._v(" "),n("p",[s._v("在开始之前需要了解一下概念")]),s._v(" "),n("p",[s._v("1）启用访问控制：")]),s._v(" "),n("p",[s._v("MongoDB使用的是基于角色的访问控制(Role-Based Access Control,RBAC)来管理用户对实例的访问。通过对用户授予一个或多个角色来控制用户访问数据库资源的权限和数据库操作的权限，在对用户分配角色之前，用户无法访问实例。")]),s._v(" "),n("p",[s._v("在实例启动时添加选项 – auth 或指定启动配置文件中添加选项 auth=true 。")]),s._v(" "),n("p",[s._v("2）角色：")]),s._v(" "),n("p",[s._v("在MongoDB中通过角色对用户授予相应数据库资源的操作权限，每个角色当中的权限可以显式指定，也可以通过继承其他角色的权限，或者两都都存在的权限。")]),s._v(" "),n("p",[s._v("3）权限：")]),s._v(" "),n("p",[s._v("权限由指定的数据库资源(resource)以及允许在指定资源上进行的操作(action)组成。")]),s._v(" "),n("ul",[n("li",[s._v("资源(resource)包括：数据库、集合、部分集合和集群；")]),s._v(" "),n("li",[s._v("操作(action)包括：对资源进行的增、删、改、查(CRUD)操作。")])]),s._v(" "),n("p",[s._v("在角色定义时可以包含一个或多个已存在的角色，新创建的角色会继承包含的角色所有的权限。在同一个数据库中，新创建角色可以继承其他角色的权限，在 admin 数据库中创建的角色可以继承在其它任意数据库中角色的权限。")]),s._v(" "),n("p",[s._v("关于角色权限的查看，可以通过如下命令查询（了解）：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 查询所有角色权限(仅用户自定义角色)\n> db.runCommand({ rolesInfo: 1 })\n\n// 查询所有角色权限(包含内置角色)\n> db.runCommand({ rolesInfo: 1, showBuiltinRoles: true })\n\n// 查询当前数据库中的某角色的权限\n> db.runCommand({ rolesInfo: "<rolename>" })\n// 查询其它数据库中指定的角色权限\n> db.runCommand({ rolesInfo: { role: "<rolename>", db: "<database>" } }\n// 查询多个角色权限\n> db.runCommand(\n    {\n        rolesInfo: [\n            "<rolename>",\n            { role: "<rolename>", db: "<database>" },\n            ...\n        ]  \n    }\n)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("示例：")]),s._v(" "),n("p",[s._v("查看所有内置角色：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('> db.runCommand({ rolesInfo: 1, showBuiltinRoles: true })\n{\n    "roles" : [\n        {\n            "role" : "__queryableBackup",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "__system",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "backup",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "clusterAdmin",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "clusterManager",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "clusterMonitor",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "dbAdmin",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "dbAdminAnyDatabase",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "dbOwner",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "enableSharding",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "hostManager",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "read",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "readAnyDatabase",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "readWrite",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "readWriteAnyDatabase",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "restore",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "root",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "userAdmin",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        },\n        {\n            "role" : "userAdminAnyDatabase",\n            "db" : "admin",\n            "isBuiltin" : true,\n            "roles" : [ ],\n            "inheritedRoles" : [ ]\n        }\n    ],\n    "ok" : 1\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br")])]),n("p",[s._v("常用的内置角色：")]),s._v(" "),n("ul",[n("li",[s._v("数据库用户角色： read、readWrite;")]),s._v(" "),n("li",[s._v("所有数据库用户角色： readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase")]),s._v(" "),n("li",[s._v("数据库管理角色： dbAdmin、dbOwner、userAdmin；")]),s._v(" "),n("li",[s._v("集群管理角色： clusterAdmin、clusterManager、clusterMonitor、hostManager；")]),s._v(" "),n("li",[s._v("备份恢复角色： backup、restore；")]),s._v(" "),n("li",[s._v("超级用户角色： root")]),s._v(" "),n("li",[s._v("内部角色： system")])]),s._v(" "),n("p",[s._v("角色说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("角色")]),s._v(" "),n("th",[s._v("权限描述")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("read")]),s._v(" "),n("td",[s._v("可以读取指定数据库中任何数据")])]),s._v(" "),n("tr",[n("td",[s._v("readWrite")]),s._v(" "),n("td",[s._v("可以读写指定数据库中任何数据，包括创建、重命名、删除集合")])]),s._v(" "),n("tr",[n("td",[s._v("readAnyDatabase")]),s._v(" "),n("td",[s._v("可以读取所有数据库中任何数据(除了数据库config和local之外)")])]),s._v(" "),n("tr",[n("td",[s._v("readWriteAnyDatabase")]),s._v(" "),n("td",[s._v("可以读写所有数据库中任何数据(除了数据库config和local之外)")])]),s._v(" "),n("tr",[n("td",[s._v("userAdminAnyDatabase")]),s._v(" "),n("td",[s._v("可以在指定数据库创建和修改用户(除了数据库config和local之外)")])]),s._v(" "),n("tr",[n("td",[s._v("dbAdminAnyDatabase")]),s._v(" "),n("td",[s._v("可以读取任何数据库以及对数据库进行清理、修改、压缩、获取统计信息、执行检查等操作(除了数据库config和local之外)")])]),s._v(" "),n("tr",[n("td",[s._v("dbAdmin")]),s._v(" "),n("td",[s._v("可以读取指定数据库以及对数据库进行清理、修改、压缩、获取统计信息、执行检查等操作")])]),s._v(" "),n("tr",[n("td",[s._v("userAdmin")]),s._v(" "),n("td",[s._v("可以在指定数据库创建和修改用户")])]),s._v(" "),n("tr",[n("td",[s._v("clusterAdmin")]),s._v(" "),n("td",[s._v("可以对整个集群或数据库系统进行管理操作")])]),s._v(" "),n("tr",[n("td",[s._v("backup")]),s._v(" "),n("td",[s._v("备份MongoDB数据最小的权限")])]),s._v(" "),n("tr",[n("td",[s._v("restore")]),s._v(" "),n("td",[s._v("从备份文件中还原恢复MongoDB数据(除了system.profile集合)的权限")])]),s._v(" "),n("tr",[n("td",[s._v("root")]),s._v(" "),n("td",[s._v("超级账号，超级权限")])])])]),s._v(" "),n("h2",{attrs:{id:"_3-2-单实例环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-单实例环境"}},[s._v("#")]),s._v(" 3.2 单实例环境")]),s._v(" "),n("p",[s._v("目标：对单实例的MongoDB服务开启安全认证，这里的单实例指的是未开启副本集或分片的MongoDB实例。")]),s._v(" "),n("h3",{attrs:{id:"_3-2-1-关闭已开启的服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-关闭已开启的服务"}},[s._v("#")]),s._v(" 3.2.1 关闭已开启的服务")]),s._v(" "),n("p",[s._v("增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加。")]),s._v(" "),n("p",[s._v("本文使用之前搭建好的服务，因此，先停止之前的服务")]),s._v(" "),n("p",[s._v("停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：")]),s._v(" "),n("p",[s._v("（1）快速关闭方法（快速，简单，数据可能会出错）")]),s._v(" "),n("p",[s._v("目标：通过系统的kill命令直接杀死进程：")]),s._v(" "),n("p",[s._v("杀完要检查一下，避免有的没有杀掉。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#通过进程编号关闭节点\nkill -2 54410\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("【补充】")]),s._v(" "),n("p",[s._v("如果一旦是因为数据损坏，则需要进行如下操作（了解）：")]),s._v(" "),n("p",[s._v("1）删除lock文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rm -f /mongodb/single/data/db/*.lock\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("2 ）修复数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod --repair --dbpath=/mongodb/single/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("（2）标准的关闭方法（数据不容易出错，但麻烦）：")]),s._v(" "),n("p",[s._v("目标：通过mongo客户端中的shutdownServer命令来关闭服务")]),s._v(" "),n("p",[s._v("主要的操作步骤参考如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。\nmongo --port 27017\n//#切换到admin库\nuse admin\n//关闭服务\ndb.shutdownServer()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"_3-2-2-添加用户和权限"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-添加用户和权限"}},[s._v("#")]),s._v(" 3.2.2 添加用户和权限")]),s._v(" "),n("p",[s._v("（1）先按照普通无授权认证的配置，来配置服务端的配置文件 /mongodb/single/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('systemLog:\n    #MongoDB发送所有日志输出的目标指定为文件\n    destination: file\n    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径\n    path: "/mongodb/single/log/mongod.log"\n    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。\n    logAppend: true\nstorage:\n    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。\n    dbPath: "/mongodb/single/data/db"\n    journal:\n        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。\n        enabled: true\nprocessManagement:\n    #启用在后台运行mongos或mongod进程的守护进程模式。\n    fork: true\n    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID\n    pidFilePath: "/mongodb/single/log/mongod.pid"\nnet:\n    #服务实例绑定的IP\n    bindIp: localhost,192.168.0.2\n    #绑定的端口\n    port: 27017\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("（2）按之前未开启认证的方式（不添加 – auth 参数）来启动MongoDB服务")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("在操作用户时，启动mongod服务时尽量不要开启授权。")]),s._v(" "),n("p",[s._v("（3）使用Mongo客户端登录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("（4）创建两个管理员用户，一个是系统的超级管理员 myroot ，一个是admin库的管理用户myadmin")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('//切换到admin库\n> use admin\n\n//创建系统超级用户 myroot,设置密码123456，设置角色root\n//> db.createUser({user:"myroot",pwd:"123456",roles:[ { "role" : "root", "db" : "admin" } ]})\n//或\n> db.createUser({user:"myroot",pwd:"123456",roles:["root"]})\n\n//创建专门用来管理admin库的账号myadmin，只用来作为用户权限的管理\n> db.createUser({user:"myadmin",pwd:"123456",roles: [{role:"userAdminAnyDatabase",db:"admin"}]})\n\n//查看已经创建了的用户的情况：\n> db.system.users.find()\n\n//删除用户\n> db.dropUser("myadmin")\ntrue\n\n//修改密码\n> db.changeUserPassword("myroot", "123456")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("ul",[n("li",[s._v("本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即可。如果你对安全要求很高，防止超管泄漏，则不要创建超管用户。")]),s._v(" "),n("li",[s._v("和其它数据库（MySQL）一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对应的表中。Mongodb存储所有的用户信息在admin 数据库的集合system.users中，保存用户名、密码和数据库信息。")]),s._v(" "),n("li",[s._v("如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如 {role: “userAdminAnyDatabase”, db:””}")])]),s._v(" "),n("p",[s._v("（5）认证测试")]),s._v(" "),n("p",[s._v("测试添加的用户是否正确")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('//切换到admin\n> use admin\n\n//密码输错\n> db.auth("myroot","12345")\nError: Authentication failed.\n0\n\n//密码正确\n> db.auth("myroot","123456")\n1\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("（6）创建普通用户")]),s._v(" "),n("p",[s._v("创建普通用户可以在没有开启认证的时候添加，也可以在开启认证之后添加，但开启认证之后，必须使用有操作admin库的用户登录认证后才能操作。底层都是将用户信息保存在了admin数据库的集合system.users中")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('//创建(切换)将来要操作的数据库articledb,\n> use articledb\n\n//创建用户，拥有articledb数据库的读写权限readWrite，密码是123456\n> db.createUser({user: "bobo", pwd: "123456", roles: [{ role: "readWrite", db: "articledb" }]})\n//> db.createUser({user: "bobo", pwd: "123456", roles: ["readWrite"]})\n\n//测试是否可用\n> db.auth("bobo","123456")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户")]),s._v(" "),n("h3",{attrs:{id:"_3-2-3-服务端开启认证和客户端连接登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-服务端开启认证和客户端连接登录"}},[s._v("#")]),s._v(" 3.2.3 服务端开启认证和客户端连接登录")]),s._v(" "),n("h4",{attrs:{id:"_3-2-3-1-关闭已经启动的服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-1-关闭已经启动的服务"}},[s._v("#")]),s._v(" 3.2.3.1 关闭已经启动的服务")]),s._v(" "),n("p",[s._v("1）使用linux命令杀死进程：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost single]# ps -ef |grep mongo\nroot    23482    1  0 08:08 ?     00:00:55 /usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf\n[root@bobohost single]# kill -2 23482\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("2 ）在mongo客户端中使用shutdownServer命令来关闭")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('> db.shutdownServer()\nshutdown command only works with the admin database; try \'use admin\'\n> use admin\nswitched to db admin\n> db.shutdownServer()\n2019-08-14T11:20:16.450+0800 E QUERY  [js] Error: shutdownServer failed: {\n    "ok" : 0,\n    "errmsg" : "shutdown must run from localhost when running db without auth",\n    "code" : 13,\n    "codeName" : "Unauthorized"\n    } :\n_getErrorWithCode@src/mongo/shell/utils.js:25:13\nDB.prototype.shutdownServer@src/mongo/shell/db.js:453:1\n@(shell):1:1\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("需要几个条件：")]),s._v(" "),n("ul",[n("li",[s._v("必须是在 admin库下执行该关闭服务命令。")]),s._v(" "),n("li",[s._v("如果没有开启认证，必须是从 localhost登陆的，才能执行关闭服务命令。")]),s._v(" "),n("li",[s._v("非 localhost的、通过远程登录的，必须有登录且必须登录用户有对admin操作权限才可以。")])]),s._v(" "),n("h4",{attrs:{id:"_3-2-3-2-以开启认证的方式启动服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-2-以开启认证的方式启动服务"}},[s._v("#")]),s._v(" 3.2.3.2 以开启认证的方式启动服务")]),s._v(" "),n("p",[s._v("有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式")]),s._v(" "),n("p",[s._v("1）参数方式")]),s._v(" "),n("p",[s._v("在启动时指定参数 – auth ，如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf --auth\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("2）配置文件方式")]),s._v(" "),n("p",[s._v("在mongod.conf配置文件中加入：vim /mongodb/single/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #开启授权认证\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("启动时可不加 – auth 参数：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_3-2-3-3-开启了认证的情况下的客户端登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-3-开启了认证的情况下的客户端登录"}},[s._v("#")]),s._v(" 3.2.3.3 开启了认证的情况下的客户端登录")]),s._v(" "),n("p",[s._v("有两种认证方式，一种是先登录，在mongo shell中认证；一种是登录时直接认证")]),s._v(" "),n("p",[s._v("1）先连接再认证")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@bobohost bin]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017\nMongoDB shell version v4.0.10\nconnecting to: mongodb://180.76.159.126:27017/?gssapiServiceName=mongodb\nImplicit session: session { "id" : UUID("53fef661-35d6-4d29-b07c-020291d62e1a")}\nMongoDB server version: 4.0.10\n>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("开启认证后再登录，发现打印的日志比较少了。")]),s._v(" "),n("p",[s._v("相关操作需要认证才可以：")]),s._v(" "),n("p",[s._v("查询admin库中的system.users集合的用户：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('> use admin\nswitched to db admin\n> db.system.users.find()\nError: error: {\n    "ok" : 0,\n    "errmsg" : "command find requires authentication",\n    "code" : 13,\n    "codeName" : "Unauthorized"\n}\n> db.auth("myroot","123456")\n1\n> db.system.users.find()\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("查询articledb库中的comment集合的内容：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('> use articledb\nswitched to db articledb\n> db.comment.find()\nError: error: {\n    "ok" : 0,\n    "errmsg" : "not authorized on articledb to execute command { find: \\"comment\\", filter: {}, lsid: { id: UUID(\\"53fef661-35d6-4d29-b07c-020291d62e1a\\") }, $db: \\"articledb\\" }",\n    "code" : 13,\n    "codeName" : "Unauthorized"\n}\n> db.auth("bobo","123456")\n1\n> db.comment.find()\nError: error: {\n    "ok" : 0,\n    "errmsg" : "too many users are authenticated",\n    "code" : 13,\n    "codeName" : "Unauthorized"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了。")]),s._v(" "),n("p",[s._v("解决方案：退出shell，重新进来登录认证")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('> exit\nbye\n[root@bobohost bin]# ./mongo --host 180.76.159.126 --port 27017\nMongoDB shell version v4.0.10\nconnecting to: mongodb://180.76.159.126:27017/?gssapiServiceName=mongodb\nImplicit session: session { "id" : UUID("329c1897-566d-4231-bcb3-b2acda301863")\n}\nMongoDB server version: 4.0.10\n> db.auth("bobo","123456")\nError: Authentication failed.\n0\n> use articledb\nswitched to db articledb\n> db.auth("bobo","123456")\n1\n> db.comment.find()\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("2）连接时直接认证")]),s._v(" "),n("p",[s._v("对admin数据库进行登录认证和相关操作：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017 --authenticationDatabase admin -u myroot -p 123456\nMongoDB shell version v4.0.10\nconnecting to: mongodb://180.76.159.126:27017/?\nauthSource=admin&gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"f959b8d6-6994-44bc-9d35-09fc7cd00ba6\")\n}\nMongoDB server version: 4.0.10\nServer has startup warnings:\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING: You are\nrunning this process as the root user, which is not recommended.\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING:\n/sys/kernel/mm/transparent_hugepage/enabled is 'always'.\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] **    We suggest\nsetting it to 'never'\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING:\n/sys/kernel/mm/transparent_hugepage/defrag is 'always'.\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] **    We suggest\nsetting it to 'never'\n2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]\n> show dbs;\nadmin    0.000GB\narticledb  0.000GB\nconfig   0.000GB\nlocal    0.000GB\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("对articledb数据库进行登录认证和相关操作：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@bobohost bin]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017 --authenticationDatabase articledb -u bobo -p 123456\nMongoDB shell version v4.0.10\nconnecting to: mongodb://180.76.159.126:27017/?\nauthSource=articledb&gssapiServiceName=mongodb\nImplicit session: session { "id" : UUID("e5d4148f-373b-45b8-9cff-a927ce617100")\n}\nMongoDB server version: 4.0.10\n> use articledb\nswitched to db articledb\n> db.comment.find()\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("-u")]),s._v(" ：用户名")]),s._v(" "),n("li",[n("code",[s._v("-p")]),s._v(" ：密码")]),s._v(" "),n("li",[n("code",[s._v("-- authenticationDatabase")]),s._v(" ：指定连接到哪个库。当登录是指定用户名密码时，必须指定对应的数据库！")])]),s._v(" "),n("h3",{attrs:{id:"_3-2-4-springdatamongodb连接认证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-springdatamongodb连接认证"}},[s._v("#")]),s._v(" 3.2.4 SpringDataMongoDB连接认证")]),s._v(" "),n("p",[s._v("使用用户名和密码连接到 MongoDB 服务器，你必须使用"),n("code",[s._v("'username:password@hostname/dbname'")]),s._v(" 格式，’username’为用户名，’password’ 为密码。")]),s._v(" "),n("p",[s._v("目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上。")]),s._v(" "),n("p",[s._v("application.yml：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n    #数据源配置\n    data:\n        mongodb:\n            # 主机地址\n            #   host: 180.76.159.126\n            # 数据库\n            #   database: articledb\n            # 默认端口是27017\n            #   port: 27017\n            #帐号\n            #   username: bobo\n            #密码\n            #   password: 123456\n            #单机有认证的情况下，也使用字符串连接\n            uri: mongodb://bobo:123456@180.76.159.126:27017/articledb\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h2",{attrs:{id:"_3-3-副本集环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-副本集环境"}},[s._v("#")]),s._v(" 3.3 副本集环境")]),s._v(" "),n("h3",{attrs:{id:"_3-3-1-前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-前言"}},[s._v("#")]),s._v(" 3.3.1 前言")]),s._v(" "),n("p",[s._v("对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录。")]),s._v(" "),n("p",[s._v("副本集环境使用之前搭建好的，架构如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200918165235785.png",alt:"image-20200918145643639"}})]),s._v(" "),n("p",[s._v("对副本集执行访问控制需要配置两个方面 :")]),s._v(" "),n("ul",[n("li",[s._v("副本集和共享集群的各个节点成员之间使用内部身份验证，可以使用密钥文件或x.509证书。密钥文件比较简单，本文使用密钥文件，官方推荐如果是测试环境可以使用密钥文件，但是正式环境，官方推荐x.509证书。原理就是，集群中每一个实例彼此连接的时候都检验彼此使用的证书的内容是否相同。只有证书相同的实例彼此才可以访问")]),s._v(" "),n("li",[s._v("使用客户端连接到mongodb集群时，开启访问授权。对于集群外部的访问。如通过可视化客户端，或者通过代码连接的时候，需要开启授权。")])]),s._v(" "),n("p",[s._v("在keyfile身份验证中，副本集中的每个mongod实例都使用keyfile的内容作为共享密码，只有具有正确密钥文件的mongod或者mongos实例可以连接到副本集。密钥文件的内容必须在6到1024个字符之间，并且在unix/linux系统中文件所有者必须有对文件至少有读的权限。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-2-关闭已开启的副本集服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-关闭已开启的副本集服务"}},[s._v("#")]),s._v(" 3.3.2 关闭已开启的副本集服务")]),s._v(" "),n("p",[s._v("增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加。")]),s._v(" "),n("p",[s._v("本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务")]),s._v(" "),n("p",[s._v("停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：")]),s._v(" "),n("p",[s._v("（1）快速关闭方法（快速，简单，数据可能会出错）")]),s._v(" "),n("p",[s._v("目标：通过系统的kill命令直接杀死进程：")]),s._v(" "),n("p",[s._v("依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#通过进程编号关闭节点\nkill -2 54410\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("【补充】")]),s._v(" "),n("p",[s._v("如果一旦是因为数据损坏，则需要进行如下操作（了解）：")]),s._v(" "),n("p",[s._v("1）删除lock文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rm -f /mongodb/replica_sets/myrs_27017/data/db/*.lock \\\n/mongodb/replica_sets/myrs_27018/data/db/*.lock \\\n/mongodb/replica_sets/myrs_27019/data/db/mongod.lock \\\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("2 ）依次修复数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod --repair --dbpath=/mongodb/replica_sets/myrs_27017/data/db\n/usr/local/mongodb/bin/mongod --repair --dbpath=/mongodb/replica_sets/myrs_27018/data/db\n/usr/local/mongodb/bin/mongod --repair --dbpath=/mongodb/replica_sets/myrs_27019/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("（2）标准的关闭方法（数据不容易出错，但麻烦）")]),s._v(" "),n("p",[s._v("目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务")]),s._v(" "),n("p",[s._v("关闭副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。\nmongo --port 27017\n//告知副本集说本机要下线\nrs.stepDown()\n//#切换到admin库\nuse admin\n//关闭服务\ndb.shutdownServer()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"_3-3-3-通过主节点添加一个管理员帐号"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-3-通过主节点添加一个管理员帐号"}},[s._v("#")]),s._v(" 3.3.3 通过主节点添加一个管理员帐号")]),s._v(" "),n("p",[s._v("只需要在主节点上添加用户，副本集会自动同步。")]),s._v(" "),n("p",[s._v("开启认证之前，创建超管用户：myroot，密码：123456")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('myrs:PRIMARY> use admin\nswitched to db admin\nmyrs:PRIMARY> db.createUser({user:"myroot",pwd:"123456",roles:["root"]})\nSuccessfully added user: { "user" : "myroot", "roles" : [ "root" ] }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集。")]),s._v(" "),n("p",[s._v("后续再创建其他用户，都可以使用该超管用户创建。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-4-创建副本集认证的key文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-4-创建副本集认证的key文件"}},[s._v("#")]),s._v(" 3.3.4 创建副本集认证的key文件")]),s._v(" "),n("p",[s._v("第一步：生成一个key文件到当前文件夹中。")]),s._v(" "),n("p",[s._v("可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost ~]# openssl rand -base64 90 -out ./mongo.keyfile\n[root@bobohost ~]# chmod 400 ./mongo.keyfile\n[root@bobohost ~]# ll mongo.keyfile\n-r--------. 1 root root 122 8月  14 14:23 mongo.keyfile\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须有读的权限，否则将来会报错： permissions on /mongodb/replica_sets/myrs_27017/mongo.keyfile are too open")]),s._v(" "),n("p",[s._v("一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置，都放到和配置文件一起的目录中。")]),s._v(" "),n("p",[s._v("这里将该文件分别拷贝到多个目录中：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost ~]# cp mongo.keyfile /mongodb/replica_sets/myrs_27017\n[root@bobohost ~]# cp mongo.keyfile /mongodb/replica_sets/myrs_27018\n[root@bobohost ~]# cp mongo.keyfile /mongodb/replica_sets/myrs_27019\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"_3-3-5-修改配置文件指定keyfile"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-5-修改配置文件指定keyfile"}},[s._v("#")]),s._v(" 3.3.5 修改配置文件指定keyfile")]),s._v(" "),n("p",[s._v("分别编辑几个服务的mongod.conf文件，添加相关内容")]),s._v(" "),n("p",[s._v("/mongodb/replica_sets/myrs_27017/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/replica_sets/myrs_27017/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/replica_sets/myrs_27018/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/replica_sets/myrs_27018/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/replica_sets/myrs_27019/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/replica_sets/myrs_27019/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_3-3-6-重新启动副本集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-6-重新启动副本集"}},[s._v("#")]),s._v(" 3.3.6 重新启动副本集")]),s._v(" "),n("p",[s._v("如果副本集是开启状态，则先分别关闭关闭复本集中的每个mongod，从次节点开始。直到副本集的所有成员都离线，包括任何仲裁者。主节点必须是最后一个成员关闭以避免潜在的回滚。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#通过进程编号关闭三个节点\nkill -2 54410 54361 54257\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("分别启动副本集节点：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("查看进程情况：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost replica_sets]# ps -ef |grep mongod\nroot    62425    1  5 14:43 ?     00:00:01 /usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf\nroot    62495    1  7 14:43 ?     00:00:01 /usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf\nroot    62567    1 11 14:43 ?     00:00:01 /usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"_3-3-7-在主节点上添加普通账号"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-7-在主节点上添加普通账号"}},[s._v("#")]),s._v(" 3.3.7 在主节点上添加普通账号")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('#先用管理员账号登录\n#切换到admin库\nuse admin\n#管理员账号认证\ndb.auth("myroot","123456")\n#切换到要认证的库\nuse articledb\n#添加普通用户\ndb.createUser({user: "bobo", pwd: "123456", roles: ["readWrite"]})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("重新连接，使用普通用户 bobo重新登录，查看数据。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-8-springdatamongodb连接副本集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-8-springdatamongodb连接副本集"}},[s._v("#")]),s._v(" 3.3.8 SpringDataMongoDB连接副本集")]),s._v(" "),n("p",[s._v("使用用户名和密码连接到 MongoDB 服务器，你必须使用"),n("code",[s._v("'username:password@hostname/dbname'")]),s._v(" 格式，’username’为用户名，’password’ 为密码。")]),s._v(" "),n("p",[s._v("目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上。")]),s._v(" "),n("p",[s._v("application.yml：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n    #数据源配置\n    data:\n        mongodb:\n            #副本集有认证的情况下，字符串连接\n            uri: mongodb://bobo:123456@180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&slaveOk=true&replicaSet=myrs\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"_3-4-分片集群环境-扩展"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-分片集群环境-扩展"}},[s._v("#")]),s._v(" 3.4 分片集群环境(扩展)")]),s._v(" "),n("h3",{attrs:{id:"_3-4-1-关闭已开启的集群服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-关闭已开启的集群服务"}},[s._v("#")]),s._v(" 3.4.1 关闭已开启的集群服务")]),s._v(" "),n("p",[s._v("分片集群环境下的安全认证和副本集环境下基本上一样。")]),s._v(" "),n("p",[s._v("但分片集群的服务器环境和架构较为复杂，建议在搭建分片集群的时候，直接加入安全认证和服务器间的鉴权，如果之前有数据，可先将之前的数据备份出来，再还原回去。")]),s._v(" "),n("p",[s._v("本文使用之前搭建好的集群服务，因此，先停止之前的集群服务")]),s._v(" "),n("p",[s._v("停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：")]),s._v(" "),n("p",[s._v("（1）快速关闭方法（快速，简单，数据可能会出错）")]),s._v(" "),n("p",[s._v("目标：通过系统的kill命令直接杀死进程：")]),s._v(" "),n("p",[s._v("依次杀死 mongos路由、配置副本集服务，分片副本集服务，从次节点开始。直到所有成员都离线。副本集杀的时候，建议先杀仲裁者，再杀副本节点，最后是主节点，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#通过进程编号关闭节点\nkill -2 54410\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("【补充】")]),s._v(" "),n("p",[s._v("如果一旦是因为数据损坏，则需要进行如下操作（了解）：")]),s._v(" "),n("p",[s._v("1）删除lock文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rm -f /mongodb/sharded_cluster/myshardrs01_27018/data/db/*.lock \\\n/mongodb/sharded_cluster/myshardrs01_27118/data/db/*.lock \\\n/mongodb/sharded_cluster/myshardrs01_27218/data/db/mongod.lock \\\n/mongodb/sharded_cluster/myshardrs02_27318/data/db/mongod.lock \\\n/mongodb/sharded_cluster/myshardrs02_27418/data/db/mongod.lock \\\n/mongodb/sharded_cluster/myshardrs02_27518/data/db/mongod.lock \\\n/mongodb/sharded_cluster/myconfigrs_27019/data/db/mongod.lock \\\n/mongodb/sharded_cluster/myconfigrs_27119/data/db/mongod.lock \\\n/mongodb/sharded_cluster/myconfigrs_27219/data/db/mongod.lock\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("2 ）依次修复数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myshardrs01_27018/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myshardrs01_27118/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myshardrs01_27218/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myshardrs02_27318/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myshardrs02_27418/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myshardrs02_27518/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myconfigrs_27019/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myconfigrs_27119/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/myconfigrs_27219/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/mymongos_27017/data/db\n/usr/local/mongodb/bin/mongod --repair --\ndbpath=/mongodb/sharded_cluster/mymongos_27117/data/db\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("（2）标准的关闭方法（数据不容易出错，但麻烦）：")]),s._v(" "),n("p",[s._v("目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务")]),s._v(" "),n("p",[s._v("关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。\nmongo --port 27018\n//告知副本集说本机要下线\nrs.stepDown()\n//#切换到admin库\nuse admin\n//关闭服务\ndb.shutdownServer()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。\nmongo --port 27019\n//告知副本集说本机要下线\nrs.stepDown()\n//#切换到admin库\nuse admin\n//关闭服务\ndb.shutdownServer()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。\nmongo --port 27017\n//告知副本集说本机要下线\nrs.stepDown()\n//#切换到admin库\nuse admin\n//关闭服务\ndb.shutdownServer()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"_3-4-2-创建副本集认证的key文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-创建副本集认证的key文件"}},[s._v("#")]),s._v(" 3.4.2 创建副本集认证的key文件")]),s._v(" "),n("p",[s._v("第一步：生成一个key文件到当前文件夹中。")]),s._v(" "),n("p",[s._v("可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost ~]# openssl rand -base64 90 -out ./mongo.keyfile\n[root@bobohost ~]# chmod 400 ./mongo.keyfile\n[root@bobohost ~]# ll mongo.keyfile\n-r--------. 1 root root 122 8月  14 14:23 mongo.keyfile\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须\n有读的权限，否则将来会报错： permissions on /mongodb/replica_sets/myrs_27017/mongo.keyfile are too open")]),s._v(" "),n("p",[s._v("一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置，都放到和配置文件一起的目录中。")]),s._v(" "),n("p",[s._v("这里将该文件分别拷贝到多个目录中：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("echo '/mongodb/sharded_cluster/myshardrs01_27018/mongo.keyfile\n/mongodb/sharded_cluster/myshardrs01_27118/mongo.keyfile\n/mongodb/sharded_cluster/myshardrs01_27218/mongo.keyfile\n/mongodb/sharded_cluster/myshardrs02_27318/mongo.keyfile\n/mongodb/sharded_cluster/myshardrs02_27418/mongo.keyfile\n/mongodb/sharded_cluster/myshardrs02_27518/mongo.keyfile\n/mongodb/sharded_cluster/myconfigrs_27019/mongo.keyfile\n/mongodb/sharded_cluster/myconfigrs_27119/mongo.keyfile\n/mongodb/sharded_cluster/myconfigrs_27219/mongo.keyfile\n/mongodb/sharded_cluster/mymongos_27017/mongo.keyfile\n/mongodb/sharded_cluster/mymongos_27117/mongo.keyfile' | xargs -n 1 cp -v /root/mongo.keyfile\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"_3-4-3-修改配置文件指定keyfile"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-3-修改配置文件指定keyfile"}},[s._v("#")]),s._v(" 3.4.3 修改配置文件指定keyfile")]),s._v(" "),n("p",[s._v("分别编辑几个服务的mongod.conf文件，添加相关内容：")]),s._v(" "),n("p",[s._v("/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myshardrs01_27018/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myshardrs01_27118/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myshardrs01_27218/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myshardrs02_27318/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myshardrs02_27418/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myshardrs02_27518/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myconfigrs_27019/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myconfigrs_27119/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/myconfigrs_27219/mongo.keyfile\n    #开启认证方式运行\n    authorization: enabled\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/mymongos_27017/mongos.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/mymongos_27017/mongo.keyfile\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("/mongodb/sharded_cluster/mymongos_27117/mongos.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("security:\n    #KeyFile鉴权文件\n    keyFile: /mongodb/sharded_cluster/mymongos_27117/mongo.keyfile\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("mongos 比mongod少了authorization：enabled的配置。原因是，副本集加分片的安全认证需要配置两方面的，副本集各个节点之间使用内部身份验证，用于内部各个mongo实例的通信，只有相同keyfile才能相互访问。所以都要开启 keyFile: /mongodb/sharded_cluster/mymongos_27117/mongo.keyfile 。")]),s._v(" "),n("p",[s._v("然而对于所有的mongod，才是真正的保存数据的分片。mongos只做路由，不保存数据。所以所有的mongod开启访问数据的授权authorization:enabled。这样用户只有账号密码正确才能访问到数据。")]),s._v(" "),n("h3",{attrs:{id:"_3-4-4-重新启动节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-4-重新启动节点"}},[s._v("#")]),s._v(" 3.4.4 重新启动节点")]),s._v(" "),n("p",[s._v("必须依次启动配置节点、分片节点、路由节点：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf\n/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf\n/usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27017/mongos.conf\n/usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27117/mongos.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("注意：")]),s._v(" "),n("p",[s._v("这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点。")]),s._v(" "),n("p",[s._v("如果先启动分片节点，会卡住，提示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("about to fork child process, waiting until server is ready for connections\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这也许是个 bug。原因未知。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-5-创建帐号和认证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-5-创建帐号和认证"}},[s._v("#")]),s._v(" 3.3.5 创建帐号和认证")]),s._v(" "),n("p",[s._v("客户端mongo，通过localhost登录任意一个mongos路由，")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@bobohost db]# /usr/local/mongodb/bin/mongo --port 27017\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("提示：相当于一个后门，只能在 admin下添加用户。")]),s._v(" "),n("p",[s._v("创建一个管理员帐号：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> use admin\nswitched to db admin\nmongos>  db.createUser({user:"myroot",pwd:"123456",roles:["root"]})\nSuccessfully added user: { "user" : "myroot", "roles" : [ "root" ] }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略")]),s._v(" "),n("p",[s._v("创建一个普通权限帐号：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> use admin\nswitched to db admin\nmongos> db.auth("myroot","123456")\n1\nmongos> use articledb\nswitched to db articledb\nmongos> db.createUser({user: "bobo", pwd: "123456", roles: [{ role: "readWrite",db: "articledb" }]})\nSuccessfully added user: {\n    "user" : "bobo",\n    "roles" : [\n        {\n          "role" : "readWrite",\n          "db" : "articledb"\n        }\n    ]\n}\nmongos> db.auth("bobo","123456")\n1\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("提示：")]),s._v(" "),n("p",[s._v("通过mongos添加的账号信息，只会保存到配置节点的服务中，具体的数据节点不保存账号信息，因此，分片中的账号信息不涉及到同步问题。")]),s._v(" "),n("p",[s._v("mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('mongos> use admin\nswitched to db admin\nmongos>  db.auth("myroot","123456")\n1\nmongos> sh.status()\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("退出连接，重新连接服务，使用普通权限帐号访问数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@bobohost db]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017\nMongoDB shell version v4.0.10\nconnecting to: mongodb://180.76.159.126:27017/?gssapiServiceName=mongodb\nImplicit session: session { "id" : UUID("6f84fa91-2414-407e-b3ab-c0b7eedde825")\n}\nMongoDB server version: 4.0.10\nmongos> use articledb\nswitched to db articledb\nmongos> db.auth("bobo","123456")\n1\nmongos> show collections\ncomment\ncomment2\nmongos> db.comment.count()\n10001\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"_3-3-6-springdatamongodb连接认证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-6-springdatamongodb连接认证"}},[s._v("#")]),s._v(" 3.3.6 SpringDataMongoDB连接认证")]),s._v(" "),n("p",[s._v("使用用户名和密码连接到 MongoDB 服务器，你必须使用"),n("code",[s._v("'username:password@hostname/dbname'")]),s._v(" 格式，’username’为用户名，’password’ 为密码。")]),s._v(" "),n("p",[s._v("目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上。")]),s._v(" "),n("p",[s._v("application.yml：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n    #数据源配置\n    data:\n        mongodb:\n        # 分片集群有认证的情况下，字符串连接\n            uri: mongodb://bobo:123456@180.76.159.126:27017,180.76.159.126:27117/articledb\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("原文链接：https://wgy1993.gitee.io/archives/afe7047c.html")])])}),[],!1,null,null,null);n.default=t.exports}}]);