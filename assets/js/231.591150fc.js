(window.webpackJsonp=window.webpackJsonp||[]).push([[231],{584:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("Expect是一个用来处理交互的工具，通常用于需要手动输入数据的场景，可在脚本中使用expect来实现自动化。")]),s._v(" "),t("h3",{attrs:{id:"一、安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、安装"}},[s._v("#")]),s._v(" 一、安装")]),s._v(" "),t("p",[s._v("首先查看系统中是否有安装expect。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("whereis")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Expect工具是依赖tcl的，所以也需要安装tcl。")]),s._v(" "),t("p",[s._v("首先下载并安装tcl，这里安装8.4.19版本")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget https://sourceforge.net/projects/tcl/files/Tcl/8.4.19/tcl8.4.19-src.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf tcl8.4.19-src.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd tcl8.4.19/unix && ./configure")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("然后下载expect并安装。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget http://sourceforge.net/projects/expect/files/Expect/5.45/expect5.45.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf expect5.45.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd expect5.45")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./configure --with-tcl=/usr/local/lib --with-tclinclude=../tcl8.4.19/generic")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ln -s /usr/local/bin/expect /usr/bin/expect")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("注意这里的configure命令需要使用–with-tclinclude选项传入tcl安装包中的generic文件夹路径。")]),s._v(" "),t("p",[s._v("安装完成之后运行expect命令，查看是否安装成功。")]),s._v(" "),t("p",[t("strong",[s._v("基本操作")])]),s._v(" "),t("p",[s._v("Expect脚本中常用的命令包括spawn, expect, send, interact等。")]),s._v(" "),t("p",[t("strong",[s._v("spawn")])]),s._v(" "),t("p",[s._v("该命令用于启动一个子进程，执行后续命令")]),s._v(" "),t("p",[t("strong",[s._v("expect")])]),s._v(" "),t("p",[s._v("该命令从进程接受字符串，如果接受的字符串和期待的字符串不匹配，则一直阻塞，直到匹配上或者等待超时才继续往下执行")]),s._v(" "),t("p",[t("strong",[s._v("send")])]),s._v(" "),t("p",[s._v("向进程发送字符串，与手动输入内容等效，通常字符串需要以’\\r’结尾。")]),s._v(" "),t("p",[t("strong",[s._v("interact")])]),s._v(" "),t("p",[s._v("该命令将控制权交给控制台，之后就可以进行人工操作了。通常用于使用脚本进行自动化登录之后再手动执行某些命令。如果脚本中没有这一条语句，脚本执行完将自动退出。")]),s._v(" "),t("p",[t("strong",[s._v("set timeout 30")])]),s._v(" "),t("p",[s._v("设置超时时间timeout为30s，expect命令阻塞超时时会自动往下继续执行。将timeout配置为-1时表示expect一直阻塞直到与期待的字符串匹配上才继续往下执行。超时时间timeout默认为10s。")]),s._v(" "),t("p",[t("strong",[s._v("[lindex $argv n]")])]),s._v(" "),t("p",[s._v("可以在脚本中使用该命令获取在脚本执行时传入的第n个参数。这里argv为传入的参数，另外argc表示传入参数的个数，$argv0表示脚本名字。")]),s._v(" "),t("p",[s._v("另外我们也可以使用[lrange $argv sn en]命令获取第sn到第en个参数。")]),s._v(" "),t("p",[t("strong",[s._v("实例解析")])]),s._v(" "),t("p",[s._v("这里我们写一个脚本，命名为restart_service.exp，该脚本先切换到指定账户，然后下载软件包到tomcat的webapps目录，然后重启tomcat服务。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/expect")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" user "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("lindex "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$argv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" password "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("lindex "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$argv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" cmd_prompt "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"# "')]),s._v("\n\nspawn "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${user}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cmd_prompt}")]),s._v("\nsend "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${password}")]),t("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[s._v("\\r")]),s._v('"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cmd_prompt}")]),s._v("\nsend "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cd /opt/tomcat/webapps && wget http://host/path/to/package.war'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[s._v("\\r")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"100%"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 直到wget下载任务打印出100%才表示软件包下载完成")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cmd_prompt}")]),s._v("\nsend "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/tomcat/bin/shutdown.sh'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[s._v("\\r")]),s._v('"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cmd_prompt}")]),s._v("\nsend "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/tomcat/bin/startup.sh'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[s._v("\\r")]),s._v('"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expect")]),s._v(" eof\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#interact")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有脚本必须以expect eof或者interact结束，一般自动化脚本以expect eof结束就行了")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);