(window.webpackJsonp=window.webpackJsonp||[]).push([[88],{441:function(s,a,n){"use strict";n.r(a);var e=n(0),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("对于Kubernetes的Service，无论是Cluster-Ip和NodePort均是四层的负载，集群内的服务如何实现七层的负载均衡，这就需要借助于Ingress，Ingress控制器的实现方式有很多，比如nginx, Contour, Haproxy, trafik, Istio。")])]),s._v(" "),a("p",[s._v("几种常用的ingress功能对比和选型： https://www.kubernetes.org.cn/5948.html")]),s._v(" "),a("h3",{attrs:{id:"实现逻辑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现逻辑"}},[s._v("#")]),s._v(" 实现逻辑")]),s._v(" "),a("p",[s._v("Ingress-nginx是7层的负载均衡器 ，负责统一管理外部对k8s cluster中Service的请求。主要包含：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("ingress-nginx-controller：根据用户编写的ingress规则（创建的ingress的yaml文件），动态的去更改nginx服务的配置文件，并且reload重载使其生效（是自动化的，通过lua脚本来实现）；")])]),s._v(" "),a("li",[a("p",[s._v("Ingress资源对象：将Nginx的配置抽象成一个Ingress对象")])])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("ingress controller通过和kubernetes api交互，动态的去感知集群中ingress规则变化")])]),s._v(" "),a("li",[a("p",[s._v("然后读取ingress规则(规则就是写明了哪个域名对应哪个service)，按照自定义的规则，生成一段nginx配置")])]),s._v(" "),a("li",[a("p",[s._v("再写到nginx-ingress-controller的pod里，这个Ingress controller的pod里运行着一个Nginx服务，控制器把生成的nginx配置写入/etc/nginx/nginx.conf文件中")])]),s._v(" "),a("li",[a("p",[s._v("然后reload一下使配置生效。以此达到域名分别配置和动态更新的问题。")])])]),s._v(" "),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("官方文档： https://kubernetes.github.io/ingress-nginx/deploy/")])]),s._v(" "),a("li",[a("p",[s._v("部署文档： https://github.com/kubernetes/ingress-nginx/blob/nginx-0.30.0/docs/deploy/index.md")])]),s._v(" "),a("li",[a("p",[s._v("K8S Annotations文档：  https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors")])])]),s._v(" "),a("h3",{attrs:{id:"support-versions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#support-versions"}},[s._v("#")]),s._v(" Support Versions")]),s._v(" "),a("p",[a("strong",[s._v("官网地址：")]),s._v(" https://github.com/kubernetes/ingress-nginx")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Ingress-NGINX version")]),s._v(" "),a("th",[s._v("k8s supported version")]),s._v(" "),a("th",[s._v("Alpine Version")]),s._v(" "),a("th",[s._v("Nginx Version")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("v1.2.1")]),s._v(" "),a("td",[s._v("1.23, 1.22, 1.21, 1.20, 1.19")]),s._v(" "),a("td",[s._v("3.14.6")]),s._v(" "),a("td",[s._v("1.19.10†")])]),s._v(" "),a("tr",[a("td",[s._v("v1.2.0")]),s._v(" "),a("td",[s._v("1.23, 1.22, 1.21, 1.20, 1.19")]),s._v(" "),a("td",[s._v("3.14.6")]),s._v(" "),a("td",[s._v("1.19.10†")])]),s._v(" "),a("tr",[a("td",[s._v("v1.1.3")]),s._v(" "),a("td",[s._v("1.23, 1.22, 1.21, 1.20, 1.19")]),s._v(" "),a("td",[s._v("3.14.4")]),s._v(" "),a("td",[s._v("1.19.10†")])])])]),s._v(" "),a("h3",{attrs:{id:"helm-部署-推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#helm-部署-推荐"}},[s._v("#")]),s._v(" Helm 部署（推荐）")]),s._v(" "),a("p",[s._v("部署文档： https://github.com/bitnami/charts/tree/master/bitnami/nginx-ingress-controller/#installing-the-chart")]),s._v(" "),a("h4",{attrs:{id:"_1-安装helm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装helm"}},[s._v("#")]),s._v(" 1.安装helm")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Linux 直接运行curl 命令安装")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"_2-下载chart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-下载chart"}},[s._v("#")]),s._v(" 2.下载Chart")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#下载Chart")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/bitnami/charts.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" charts/bitnami/nginx-ingress-controller/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_3-配置chart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置chart"}},[s._v("#")]),s._v(" 3.配置chart")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#为安装ingress的node节点添加label")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#高可用模式可以在多个node上打标签，host模式不会调度在同一个机器")]),s._v("\nkubectl label "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\nkubectl label "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-node01 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查询包含指定label（ingress=true）的node节点")]),s._v("\nkubectl get nodes --show-labels "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ingress=true"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##配置Chart")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" values.yaml\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##NGINX 的自定义configmap配置选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##官方文档: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##添加下面三行，获取客户端真实IP")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#config: {}")]),s._v("\nconfig:\n  compute-full-forwarded-for: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n  forwarded-for-header: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X-Forwarded-For"')]),s._v("\n  use-forwarded-headers: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##如果使用hostNetwork=true，设置reportNodeInternalIp=true，会将标志“report-node-internal-ip-address”传递给Nginx 入口控制器")]),s._v("\nreportNodeInternalIp: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##配置控制器所需的 pod 数量")]),s._v("\nreplicaCount: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##添加为host模式，启用主机网络，通过宿主机ip+port访问。")]),s._v("\nhostNetwork: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##选择器，决定将ingress部署在哪些机器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#nodeSelector: {}")]),s._v("\nnodeSelector:\n  ingress: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##禁用基于 NGINX 的默认后端")]),s._v("\ndefaultBackend:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## @param defaultBackend.enabled Enable a default backend based on NGINX")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n  enabled: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##设置为false")]),s._v("\n\nservice:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## @param service.type Kubernetes Service type for Controller")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#type: LoadBalancer")]),s._v("\n  type: NodePort   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 修改服务类型为 NodePort")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("h3",{attrs:{id:"_4-安装chart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装chart"}},[s._v("#")]),s._v(" 4.安装Chart")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加chart仓库")]),s._v("\nhelm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bitnami https://charts.bitnami.com/bitnami\nhelm repo update\nhelm search repo bitnami\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#安装Chart")]),s._v("\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" values.yaml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--timeout")]),s._v(" 20m --create-namespace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" nginx-ingress-controller k8s-nginx bitnami/nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--wait")]),s._v(" --wait-for-jobs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--debug")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"查看发布版本列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看发布版本列表"}},[s._v("#")]),s._v(" 查看发布版本列表")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"升级chart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级chart"}},[s._v("#")]),s._v(" 升级Chart")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##因服务类型为 NodePort，需要--set replicaCount=1 将pod数量改为1，否则端口被占用")]),s._v("\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" values.yaml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--timeout")]),s._v(" 30m "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" nginx-ingress-controller k8s-nginx bitnami/nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--atomic")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--wait")]),s._v(" --wait-for-jobs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--debug")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image.tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1.3.1-debian-11-r0'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingressClassResource.name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx-new"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("replicaCount")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##查看deployment信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ec2-user@eks ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get deploy "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\nNAME                                 READY   UP-TO-DATE   AVAILABLE   AGE\nk8s-nginx-nginx-ingress-controller   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           39h\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##手动对pod进行扩容")]),s._v("\nkubectl scale "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" deployment k8s-nginx-nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"卸载chart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#卸载chart"}},[s._v("#")]),s._v(" 卸载Chart")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm uninstall k8s-nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#helm delete k8s-nginx -n nginx-ingress-controller")]),s._v("\n\nhelm list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"自定义yaml文件部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自定义yaml文件部署"}},[s._v("#")]),s._v(" 自定义yaml文件部署")]),s._v(" "),a("h4",{attrs:{id:"安装ingress-controller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装ingress-controller"}},[s._v("#")]),s._v(" 安装ingress-controller")]),s._v(" "),a("blockquote",[a("p",[s._v("hostNetwork: true 修改为host模式，使用node节点ip访问")])]),s._v(" "),a("h4",{attrs:{id:"_1-下载yaml文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载yaml文件"}},[s._v("#")]),s._v(" 1.下载yaml文件")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" ./ingress-nginx.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.1/deploy/static/provider/cloud/deploy.yaml -O ./ingress-nginx.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[s._v("或者使用myblog/deployment/ingress/mandatory.yaml")])]),s._v(" "),a("h4",{attrs:{id:"_2-修改yaml配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改yaml配置文件"}},[s._v("#")]),s._v(" 2.修改yaml配置文件")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n5")]),s._v(" nodeSelector ingress-nginx.yaml\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("199")]),s._v("-    replicas: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置副本数，host模式不会被调度到同一个node")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("212")]),s._v("-    spec:\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("213")]),s._v("-      hostNetwork: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加为host模式")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("214")]),s._v("-      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wait up to five minutes for the drain of connections")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("215")]),s._v("-      terminationGracePeriodSeconds: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("216")]),s._v("-      serviceAccountName: nginx-ingress-serviceaccount\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("217")]),s._v(":      nodeSelector:\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("218")]),s._v("-        ingress: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#替换此处，来决定将ingress部署在哪些机器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("219")]),s._v("-      containers:\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("220")]),s._v("-        - name: nginx-ingress-controller\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("221")]),s._v("-          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("222")]),s._v("-          args:\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h4",{attrs:{id:"_4-为安装ingress的node节点添加label"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-为安装ingress的node节点添加label"}},[s._v("#")]),s._v(" 4.为安装ingress的node节点添加label")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#为node节点添加label")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#可用模式可以在多个node上打标签，host模式不会调度在同一个机器")]),s._v("\nkubectl label "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\nkubectl label "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-node01 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查询包含指定label（ingress=true）的node节点")]),s._v("\nkubectl get nodes --show-labels "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ingress=true"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_5-创建ingress-controller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-创建ingress-controller"}},[s._v("#")]),s._v(" 5.创建ingress-controller")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" ingress-nginx.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_6-检查运行状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-检查运行状态"}},[s._v("#")]),s._v(" 6.检查运行状态")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ kubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" ingress-nginx\nNAME                                        READY   STATUS    RESTARTS   AGE\nnginx-ingress-controller-55dd6f8d7b-tkx77   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          83d\nnginx-ingress-controller-55dd6f8d7b-vkvqp   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          83d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"aws-中部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws-中部署"}},[s._v("#")]),s._v(" AWS 中部署")]),s._v(" "),a("p",[s._v("官方文档： https://docs.amazonaws.cn/eks/latest/userguide/alb-ingress.html\n在 AWS 中，我们使用网络负载均衡器 (NLB) 在 服务类型 为LoadBalancer 之后暴露 NGINX 入口控制器。")]),s._v(" "),a("ul",[a("li",[s._v("AWS 负载均衡器 (NLB) 中的 TLS 终止")])]),s._v(" "),a("blockquote",[a("p",[s._v("默认情况下，TLS 在入口控制器中终止。但也可以在负载均衡器中终止 TLS。本节介绍如何使用 NLB 在 AWS 上执行此操作。")])]),s._v(" "),a("h4",{attrs:{id:"_1-下载-deploy-yaml模板"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载-deploy-yaml模板"}},[s._v("#")]),s._v(" 1.下载  deploy.yaml模板")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.1/deploy/static/provider/aws/nlb-with-tls-termination/deploy.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_2-编辑文件并更改-kubernetes-集群使用的-vpc-cidr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-编辑文件并更改-kubernetes-集群使用的-vpc-cidr"}},[s._v("#")]),s._v(" 2.编辑文件并更改 Kubernetes 集群使用的 VPC CIDR")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("proxy-real-ip-cidr: XXX.XXX.XXX/XX\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_3-同时更改-aws-certificate-manager-acm-id"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-同时更改-aws-certificate-manager-acm-id"}},[s._v("#")]),s._v(" 3.同时更改 AWS Certificate Manager (ACM) ID")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:us-west-2:XXXXXXXX:certificate/XXXXXX-XXXXXXX-XXXXXXX-XXXXXXXX\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_4-部署清单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-部署清单"}},[s._v("#")]),s._v(" 4.部署清单")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"ingress-controller配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ingress-controller配置"}},[s._v("#")]),s._v(" Ingress controller配置")]),s._v(" "),a("h4",{attrs:{id:"透传client源ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#透传client源ip"}},[s._v("#")]),s._v(" 透传client源IP")]),s._v(" "),a("blockquote",[a("p",[s._v("配置X-Forwarded-For 获取客户端真实IP，实现IP白名单和透传client源IP的功能")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##查看configmap 信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ec2-user@eks ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get configmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\nNAME                                 DATA   AGE\nk8s-nginx-nginx-ingress-controller   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("      19m\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##编辑configmap ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ec2-user@eks ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl edit cm/k8s-nginx-nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("修改内容如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("apiVersion: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\ndata:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#data里，加入以下配置")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将远程地址附加到 X-Forwarded-For 标头而不是替换它。启用此选项后，上游应用程序负责根据自己的受信任代理列表提取客户端 IP。")]),s._v("\n  compute-full-forwarded-for: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置用于标识客户端的原始 IP 地址的标头字段。默认值：X-Forwarded-For")]),s._v("\n  forwarded-for-header: X-Forwarded-For\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果为真，NGINX 会将传入的 X-Forwarded-* 标头传递给上游。当 NGINX 在设置这些标头的另一个代理/负载均衡器之后使用此选项；如果为 false，NGINX 会忽略传入的 X-Forwarded-* 标头，并用它看到的请求信息填充它们。")]),s._v("\n  use-forwarded-headers: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\nkind: ConfigMap\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("验证是否生效：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ec2-user@eks ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" pods/k8-nginx-nginx-ingress-controller-69c99c6c7-hcbd2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller /bin/cat  /etc/nginx/nginx.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b5")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'real_ip_header'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##生效后，在 nginx-ingress-controller 中 nginx.conf 增加了以下配置：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2424")]),s._v(":    real_ip_header      X-Forwarded-For"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2462")]),s._v("-\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2464")]),s._v("-    real_ip_recursive   on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2489")]),s._v("-\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2491")]),s._v("-    set_real_ip_from    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2523")]),s._v("-\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"ingress配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ingress配置"}},[s._v("#")]),s._v(" Ingress配置")]),s._v(" "),a("h4",{attrs:{id:"ingress-yml配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ingress-yml配置"}},[s._v("#")]),s._v(" Ingress yml配置")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ingress-wildcard-host\n  namespace: ops\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/ssl-redirect: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'false'")]),s._v("\nspec:\n  rules:\n  - host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"foo.bar.com"')]),s._v("\n    http:\n      paths:\n      - pathType: Prefix\n        path: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bar"')]),s._v("\n        backend:\n          service:\n            name: service1\n            port:\n              number: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  - host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bar.foo.com"')]),s._v("\n    http:\n      paths:\n      - pathType: Prefix\n        path: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/foo"')]),s._v("\n        backend:\n          service:\n            name: service2\n            port:\n              number: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h4",{attrs:{id:"检查ingress动态生成的nginx配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查ingress动态生成的nginx配置"}},[s._v("#")]),s._v(" 检查ingress动态生成的nginx配置")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" ingress-nginx "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ti")]),s._v(" nginx-ingress-xxxxxxx "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps aux")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/nginx/nginx.conf|grep myblog -A10 -B1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"跨域配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跨域配置"}},[s._v("#")]),s._v(" 跨域配置")]),s._v(" "),a("p",[s._v("跨域配置1：（直接在ingress 的annation里面加）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/Access-Control-Allow-Origin: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'*'")]),s._v("\n    nginx.ingress.kubernetes.io/cors-allow-credentials: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\n    nginx.ingress.kubernetes.io/cors-allow-headers: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("-\n      DNT,web-token,app-token,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-Mx-ReqToken,X-Data-Type,X-Auth-Token,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,token,Cookie\n    nginx.ingress.kubernetes.io/cors-allow-methods: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PUT, GET, POST, OPTIONS'")]),s._v("\n    nginx.ingress.kubernetes.io/cors-allow-origin: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://*.qqq.cn, http://*.qqq.cn, http://localhost:8081'")]),s._v("\n    nginx.ingress.kubernetes.io/enable-cors: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\n    nginx.ingress.kubernetes.io/cors-max-age: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'600'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("跨域配置2：（使用configuration-snippet配置）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("nginx.ingress.kubernetes.io/configuration-snippet: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_method")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'OPTIONS'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Access-Control-Allow-Origin: '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_origin")]),s._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Credentials: true'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Methods: GET, POST, OPTIONS'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Headers: DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Max-Age: 1200'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: text/plain charset=UTF-8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Length: 0'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("204")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Access-Control-Allow-Origin: '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_origin")]),s._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n      more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Credentials'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Methods'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GET, POST, OPTIONS'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      more_set_headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Headers'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h4",{attrs:{id:"白名单限制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#白名单限制"}},[s._v("#")]),s._v(" 白名单限制")]),s._v(" "),a("blockquote",[a("p",[s._v("nginx.ingress.kubernetes.io/whitelist-source-range您可以通过注解指定允许的客户端 IP 源范围。该值是一个逗号分隔的CIDR列表，例如10.0.0.0/24,172.10.0.1")])]),s._v(" "),a("h4",{attrs:{id:"前端没有负载均衡器的情况下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端没有负载均衡器的情况下"}},[s._v("#")]),s._v(" 前端没有负载均衡器的情况下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/whitelist-source-range: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'172.21.0.0/16,10.0.0.0/16'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"前端有负载均衡器的情况下-阿里云-slb-aws-alb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端有负载均衡器的情况下-阿里云-slb-aws-alb"}},[s._v("#")]),s._v(" 前端有负载均衡器的情况下（阿里云 SLB，AWS ALB）")]),s._v(" "),a("blockquote",[a("p",[s._v("Ingress controller配置透传client源IP（需要额外增加下面配置，在data 下添加 use-forwarded-headers）")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: nginx-configuration\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\ndata:\n  use-forwarded-headers: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h4",{attrs:{id:"重定向配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向配置"}},[s._v("#")]),s._v(" 重定向配置")]),s._v(" "),a("p",[s._v("官方地址： https://kubernetes.github.io/ingress-nginx/examples/rewrite/")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://pic.zzppjj.top/LightPicture/2023/05/f4ea18c7847ae60b.png",alt:"f4ea18c7847ae60b.png"}})]),s._v(" "),a("h4",{attrs:{id:"域名跳转"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#域名跳转"}},[s._v("#")]),s._v(" 域名跳转")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/rewrite-target: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://ops-bbb.qsh.cn/$1'")]),s._v("\n  generation: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  name: ops-web\n  namespace: ops\nspec:\n  rules:\n    - host: ops-aaa.qsh.cn\n      http:\n        paths:\n          - backend:\n              service:\n                name: ops-web\n                port:\n                  number: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8000")]),s._v("\n            path: /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            pathType: Prefix\nstatus:\n  loadBalancer: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h4",{attrs:{id:"路径跳转"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路径跳转"}},[s._v("#")]),s._v(" 路径跳转")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n  name: rewrite\n  namespace: default\nspec:\n  ingressClassName: nginx\n  rules:\n  - host: rewrite.bar.com\n    http:\n      paths:\n      - path: /something(/|$)(.*)\n        pathType: Prefix\n        backend:\n          service:\n            name: http-svc\n            port: \n              number: 80\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" kubectl create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" -\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"报错小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#报错小结"}},[s._v("#")]),s._v(" 报错小结")]),s._v(" "),a("h4",{attrs:{id:"posthog-ingress-nginx-controller-admission-not-found"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#posthog-ingress-nginx-controller-admission-not-found"}},[s._v("#")]),s._v(" posthog-ingress-nginx-controller-admission not found")]),s._v(" "),a("blockquote",[a("h2",{attrs:{id:"error-from-server-internalerror-error-when-creating-ingress-nginx-posthog-yaml-internal-error-occurred-failed-calling-webhook-validate-nginx-ingress-kubernetes-io-post-https-posthog-ingress-nginx-controller-admission-posthog-svc-443-networking-v1-ingresses-timeout-10s-service-posthog-ingress-nginx-controller-admission-not-found"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#error-from-server-internalerror-error-when-creating-ingress-nginx-posthog-yaml-internal-error-occurred-failed-calling-webhook-validate-nginx-ingress-kubernetes-io-post-https-posthog-ingress-nginx-controller-admission-posthog-svc-443-networking-v1-ingresses-timeout-10s-service-posthog-ingress-nginx-controller-admission-not-found"}},[s._v("#")]),s._v(" Error from server (InternalError): error when creating “ingress-nginx-posthog.yaml”: Internal error occurred: failed calling webhook “validate.nginx.ingress.kubernetes.io”: Post “ https://posthog-ingress-nginx-controller-admission.posthog.svc:443/networking/v1/ingresses?timeout=10s”: service “posthog-ingress-nginx-controller-admission” not found")])]),s._v(" "),a("h4",{attrs:{id:"原因分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原因分析"}},[s._v("#")]),s._v(" 原因分析：")]),s._v(" "),a("p",[s._v("类似问题： https://stackoverflow.com/questions/61616203/nginx-ingress-controller-failed-calling-webhook/61681896#61681896")]),s._v(" "),a("p",[s._v("我删除了它创建的命名空间和clusterrole and clusterrolebinding as noted in the documentation，但这并没有删除安装在清单中的ValidatingWebhookConfiguration，但在默认情况下使用helm 时不会删除。")]),s._v(" "),a("p",[s._v("解决方法1：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl delete "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" ValidatingWebhookConfiguration ingress-nginx-admission\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("解决方法2：")]),s._v(" "),a("p",[s._v("1、检查是否有validation webhook 和服务。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ops ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get -A ValidatingWebhookConfiguration")]),s._v("\nNAME                              WEBHOOKS   AGE\naws-load-balancer-webhook         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          90d\ncert-manager-webhook              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          91d\nposthog-ingress-nginx-admission   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          5d1h\nvpc-resource-validating-webhook   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          107d\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ops ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n ingress-nginx")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" ingress-nginx namespace.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("2、手动删除posthog-ingress-nginx-admission后恢复正常")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ops ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get ValidatingWebhookConfiguration/posthog-ingress-nginx-admission -o yaml >posthog-ingress-nginx-admission.yaml")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ops ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f posthog-ingress-nginx-admission.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"no-matches-for-kind-role-in-version-rbac-authorization-k8s-io-v1beta1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#no-matches-for-kind-role-in-version-rbac-authorization-k8s-io-v1beta1"}},[s._v("#")]),s._v(" no matches for kind “Role” in version “rbac.authorization.k8s.io/v1beta1”")]),s._v(" "),a("blockquote",[a("p",[s._v("执行异常信息：\nunable to recognize “ingress-nginx.yaml”: no matches for kind “ClusterRole” in version “rbac.authorization.k8s.io/v1beta1”\nunable to recognize “ingress-nginx.yaml”: no matches for kind “Role” in version “rbac.authorization.k8s.io/v1beta1”\nunable to recognize “ingress-nginx.yaml”: no matches for kind “RoleBinding” in version “rbac.authorization.k8s.io/v1beta1”\nunable to recognize “ingress-nginx.yaml”: no matches for kind “ClusterRoleBinding” in version “rbac.authorization.k8s.io/v1beta1”")])]),s._v(" "),a("p",[s._v("原因分析：\n自 v1.22 起，Ingress 的 extensions/v1beta1 和networking.k8s.io/v1beta1 API 版本不再提供。\n官方文档： https://kubernetes.io/docs/reference/using-api/deprecation-guide/#ingress-v122")]),s._v(" "),a("p",[s._v("解决方法：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s#rbac.authorization.k8s.io/v1beta1#rbac.authorization.k8s.io/v1#'")]),s._v(" ingress-nginx.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"unable-to-continue-with-install-ingressclass-nginx-in-namespace-exists-and-cannot-be-imported-into-the-current-release"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#unable-to-continue-with-install-ingressclass-nginx-in-namespace-exists-and-cannot-be-imported-into-the-current-release"}},[s._v("#")]),s._v(" Unable to continue with install: IngressClass “nginx” in namespace “” exists and cannot be imported into the current release")]),s._v(" "),a("blockquote",[a("p",[s._v("Error: INSTALLATION FAILED: rendered manifests contain a resource that already exists. Unable to continue with install: IngressClass “nginx” in namespace “” exists and cannot be imported into the current release: invalid ownership metadata; annotation validation error: missing key “meta.helm.sh/release-name”: must be set to “k8s-nginx”; annotation validation error: missing key “meta.helm.sh/release-namespace”: must be set to “nginx-ingress-controller”\nhelm.go:84: [debug] IngressClass “nginx” in namespace “” exists and cannot be imported into the current release: invalid ownership metadata; annotation validation error: missing key “meta.helm.sh/release-name”: must be set to “k8s-nginx”; annotation validation error: missing key “meta.helm.sh/release-namespace”: must be set to “nginx-ingress-controller”\nrendered manifests contain a resource that already exists. Unable to continue with install")])]),s._v(" "),a("p",[s._v("原因分析：\n使用 helm 创建nginx-ingress-controller时出错")]),s._v(" "),a("p",[s._v("查看helm chart仓库values.yaml文件")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#... ... ...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##查看以下字段 ")]),s._v("\ningressClassResource:\n  name: nginx  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##修改资源名")]),s._v("\n  enabled: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  default: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  controllerClass: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"k8s.io/ingress-nginx"')]),s._v("\n  parameters: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#... ... ...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("解决方法：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##创建")]),s._v("\nhelm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" k8s-nginx bitnami/nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller --create-namespace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingressClassResource.name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx-new"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##升级")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" charts/bitnami/nginx-ingress-controller/\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" values.yaml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--timeout")]),s._v(" 20m --create-namespace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" nginx-ingress-controller k8s-nginx bitnami/nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--wait")]),s._v(" --wait-for-jobs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ingressClassResource.name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx-new"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--debug")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("如果没生效，使用以下命令：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" k8s-nginx bitnami/nginx-ingress-controller "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" nginx-ingress-controller --create-namespace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("controller.ingressClassResource.name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx-new"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("原文链接："),a("a",{attrs:{href:"https://blog.51cto.com/qiangsh/5169428",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubernetes 安装配置ingress controller_奔跑在路上的技术博客_51CTO博客"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=t.exports}}]);